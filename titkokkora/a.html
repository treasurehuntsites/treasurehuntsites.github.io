<!doctype html>
<html lang="hu">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=10.0">
    <title>Titkok kora - Az omladoz√≥ h√°z</title>
    
    <!-- GPS √©s Ikonok -->
    <meta http-equiv="Permissions-Policy" content="geolocation=*">
    <!-- Fontok √©s Ikonok -->
    <link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* --- Zoomol√°s √©s G√∂rget√©s Letilt√°sa (Modal nyit√°skor) */
        html {
            overflow-x: hidden;
            overflow-y: auto; 
        }

        /* Amikor egy modal nyitva van, a f≈ëoldal g√∂rget√©s√©t letiltjuk */
        body.modal-open {
            overflow: hidden;
            height: 100%;
            touch-action: none;
        }


        /* Alapvet≈ë reszet √©s s√∂t√©t h√°tt√©r */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Play', sans-serif;
            color: #e0e0e0; 
            background-color: #1a1a1a; 
            display: flex;
            flex-direction: column;
            align-items: center;
            /* A g√∂rget√©s enged√©lyezve: */
            overflow-y: auto;
            min-height: 100vh;
            touch-action: auto; 
            text-align: center;
            padding-bottom: 60px; 
            
            /* FOUC (sz√∂veg el≈ëzetes megjelen√©se) ellen */
            visibility: hidden; 
            opacity: 0;
            transition: opacity 0.5s ease-in-out; 
        }
        
        /* Teljes sz√©less√©g≈± K√âP (H√°tt√©r) */
        .full-width-image-container {
            width: 100%;
            height: 100vh; 
            overflow: hidden;
            position: absolute; /* Fixed-r≈ël absolute-ra, hogy a body-val egy√ºtt g√∂rgethet≈ë legyen */
            top: 0;
            left: 0;
            z-index: 0; 
            min-height: 100vh;
        }

        .full-width-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover; 
            object-position: center top; 
        }

        /* Tartalom doboz - FIX ALULRA Z√ÅRVA */
        .content-box {
            background-color: rgba(0, 0, 0, 0.85); 
            padding: 40px 20px 10px 20px; 
            margin: 0; 
            border-radius: 10px 10px 0 0; 
            max-width: 800px;
            width: calc(100% - 40px);
            box-shadow: 0 0 25px rgba(138, 43, 226, 0.7);
            border: 3px solid #8a2be2;
            box-sizing: border-box;
            position: fixed; /* Fixen marad alul, mint UI overlay */
            bottom: 50px; 
            left: 50%;
            transform: translateX(-50%); 
            z-index: 10;
            text-align: left;
            min-height: 250px; 
            display: flex; 
            flex-direction: column;
            justify-content: space-between; 
            opacity: 1; 
            transition: opacity 0.5s ease-in-out;
        }

        /* T√∂rt√©net sz√∂vege */
        #story-text-display {
            font-size: 1.2em;
            font-weight: 700;
            line-height: 1.6;
            margin-bottom: 20px;
            white-space: pre-wrap; 
            flex-grow: 1; 
        }
        
        /* Audio gombok... */
        .audio-container {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .audio-button {
            padding: 12px 20px; 
            text-decoration: none;
            color: #1a1a1a;
            background-color: #00FFFF; 
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.4);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .audio-button:hover {
            background-color: #00DDEE;
        }

        /* --- ALS√ì INTERAKCI√ìS S√ÅV (a t√∂rt√©net gombjai) --- */
        .bottom-bar {
            padding-top: 10px;
            border-top: 1px dashed #8a2be2;
            min-height: 48px;
            width: 100%;
        }

        .interaction-container {
            display: flex;
            justify-content: space-between; 
            align-items: center;
            width: 100%;
        }

        .page-button {
            padding: 12px 20px; 
            text-decoration: none;
            color: #ffffff;
            background-color: #8a2be2;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            text-transform: uppercase;
            box-shadow: 0 4px 10px rgba(138, 43, 226, 0.4);
            margin: 5px;
        }
        
        .page-button#next-page-button.full-width {
            width: 100%;
            flex-grow: 1;
            margin-left: 0;
            margin-right: 0;
        }
        
        .page-button:hover:not(:disabled) {
            background-color: #7b1cd1;
            transform: translateY(-1px);
        }

        .page-button:disabled {
            background-color: #555555;
            cursor: not-allowed;
            box-shadow: none;
            opacity: 0.6;
        }
        
        /* T√∂bb gomb kont√©ner - √öJ a k√©t v√°laszt√°shoz */
        .multi-choice-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            padding: 0;
            margin: 0;
        }
        
        /* Diszkr√©t Vissza Gomb - CSAK CHOICE ESETEKBEN */
        .discreet-back-button {
            position: absolute;
            top: 5px;
            left: 10px;
            z-index: 30; 
            background-color: rgba(138, 43, 226, 0.5); 
            color: #ffffff;
            padding: 8px 12px;
            border-radius: 50%; 
            width: 40px;
            height: 40px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: none; 
            transition: background-color 0.2s;
            text-transform: none;
            margin: 0;
            border: none;
        }

        .discreet-back-button:hover:not(:disabled) {
            background-color: rgba(138, 43, 226, 0.8);
            transform: none; 
        }
        .discreet-back-button:disabled {
             background-color: rgba(90, 90, 90, 0.5);
             opacity: 0.5;
             cursor: not-allowed;
        }


        /* Jelsz√≥ kont√©ner */
        #password-container {
            display: none;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            text-align: center;
        }

        #password-container.visible {
            display: flex;
        }
        
        #password-input {
            padding: 12px;
            border: 2px solid #8a2be2;
            border-radius: 5px;
            background-color: #2c2c2c;
            color: #00ffff;
            font-size: 1.2em;
            text-align: center;
            font-family: 'Play', sans-serif;
            margin-bottom: 5px; 
        }

        /* A "Add meg a k√≥dot" sor flexbe igaz√≠tva a k√©rd≈ëjellel */
        #password-container p {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .password-interaction {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        #check-password-button, #back-button-password {
            padding: 12px 20px; 
            font-size: 1.1em; 
        }
        
        #back-button-password {
            color: #ffffff;
            background-color: #8a2be2; 
        }
        
        #check-password-button {
            color: #ffffff;
            background-color: #00ffff;
            box-shadow: 0 4px 10px rgba(0, 255, 255, 0.4); 
            flex-grow: 1; 
        }
        
        #check-password-button:hover {
            background-color: #00ddee;
            transform: translateY(-1px); 
        }

        #message {
            margin-top: 10px;
            font-weight: 700;
            color: #ff4500;
        }

        /* Avatar k√©p */
        .avatar-image {
            position: absolute;
            top: -50px; 
            left: -10px; 
            width: 70px; 
            height: 70px; 
            border-radius: 50%; 
            object-fit: cover; 
            z-index: 20; 
            display: block; 
            box-shadow: 0 0 8px rgba(0, 255, 255, 0.5); 
            transition: opacity 0.3s ease-in-out; 
        }
        
        /* --- FIX ALS√ì MEN√úSOR --- */
        .fixed-menu-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50px;
            background-color: #1a1a1a;
            border-top: 2px solid #8a2be2;
            z-index: 50; 
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -4px 15px rgba(138, 43, 226, 0.5);
        }

        .menu-button {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px 10px;
            transition: color 0.3s;
        }

        .menu-button:hover {
            color: #00ffff;
        }

        /* --- GAL√âRIA MODAL ST√çLUSOK --- */
        #galleryModal {
            display: none; 
            position: fixed;
            z-index: 100; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow-y: scroll; 
            background-color: rgba(0, 0, 0, 0.95);
        }
        
        #gallery-container {
            display: grid;
            grid-template-columns: 1fr 1fr; 
            gap: 10px;
            padding: 15px;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            box-sizing: border-box;
            padding-top: 50px;
        }

        .gallery-thumbnail {
            width: 100%;
            height: 150px; 
            overflow: hidden;
            border: 2px solid #8a2be2;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(138, 43, 226, 0.4);
            transition: transform 0.2s;
            position: relative;
        }

        .gallery-thumbnail:hover {
            transform: scale(1.03);
        }

        .gallery-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover; 
            display: block;
        }
        
        /* Teljes k√©perny≈ës mod√°l kont√©ner a zoomolhat√≥ k√©pnek */
        #full-image-display {
            display: none;
            position: fixed;
            z-index: 101;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.98);
            overflow: hidden; 
        }
        
        .full-image-content {
            width: 100vw; 
            height: 100vh;
            display: flex;
            align-items: center; 
            justify-content: center; 
            overflow: hidden;
        }

        #fullImageDisplay {
            display: block;
            width: auto; 
            height: auto;
            max-width: 100%; 
            max-height: 100%;
            touch-action: auto; /* Panning letiltva, csak a nagy√≠t√°s enged√©lyezett */
            cursor: zoom-in;
            margin: auto;
            /* Zoomhoz hozz√°adott √°tmenet */
            transition: transform 0.3s ease-in-out; 
        }

        .close-gallery {
            position: absolute;
            top: 15px;
            right: 33px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
            z-index: 110;
            text-shadow: 0 0 5px rgba(0, 0, 0, 1);
        }
        
        .close-gallery:hover,
        .close-gallery:focus {
            color: #00ffff;
        }
        
        /* --- S√öG√ì (HELP) MODAL ST√çLUSOK --- */
        #help-modal {
            display: none;
            position: fixed;
            z-index: 200; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(5px);
        }

        .help-content {
            background-color: #1a1a1a;
            margin: 30% auto; 
            padding: 30px;
            border: 3px solid #00ffff;
            border-radius: 10px;
            width: 80%;
            max-width: 400px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
            text-align: center;
        }

        #help-text-display {
            font-size: 1.2em;
            font-weight: 700;
            color: #e0e0e0;
            margin-bottom: 25px;
            min-height: 80px;
        }

        #help-next-button, #help-close-button {
            padding: 10px 25px;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        #help-next-button {
            background-color: #00ffff;
            color: #1a1a1a;
        }

        #help-next-button:hover {
            background-color: #00ddee;
        }
        
        #help-close-button:hover {
            background-color: #777777 !important;
        }

        .help-icon {
            background: none;
            border: none;
            color: #00ffff;
            font-size: 1.5em;
            cursor: pointer;
            transition: color 0.3s;
            line-height: 0; 
        }
        
        /* --- T√ÅVOLS√ÅG MODAL ST√çLUSOK (GPS MODAL) --- */
        #distanceModal {
            display: none; 
            position: fixed;
            z-index: 250; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85); 
            backdrop-filter: blur(2px);
            
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        .distance-content {
            padding: 20px;
            max-width: 90%;
            background-color: rgba(0, 0, 0, 0.85); 
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.8);
            border: 2px solid #00ffff;
        }

        #distance-modal-display {
            font-size: 5em;
            font-weight: bold;
            color: #00ff00; 
            margin: 20px 0;
            padding: 10px;
            border-radius: 8px;
            min-width: 200px;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5); 
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        #distance-status {
            color: #aaaaaa;
            font-size: 1.1em;
            margin-bottom: 25px;
            visibility: hidden; 
            height: 0; 
            margin-top: -20px; 
        }
        
        #distance-status.visible {
            visibility: visible;
            height: auto;
            margin-top: 10px;
        }

        #distance-modal-map-button {
            background-color: transparent;
            border: 2px solid #00ffff; 
            color: #00ffff; 
            padding: 15px 30px;
            font-size: 1.3em;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.7);
            transition: all 0.2s ease-in-out;
            text-transform: uppercase;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        #distance-modal-map-button:hover {
            background-color: rgba(0, 255, 255, 0.2);
            box-shadow: 0 0 20px rgba(0, 255, 255, 1);
        }
    </style>
</head>
<body oncontextmenu="return false;"> 
    <div class="full-width-image-container">
        <!-- H√°tt√©rk√©p -->
        <img id="story-image" src="https://treasurehuntsites.github.io/titkokkora/Img/varoshaza.jpg" alt="Titokzatos jelenet">
    </div>

    <div class="content-box" id="content-box">
        <!-- Avatar k√©p -->
        <img id="avatar-img" class="avatar-image" src="https://treasurehuntsites.github.io/titkokkora/Img/Martin2.png" alt="Szerepl≈ë avatar">
        
        <!-- Diszkr√©t vissza ny√≠l gomb (csak v√°laszt√°sn√°l l√°tszik) -->
        <button id="discreet-back-button" class="discreet-back-button page-button" disabled style="display: none;">
            <i class="fa-solid fa-arrow-left"></i>
        </button>
        
        <p id="story-text-display"></p>
        
        <div id="audio-container-1" class="audio-container" style="display:none;">
             <button id="play-audio-button-1" class="audio-button">‚ñ∂Ô∏è Lej√°tsz√°s (1)</button>
        </div>
        <div id="audio-container-2" class="audio-container" style="display:none;">
             <button id="play-audio-button-2" class="audio-button">‚ñ∂Ô∏è Lej√°tsz√°s (2)</button>
        </div>


        <div class="bottom-bar">
            <!-- Szekvenci√°lis interakci√≥k kont√©nere -->
            <div class="interaction-container" id="interaction-container">
                <button id="prev-page-button" class="page-button" disabled>
                    Vissza
                </button>
                
                <button id="next-page-button" class="page-button">
                    Tov√°bb
                </button>
            </div>
            
            <!-- K√©tv√°laszt√°s kont√©ner -->
            <div class="multi-choice-container" id="multi-choice-container" style="display:none;">
                <button id="choice-1-button" class="page-button" data-next-index="">
                    Odam√©sz a k√∂zeli kapualjhoz
                </button>
                <button id="choice-2-button" class="page-button" data-next-index="">
                    Megvizsg√°lod a k≈ëkorl√°tot
                </button>
                <!-- K√©t √∫j gomb a 4-es v√°laszt√°shoz -->
                <button id="choice-3-button" class="page-button" data-next-index="">
                    Fels√©t√°lsz a K√°lv√°riahegy √∫tra
                </button>
                <button id="choice-4-button" class="page-button" data-next-index="" style="display: none;">
                    4. EXTRA GOMB (A JS kezeli a l√°that√≥s√°g√°t)
                </button>
            </div>


            <div id="password-container">
                <p>
                    Add meg a k√≥dot:
                    <button id="help-button" class="help-icon" title="Seg√≠ts√©g">
                        <i class="fa-solid fa-circle-question"></i>
                    </button>
                </p>
                <input type="text" id="password-input" maxlength="8">
                
                <div class="password-interaction">
                    <button id="back-button-password" class="page-button">
                        Vissza
                    </button>
                    <button id="check-password-button" class="page-button">
                        ELLEN≈êRZ√âS
                    </button>
                </div>
                <!-- √öJ: Szoba link kont√©ner -->
                <div id="room-link-container" style="display: none; margin-top: 10px; width: 100%;">
                    <button id="room-link-button" class="page-button full-width">
                        Szoba
                    </button>
                </div>
                <p id="message"></p>
            </div>
        </div>
    </div>
    
    <div class="fixed-menu-bar">
        <button id="map-button" class="menu-button" title="T√©rk√©p">
            <i class="fa-solid fa-map-location-dot"></i>
        </button>
        
        <button id="image-button" class="menu-button" title="K√©pgal√©ria">
            <i class="fa-solid fa-image"></i>
        </button>
    </div>
    
    <div id="galleryModal">
      <span class="close-gallery" onclick="history.back();">√ó</span>
      <div id="gallery-container">
      </div>
    </div>
    
    <div id="full-image-display">
        <div class="full-image-content">
            <img id="fullImageDisplay" src="" alt="Nagy√≠tott k√©p" />
        </div>
        <span class="close-gallery" style="z-index: 120;" onclick="history.back();">√ó</span>
    </div>
    
    <div id="help-modal">
        <div class="help-content">
            <p id="help-text-display"></p>
            <div style="display: flex; justify-content: space-between; gap: 10px;">
                <button id="help-close-button" class="page-button" style="flex-grow: 1; background-color: #555555; color: #ffffff;">Bez√°r√°s</button>
                <button id="help-next-button" class="page-button" style="flex-grow: 1; background-color: #00ffff; color: #1a1a1a;">Tov√°bb</button>
            </div>
        </div>
    </div>

    <!-- T√°vols√°g Modal (GPS MODAL) -->
    <div id="distanceModal">
        <div class="distance-content">
            <h1>C√âLPONT KERES√âSE</h1>
            
            <div id="distance-modal-display">
                -- M
            </div>
            
            <p id="distance-status">Helyzetmeghat√°roz√°s ind√≠t√°sa...</p>
            
            <!-- T√©rk√©p gomb (GPS modal t√©rk√©p linkje) -->
            <a href="#" target="_blank" id="distance-modal-map-button">
                üó∫Ô∏è T√©rk√©p
            </a>
        </div>
    </div>
    <!-- END T√°vols√°g Modal -->

    
    <audio id="story-audio-1" src="https://raw.githubusercontent.com/treasurehuntsites/treasurehuntsites.github.io/main/media/Ugynokok1.mp3" preload="auto"></audio>
    <audio id="story-audio-2" src="https://raw.githubusercontent.com/treasurehuntsites/treasurehuntsites.github.io/main/media/Ugynokok2.mp3" preload="auto"></audio>

    <script>
        // A szkriptet egy IIFE-be (Immediately Invoked Function Expression) csomagoljuk, 
        // hogy a const deklar√°ci√≥k ne okozzanak hib√°t a glob√°lis hat√≥k√∂rben a szkript esetleges √∫jraindul√°sakor.
        (function() {
            // --- K√âP/T√ñRT√âNET ADATOK ---
            const GITHUB_BASE_URL = "https://treasurehuntsites.github.io/titkokkora/Img/";
            
            // Abszol√∫t URL-ek haszn√°lata a Canvas- √©s a weboldal kompatibilit√°s √©rdek√©ben
            const STABLE_IMAGE_URL = GITHUB_BASE_URL + "varoshaza.jpg"; 
            const CSENGOK_IMAGE_URL = GITHUB_BASE_URL + "csengok.jpg"; 
            const KORLAT_IMAGE_URL = GITHUB_BASE_URL + "Korlat.jpg"; 
            const G_CODE_IMAGE_URL = GITHUB_BASE_URL + "G.jpg"; 
            const MARK_AVATAR_URL = GITHUB_BASE_URL + "Martin2.png"; 
            const TOURIST_AVATAR_URL = GITHUB_BASE_URL + "turista.png";
            const PAINTER_AVATAR_URL = GITHUB_BASE_URL + "festo.png";
            const FRANCOIS_AVATAR_URL = GITHUB_BASE_URL + "Francois.png"; 
            const MARK_PHONE_AVATAR_URL = GITHUB_BASE_URL + "Martintelefonal2.jpg"; 
            const LUCEB_AVATAR_URL = GITHUB_BASE_URL + "Csengo.png"; 
            const UZENOFAL_IMAGE_URL = GITHUB_BASE_URL + "uzenofal.jpg"; 
            const CETLI_REKESZ_IMAGE_IMAGE_URL = GITHUB_BASE_URL + "1764073721912.png"; 
            const CETLI_IMAGE_URL = GITHUB_BASE_URL + "cetli.png"; 
            const EMLEKTABLA_IMAGE_URL = GITHUB_BASE_URL + "emlektablaejjel2.png"; 
            const LEPCZOHAZ_IMAGE_URL = GITHUB_BASE_URL + "lepcsohaz.jpg"; // √öj konstans a l√©pcs≈ëh√°z k√©phez
            const EVA_APARTMAN_IMAGE_URL = GITHUB_BASE_URL + "EvaApartman.jpg"; // √öj konstans a lak√°s k√©phez (tartal√©knak)
            const SZOBARENDETLEN_IMAGE_URL = GITHUB_BASE_URL + "szobarendetlen.png"; // √öJ konstans a rendetlen szoba k√©phez
            const EVALAK_IMAGE_URL = GITHUB_BASE_URL + "evalak.jpg"; // √öJ konstans a lak√°s k√ºls≈ë k√©phez
            const MUCI_IMAGE_URL = GITHUB_BASE_URL + "Muci.png"; // √öJ konstans Muci k√©phez (k√©r√©sre)

            // GAL√âRIA K√âPEK
            const ALL_GALLERY_ITEMS = [
                { id: 'helyszin', url: EVALAK_IMAGE_URL, title: "Helysz√≠n", unlocked: true }, // M√ìDOS√çTVA: STABLE_IMAGE_URL -> EVALAK_IMAGE_URL
                { id: 'uzenofal', url: UZENOFAL_IMAGE_URL, title: "Lak√≥k√∂z√∂ss√©g √ºzen≈ëfala", unlocked: false }, 
                { id: 'korlat', url: KORLAT_IMAGE_URL, title: "K≈ëkorl√°t", unlocked: false }, 
                { id: 'korlat_code', url: G_CODE_IMAGE_URL, title: "G K√≥d", unlocked: false }, 
                { id: 'portre', url: GITHUB_BASE_URL + "portre.png", title: "Fest≈ë Portr√©ja", unlocked: false },
                { id: 'cetli', url: CETLI_IMAGE_URL, title: "Titkos √ºzenet", unlocked: false },
                { id: 'emlektabla', url: EMLEKTABLA_IMAGE_URL, title: "Furcsa fal", unlocked: false }, 
                { id: 'vas_t_kep', url: CETLI_REKESZ_IMAGE_IMAGE_URL, title: "√ºvegcse k√≥d", unlocked: false },
                { id: 'muci', url: MUCI_IMAGE_URL, title: "Muci", unlocked: false }, // √öJ K√âP
                { id: 'szobarendetlen', url: SZOBARENDETLEN_IMAGE_URL, title: "Rendetlen Szoba", unlocked: false } // √öJ K√âP
            ];

            // T√ñRT√âNETR√âSZEK
            const storyPages = [
                // 0. V√ÅLASZT√ÅS PONT 1 (Multi-choice) - Eredeti Index 5
                { 
                    type: 'choice', 
                    content: 'Meg√©rkezt√©l a megadott c√≠mre.', 
                    speaker: 'Narrator', 
                    image: EVALAK_IMAGE_URL, // M√ìDOS√çTVA: STABLE_IMAGE_URL -> EVALAK_IMAGE_URL
                    choices: [
                        { text: 'Odam√©sz a k√∂zeli kapualjhoz', nextIndex: 1 }, 
                        { text: 'Megvizsg√°lod a k≈ëkorl√°tot', nextIndex: 44 }, 
                        { text: 'Fels√©t√°lsz a K√°lv√°riahegy √∫tra', nextIndex: 63 } // M√ìDOS√çTVA: 65 -> 63 a logikus √∫tvonal√©rt √©s k√©pfelold√°s√©rt
                    ]
                },

                // --- KAPUALJ √ÅG - √âVA CSENGET√âS (1-7) - Eredeti 6-12 ---
                { type: 'text', content: 'Megnyomod √âva kapucseng≈ëj√©t.', speaker: 'Mark', image: CSENGOK_IMAGE_URL }, // 1 <--- K√©p v√°ltozik
                { type: 'text', content: 'Senki sem v√°laszol.', speaker: 'Mark', image: CSENGOK_IMAGE_URL }, // 2
                { type: 'text', content: 'Megnyomod m√©gegyszer.', speaker: 'Mark', image: CSENGOK_IMAGE_URL }, // 3
                
                // √öJ L√âP√âSEK (Index 4-7) - Eredeti 9-12
                { type: 'text', content: 'Nincs v√°lasz.', speaker: 'Mark', image: CSENGOK_IMAGE_URL },          // 4
                { type: 'text', content: 'Vajon hol lehet ilyenkor?', speaker: 'Mark', image: CSENGOK_IMAGE_URL }, // 5
                { type: 'text', content: 'Meg k√©ne pr√≥b√°ljak egy m√°sik cseng≈ët, hogy bejussak a h√°zba.', speaker: 'Mark', image: CSENGOK_IMAGE_URL }, // 6
                { type: 'text', content: 'Rem√©lhet≈ëleg valaki hajland√≥ lesz kinyitni a a kaput ezen a k√©s≈ë esti √≥r√°n.', speaker: 'Mark', image: CSENGOK_IMAGE_URL, nextIndex: 8 }, // 7
                
                // --- V√ÅLASZT√ÅS PONT (Index 8): 4 CSENG≈ê - Eredeti 13 ---
                { 
                    type: 'choice', 
                    content: 'A kapualjban a k√∂vetkez√∂ cseng√∂ket l√°tod:', 
                    speaker: 'Narrator', 
                    image: CSENGOK_IMAGE_URL,
                    choices: [
                        { text: 'Becs√∂ngetsz a Luceb/Fesu lak√°sba', nextIndex: 9 }, // Eredeti 14 -> 9
                        { text: 'Becs√∂ngetsz a cimke n√©lk√ºli cseng≈ën', nextIndex: 15 }, // Eredeti 20 -> 15
                        { text: 'Becs√∂ngetsz a Nagy A. cseng≈ën', nextIndex: 21 }, // Eredeti 26 -> 21
                        { text: 'Megnyomod a m√°sik cimke n√©lk√ºli cseng≈ët', nextIndex: 26 } // Eredeti 31 -> 26
                    ]
                },
                
                // --- LUCEB/FESU P√ÅRBESZ√âD (Index 9-14) - Eredeti 14-19 ---
                { type: 'text', content: 'J√≥ est√©t, szeretn√©k bejutni a h√°zba de z√°rva van az ajt√≥. Be tudna esetleg engedni?', speaker: 'Mark', image: CSENGOK_IMAGE_URL }, // 9
                { type: 'text', content: 'Azert van z√°rva, mert k√©s≈ë √©jszaka van √©pp! Ki maga egy√©bk√©nt?', speaker: 'Luceb', image: CSENGOK_IMAGE_URL }, 
                { type: 'text', content: 'Martinnak h√≠vnak √©s √âvahoz j√∂ttem az √∂t√∂dik emeletre...', speaker: 'Mark', image: CSENGOK_IMAGE_URL }, 
                { type: 'text', content: 'Most r√∂gt√∂n beszelnem k√©ne vele. Kinyitn√° az ajt√≥t k√©rem?', speaker: 'Mark', image: CSENGOK_IMAGE_URL }, 
                { type: 'text', content: 'Sajn√°lom, de √≠gy nem tudom kinyitni az ajt√≥t. J√∂jj√∂n vissza amikor itthon van.', speaker: 'Luceb', image: CSENGOK_IMAGE_URL, nextIndex: 8 }, 
                { type: 'text', content: 'Nincs v√°lasz, csak a saj√°t l√©pteid visszhangoznak a csendben.', speaker: 'Mark', image: CSENGOK_IMAGE_URL, nextIndex: 8 }, 
                
                // --- C√çMKE N√âLK√úLI CSENG≈ê P√ÅRBESZ√âD (Index 15-20) - Eredeti 20-25 ---
                { type: 'text', content: 'Igen, tess√©k?', speaker: 'Luceb', image: CSENGOK_IMAGE_URL, backIndex: 8 }, // 15
                { type: 'text', content: 'J√≥ est√©t k√≠v√°nok, azt szeretn√©m megk√©rdezni, hogy kinyitn√° e nekem a kaput esetleg? √âv√°val szeretn√©k besz√©lni az √∂t√∂dikr≈ël.', speaker: 'Mark', image: CSENGOK_IMAGE_URL }, 
                { type: 'text', content: 'Tudja maga egy√°ltal√°n, h√°ny √≥ra van? Az√©rt van z√°r a kapun, hogy az olyanok mint maga ne tudjanak itt bajt keverni.', speaker: 'Luceb', image: CSENGOK_IMAGE_URL }, 
                { type: 'text', content: 'Ha ismeri √âv√°t cs√∂ngessen be hozz√°!', speaker: 'Luceb', image: CSENGOK_IMAGE_URL }, 
                { type: 'text', content: 'De h√°t..', speaker: 'Mark', image: CSENGOK_IMAGE_URL }, 
                { type: 'text', content: '<i>Nem v√°laszol, a fen√©be is.</i>', speaker: 'Mark', image: CSENGOK_IMAGE_URL, nextIndex: 8 }, // 20

                // --- NAGY A. CSENG≈ê P√ÅRBESZ√âD (Index 21-25) - Eredeti 26-30 ---
                { type: 'text', content: 'Ki az?', speaker: 'Luceb', image: CSENGOK_IMAGE_URL, backIndex: 8 }, // 21
                { type: 'text', content: '√ñ√∂.. Pizza fut√°r, a 81-es lak√≥hoz j√∂ttem.', speaker: 'Mark', image: CSENGOK_IMAGE_URL }, 
                { type: 'text', content: '√âjszaka? Engem bolondnak n√©z? F√°radt vagyok es aludni akarok! Ne nyomogassa a cseng≈ët!', speaker: 'Luceb', image: CSENGOK_IMAGE_URL }, 
                { type: 'text', content: 'Am√∫gy pedig nincs a t√∂mbben 81-es lak√°s!', speaker: 'Luceb', image: CSENGOK_IMAGE_URL }, 
                { type: 'text', content: '<i>Na a fut√°ros pr√≥b√°lkoz√°s nem jott be.</i>', speaker: 'Mark', image: CSENGOK_IMAGE_URL, nextIndex: 8 }, // 25

                // --- CIMKE N√âLK√úLI SIKERES P√ÅRBESZ√âD (Index 26-39) - Eredeti 31-44 ---
                { type: 'text', content: 'Mit akar?', speaker: 'Luceb', image: CSENGOK_IMAGE_URL }, // 26
                { type: 'text', content: 'Be kell jutnom a h√°zba, s√ºrg≈ësen beszelnem kell √âv√°val az √∂t√∂dikr≈ël!', speaker: 'Mark', image: CSENGOK_IMAGE_URL },
                { type: 'text', content: '√âv√°val? Mi√©rt nem hozz√° csenget be?', speaker: 'Luceb', image: CSENGOK_IMAGE_URL },
                { type: 'text', content: 'Cs√∂ngettem, de nem v√°laszol.', speaker: 'Mark', image: CSENGOK_IMAGE_URL },
                { type: 'text', content: 'Azt hiszem otthon van pedig.', speaker: 'Mark', image: CSENGOK_IMAGE_URL },
                { type: 'text', content: 'Ma este tal√°lkoznunk kellett volna, de nem j√∂tt el.', speaker: 'Mark', image: CSENGOK_IMAGE_URL },
                { type: 'text', content: 'M√°r pr√≥b√°lkozom egy ideje, itthon kell lennije.', speaker: 'Mark', image: CSENGOK_IMAGE_URL },
                
                // Index 33: K√ìD K√âR√âS√âRE VAL√ì UTAL√ÅS - Eredeti 38
                { type: 'text', content: 'Oh, rem√©lem semmi baja nincs? Ott tal√°lja a bel√©p≈ëk√≥dot egy kis f√©mt√°bl√°n az ajt√≥n.', speaker: 'Luceb', image: CSENGOK_IMAGE_URL, nextIndex: 34 }, // 33
                
                // Index 34: PASSWORD OLDAL (beloberk) - Eredeti 39
                { 
                    type: 'password', 
                    content: 'Mi a bel√©p≈ëk√≥d a kapualjba?', 
                    speaker: 'Narrator', 
                    image: CSENGOK_IMAGE_URL,
                    correctPassword: 'beloberk', 
                    isCaseInsensitive: true,
                    helpMessage: 'A k√≥d egy nyolc bet≈±s sz√≥.', 
                    nextIndexSuccess: 40, // SIKER UT√ÅN JUMP A 40-re (√Åtvezet≈ë sz√∂veg)
                    backIndex: 8 
                },
                
                // Index 35: (Eredeti folytat√°s, most m√°r zs√°kutca) - Eredeti 40
                { type: 'text', content: 'Ha b√°rmi baj van k√©rem cs√∂ngessen be megint rendben?', speaker: 'Luceb', image: CSENGOK_IMAGE_URL }, // 35
                { type: 'text', content: 'Szerintem csak elaludt √©s az√©rt nem hallja a csenget√©st, ne agg√≥djon.', speaker: 'Mark', image: CSENGOK_IMAGE_URL },
                { type: 'text', content: 'Rem√©lj√ºk, hogy csak ennyi, biztosan igaza van!', speaker: 'Luceb', image: CSENGOK_IMAGE_URL },
                { type: 'text', content: 'Rendben, viszl√°t!', speaker: 'Mark', image: CSENGOK_IMAGE_URL },
                { type: 'text', content: 'Viszl√°t!', speaker: 'Luceb', image: CSENGOK_IMAGE_URL, nextIndex: 40 }, // 39
                
                // --- √ÅTVEZET≈ê OLDAL A BEJUT√ÅS UT√ÅN (40-42) - Eredeti 45-47 --- 
                // Index 40: Els≈ë mondat - Eredeti 45
                { type: 'text', content: '<i>Am√∫gy igaza lehet a h√∂lgynek. Van egy rossz el≈ë√©rzetem ezzel kapcsolatban.</i>', speaker: 'Narrator', image: LEPCZOHAZ_IMAGE_URL }, // 40. M√ìDOS√çTVA
                // Index 41: M√°sodik mondat - Eredeti 46
                { type: 'text', content: 'A kapu kattan, √©s lassan kiny√≠lik. Bel√©psz az √°rny√©kos folyos√≥ra.', speaker: 'Narrator', image: LEPCZOHAZ_IMAGE_URL }, // 41. M√ìDOS√çTVA
                
                // 42: Harmadik mondat + ugr√°s a v√°laszt√°sra - Eredeti 47
                { type: 'text', content: 'Bejutott√°l a l√©pcs≈ëh√°zba √©s k√∂r√ºln√©zel.', speaker: 'Narrator', image: LEPCZOHAZ_IMAGE_URL, nextIndex: 43 }, // 42. M√ìDOS√çTVA

                // 43. V√ÅLASZT√ÅS PONT 2: BENT A H√ÅZBAN - Eredeti 48
                { 
                    type: 'choice', 
                    content: 'Mit teszel a l√©pcs≈ëh√°zban?', 
                    speaker: 'Narrator', 
                    image: LEPCZOHAZ_IMAGE_URL, // M√ìDOS√çTVA
                    choices: [
                        { text: 'Megn√©zed a lak√≥k√∂z√∂ss√©g √ºzen≈ëfal√°t', nextIndex: 46 }, // K√≥dk√©r≈ë (214) - Eredeti 51 -> 46
                        { text: 'Elindulsz a l√©pcs≈ën felfel√©', nextIndex: 49 }, // LOCK LOGIKA IDE MUTAT - Eredeti 54 -> 49
                        { text: 'Megvizsg√°lod a j√°r√≥lapot a l√°bad alatt', nextIndex: 58 } // KORRIG√ÅLVA: 59 -> 58
                    ]
                },
                
                // --- K√úLS≈ê KORL√ÅT √ÅG (44-45) - Eredeti 49-50 ---
                // Index 44: K≈êKORL√ÅT ELS≈ê L√âP√âS - Eredeti 49
                { 
                    type: 'text', 
                    content: 'Alaposan megvizsg√°lod a korl√°tot, h√°tha talalsz valamilyen k√≥d r√©szletet.', 
                    speaker: 'Narrator', 
                    image: KORLAT_IMAGE_URL, 
                    nextIndex: 45, 
                    unlockImage: 'korlat',
                    backIndex: 0 // Vissza a k√ºls≈ë f≈ëv√°laszt√°shoz
                }, 
                
                // Index 45: K≈êKORL√ÅT PASSWORD OLDAL - Eredeti 50
                { 
                    type: 'password', 
                    content: 'Mi a k√≥d, amit a k≈ëkorl√°ton tal√°lt√°l?', 
                    speaker: 'Narrator', 
                    image: KORLAT_IMAGE_URL,
                    correctPassword: 'G', 
                    isCaseInsensitive: false,
                    helpMessage: 'Egyetlen nagybet≈±.', 
                    nextIndexSuccess: 59, // KORRIG√ÅLVA: 60 -> 59
                    backIndex: 0 // Visszavezet a k√ºls≈ë f≈ëv√°laszt√°shoz
                },
                
                // --- √úZEN≈êFAL √ÅG (46-47) - Eredeti 51-52 ---
                // Index 46: √úZEN≈êFAL (K√ìD: 214) - Eredeti 51
                { 
                    type: 'password', 
                    content: 'A hirdet√©s lehet, hogy egy k√≥dot rejt?', 
                    speaker: 'Narrator', 
                    image: UZENOFAL_IMAGE_URL,
                    correctPassword: '214', 
                    isCaseInsensitive: false,
                    helpMessage: 'A k√≥d egy h√°romjegy≈± sz√°m.', 
                    nextIndexSuccess: 47, // Eredeti 52 -> 47
                    backIndex: 43,
                    unlockImage: 'uzenofal' // Feloldja az uzenofal k√©pet a gal√©ri√°ban.
                },
                
                // Index 47 (Rejtett rekesz) - Eredeti 52
                { 
                    type: 'text', 
                    // INLINE IMAGE a rekesz illusztr√°ci√≥j√°hoz (abszol√∫t URL-lel)
                    content: `<img src="${CETLI_REKESZ_IMAGE_IMAGE_URL}" style="width: 80%; max-width: 250px; height: auto; margin: 0 auto 15px auto; display: block;">A k√≥d be√ºt√©se ut√°n egy 4 sz√°mjegy≈± k√≥dot tatalmaz√≥ pap√≠rcetli jelenik meg egy titkos rekeszben, amit √©pp most nyitott ki egy rug√≥.`, // FRISS√çTVE
                    speaker: 'Narrator', 
                    image: UZENOFAL_IMAGE_URL, // H√°tt√©rk√©p megmarad: UZENOFAL
                    unlockImage: 'cetli', // CETLI K√âP FELOLD√ÅSA a gal√©ri√°ban
                    nextIndex: 43, // Vissza a v√°laszt√°shoz
                    customAction: 'unlock_stairs' // Feloldja a l√©pcs≈ët
                },

                // --- LOCKED PAGE (48) - Eredeti 53 ---
                { 
                    type: 'text', 
                    content: 'Egyel≈ëre nincs dolgod errefel√©.', 
                    speaker: 'Narrator', 
                    image: LEPCZOHAZ_IMAGE_URL, 
                    nextIndex: 43,
                    backIndex: 43 // Visszavisz a bels≈ë v√°laszt√°shoz (Index 43)
                },

                // --- L√âPCS≈êN FELFEL√â √ÅG (49 - 53) ---
                // Index 49: Fels√©t√°lsz - Eredeti 54
                { type: 'text', content: 'Fels√©t√°lsz √âva apartmanj√°hoz.', speaker: 'Narrator', image: LEPCZOHAZ_IMAGE_URL, nextIndex: 50 }, 
                
                // Index 50: Ajt√≥ nyitva - Eredeti 55
                { type: 'text', content: 'Az ajt√≥t r√©snyire nyitva tal√°lod.', speaker: 'Narrator', image: LEPCZOHAZ_IMAGE_URL, nextIndex: 51 }, 
                
                // Index 51 (√öj sz√∂vegdoboz 1: Bel√©p√©s)
                { type: 'text', content: 'Bel√©psz a lak√°sba.', speaker: 'Narrator', image: SZOBARENDETLEN_IMAGE_URL, nextIndex: 52, backIndex: 50 }, 
                
                // Index 52 (√öj sz√∂vegdoboz 2: Rendetlens√©g)
                { type: 'text', content: 'Mi ez a nagy rendetlens√©g?', speaker: 'Mark', image: SZOBARENDETLEN_IMAGE_URL, nextIndex: 53, backIndex: 51 }, 
                
                // Index 53 (√öj sz√∂vegdoboz 3: Retik√ºl) - JUMP TO 54
                { type: 'text', content: 'Oh, egy retik√ºl.. Itt van benne √âva szem√©lyije.', speaker: 'Mark', image: SZOBARENDETLEN_IMAGE_URL, nextIndex: 54, backIndex: 52 }, 
                
                // --- √öJ LAK√ÅS BELS≈ê V√ÅLASZT√ÅS (54) ---
                { 
                    type: 'choice', 
                    content: 'Mit teszel a lak√°sban?', 
                    speaker: 'Narrator', 
                    image: SZOBARENDETLEN_IMAGE_URL, 
                    choices: [
                        // K√ñR√úLN√âZEL: External URL megnyit√°sa √©s k√©p felold√°sa
                        { text: 'K√∂rben√©zel a szob√°ban', nextIndex: 54, externalUrl: 'https://roomescapemaker.com/u/MoonPhantom/GhostStory' }, 
                        { text: 'Benyitsz a f√ºrd≈ëszob√°ba', nextIndex: 55 }, // √öJ 55
                        { text: 'Megpr√≥b√°lod kinyitni a sz√©fet', nextIndex: 56 } // √öJ 56
                    ]
                },
                
                // 55. Benyitsz a f√ºrd≈ëszob√°ba (Zs√°kutca) <- OLD 56
                { 
                    type: 'text', 
                    content: 'A f√ºrd≈ëszob√°ban egy elpusztult kutya fekszik.', // M√ìDOS√çTOTT SZ√ñVEG
                    speaker: 'Narrator', 
                    image: SZOBARENDETLEN_IMAGE_URL, // M√ìDOS√çTVA
                    nextIndex: 54, 
                    unlockImage: 'muci' // √öJ: Feloldja a Muci.png k√©pet
                    // T√ñR√ñLVE: backIndex: 54 
                }, 
                
                // 56. Sz√©f Password (Vissza√°ll√≠tva a kor√°bbi funkci√≥) <- OLD 57
                { 
                    type: 'password', 
                    content: 'Mi a k√≥dja a bent tal√°lt sz√©fnek?', 
                    speaker: 'Narrator', 
                    image: SZOBARENDETLEN_IMAGE_URL, // M√ìDOS√çTVA
                    correctPassword: '69420', // K√ìD BE√ÅLL√çTVA
                    isCaseInsensitive: false,
                    helpMessage: '√ñt sz√°mjegy≈± k√≥d. N√©zd meg a cetlit!', 
                    nextIndexSuccess: 57, // Siker ugr√°s 57-re
                    // T√ñR√ñLVE: backIndex: 54, // Vissza a v√°laszt√°sra
                    // T√ñR√ñLVE: externalLink: { text: 'Szoba', url: 'https://roomescapemaker.com/u/MoonPhantom/GhostStory' } 
                },
                
                // 57. Sz√©f Password Siker <- OLD 58
                { 
                    type: 'text', 
                    content: 'Sikeresen kinyitottad a sz√©fet! Tal√°lt√°l egy pendrive-ot.', 
                    speaker: 'Narrator', 
                    image: SZOBARENDETLEN_IMAGE_URL, // M√ìDOS√çTVA
                    nextIndex: 54 // Vissza a v√°laszt√°sra
                },

                // 58. J√ÅR√ìLAP √ÅG <- OLD 59
                { 
                    type: 'text', 
                    content: 'A J√°r√≥lapok √∂regek, kopottak, n√©melyik l√∂ty√∂g is. K√ºl√∂n√∂s mint√°t vagy titkot nem rejt a l√°bad alatt l√©v≈ë padl√≥.', 
                    speaker: 'Narrator', 
                    image: LEPCZOHAZ_IMAGE_URL, 
                    nextIndex: 43,
                    backIndex: 43 // Vissza a bels≈ë v√°laszt√°shoz 
                }, 

                // --- K≈êKORL√ÅT SIKER OLDAL (59) <- OLD 60 ---
                { 
                    type: 'text', 
                    content: "Beteszed a tal√°lt bet≈±t a h√°tizs√°kodba.", // M√ìDOS√çTVA
                    speaker: 'Narrator', 
                    image: KORLAT_IMAGE_URL,
                    nextIndex: 0, // Vissza a k√ºls≈ë f≈ëv√°laszt√°shoz
                    unlockImage: 'korlat_code', 
                    backIndex: 0 // Vissza a k√ºls≈ë f≈ëv√°laszt√°shoz
                },
                
                // 60. V√ÅLASZT√ÅS PONT 3 (Multi-choice) <- OLD 61
                { 
                    type: 'choice', 
                    content: 'A Fest≈ë elhallgat. Mit teszel?', 
                    speaker: 'Narrator', 
                    image: STABLE_IMAGE_URL,
                    choices: [
                        { text: 'Megvizsg√°lod a telefonf√ºlk√©t', nextIndex: 72 }, // KORRIG√ÅLVA: 73 -> 72
                        { text: 'K√©rdezel m√©g valamit a fest≈ët≈ël', nextIndex: 61 }, // KORRIG√ÅLVA: 62 -> 61
                        { text: 'Felh√≠vod a Professzort', nextIndex: 69 } // KORRIG√ÅLVA: 70 -> 69
                    ]
                },
                
                // 61. Fest≈ë √°g (tov√°bbi k√©rd√©s) <- OLD 62
                { type: 'text', content: 'Megk√©rdezel m√©g valamit a fest≈ët≈ël.', speaker: 'Painter', image: STABLE_IMAGE_URL, nextIndex: 60 }, // KORRIG√ÅLVA: 61 -> 60
                
                // 62. CETLI MEGJELEN√çT≈ê OLDAL <- OLD 63
                { 
                    type: 'note_image', 
                    content: 'Tal√°lt√°l egy titkos √ºzenetet!', 
                    speaker: 'Narrator', 
                    image: CETLI_IMAGE_URL ,
                    nextButtonText: 'Bez√°r√°s', 
                },

                // --- √öJ K√ÅLV√ÅRIAHEGY √ÅG (Index 63-67) ---
                
                // 63. K√°lv√°riahegy 1. mondat <- OLD 64
                // K√âP FELOLD√ÅS BE√ÅLL√çTVA IDE A K√ÅLV√ÅRIAHEGY √öTVONAL IND√çT√ÅS√ÅHOZ
                { type: 'text', content: 'Nem tudod, mit is k√©ne most igaz√°b√≥l csin√°lnod, ez√©rt megindulsz felfel√© a kis utc√°n.', speaker: 'Narrator', image: EMLEKTABLA_IMAGE_URL, nextIndex: 64, backIndex: 0, unlockImage: 'emlektabla' }, 
                
                // 64. K√°lv√°riahegy 2. mondat <- OLD 65
                { type: 'text', content: 'A felh≈ës √©gbolton kereszt√ºl s√ºt le r√°d a Hold, √©s k√≠s√©rtetiess√© var√°zsolja az √©p√ºleteket.', speaker: 'Narrator', image: EMLEKTABLA_IMAGE_URL, nextIndex: 65, backIndex: 63 }, 
                
                // 65. K√°lv√°riahegy 3. mondat <- OLD 66
                { type: 'text', content: 'Egyszer csak valami k√ºl√∂n√∂set veszel √©szre az √∫tmenti h√°z fal√°n.', speaker: 'Narrator', image: EMLEKTABLA_IMAGE_URL, nextIndex: 66, backIndex: 64 }, 
                
                // 66. K√°lv√°riahegy Password Oldal <- OLD 67
                { 
                    type: 'password', 
                    content: 'Mi a k√≥d, amit a h√°z fal√°n tal√°lt√°l?', 
                    speaker: 'Narrator', 
                    image: EMLEKTABLA_IMAGE_URL, 
                    correctPassword: '1342', // K√ìD M√ìDOS√çTVA: 1238 -> 1342
                    isCaseInsensitive: false,
                    helpMessage: 'A rozsd√°s vas T m√∂g√∂tt.', 
                    nextIndexSuccess: 67, // KORRIG√ÅLVA: 68 -> 67
                    backIndex: 65 // KORRIG√ÅLVA: 66 -> 65
                }, 

                // 67. K√°lv√°riahegy Sikeroldal <- OLD 68
                { 
                    type: 'text', 
                    content: 'Egy kis √ºvegcs√©t tal√°lt√°l. Beteszed a h√°tizs√°kodba.', // M√ìDOS√çTVA: Elt√°vol√≠tva a gal√©ri√°ra utal√≥ sz√∂veg
                    speaker: 'Narrator', 
                    image: EMLEKTABLA_IMAGE_URL, // FRISS√çTVE: H√°tt√©rk√©p
                    nextButtonText: 'Tov√°bb', 
                    unlockImage: 'vas_t_kep', 
                    nextIndex: 0, 
                    backIndex: 66 // KORRIG√ÅLVA: 67 -> 66
                }, 

                // --- GPS √âS ZS√ÅKUTC√ÅK (Index 68-72) ---

                // 68. Narrator (WAS 69): Utols√≥ oldal - Ind√≠tja a GPS-t <- OLD 69
                { 
                    type: 'text', 
                    content: 'Megtal√°ltad a titkos t√©rk√©p koordin√°t√°j√°t. Ind√≠tsd el a GPS-t.',
                    speaker: 'Narrator', 
                    image: STABLE_IMAGE_URL,
                    nextButtonText: 'tov√°bb', 
                    customAction: 'open_distance_modal',
                    backIndex: 60 // KORRIG√ÅLVA: 61 -> 60
                }, 

                // 69. Harmadik v√°laszt√°s zs√°kutca (WAS 70): Professzor h√≠v√°s <- OLD 70
                { type: 'text', content: 'A professzor nem veszi fel, val√≥sz√≠n≈±leg alszik.', speaker: 'MarkPhone', image: STABLE_IMAGE_URL, nextIndex: 60 }, // KORRIG√ÅLVA: 61 -> 60

                // 70. Els≈ë v√°laszt√°s zs√°kutca (WAS 71): K√∂rbem√©sz, sz√©tn√©zel <- OLD 71
                { type: 'text', content: 'K√∂rbes√©t√°ltad a ter√ºletet, de semmi √©rdekeset nem tal√°lt√°l.', speaker: 'Narrator', image: STABLE_IMAGE_URL, nextIndex: 0 }, 

                // 71. Kapualj Zs√°kutca (WAS 72) <- OLD 72
                { type: 'text', content: 'A kapualj fel√© indulsz, de nem tudsz bejutni a k√≥d n√©lk√ºl.', speaker: 'Narrator', image: STABLE_IMAGE_URL, nextIndex: 0 }, // Zs√°kutca vissza a f≈ëv√°laszt√°shoz

                // 72. (R√©gi 73) Jelsz√≥beviteli k√©perny≈ë <- OLD 73
                { 
                    type: 'password',
                    content: 'N√©zz k√∂r√ºl az igazi f√ºlk√©ben! (Telep√≠tsd a helymeghat√°roz√°st, ha nem m≈±k√∂dik)',
                    speaker: 'Narrator',
                    image: STABLE_IMAGE_URL,
                    correctPassword: '8127',
                    isCaseInsensitive: false,
                    helpMessage: 'A k√©sz√ºl√©k alj√°n keresg√©lj!',
                    nextIndexSuccess: 62, // KORRIG√ÅLVA: 63 -> 62
                    backIndex: 60 // KORRIG√ÅLVA: 61 -> 60
                } 
            ];

            const CORRECT_PASSWORD = "8127"; // Ezt m√°r csak tartal√©k/referencia
            const MENU_MAP_URL = 'https://www.google.com/maps/d/u/0/viewer?mid=1In35RskVV8t66hBDuaoq9VP5_myLeDE&ll=47.42537930000002%2C19.037390200000004&z=17'; // Men√º t√©rk√©p
            
            // SEG√çTS√âG ADATOK
            const HELP_MESSAGES = [
                "A k√©sz√ºl√©k alj√°n keresg√©lj!",
                "A k√≥d: 8127" 
            ];
            
            // GPS ADATOK
            const COMPASS_LAT = 47.426785; 
            const COMPASS_LON = 19.037315; 
            const COMPASS_RADIUS = 25; 
            const SUCCESS_LINK = "next.html"; 
            const GPS_MODAL_MAP_URL = 'https://www.google.com/maps/d/u/0/viewer?mid=1In35RskVV8t66hBDuaoq9VP5_myLeDE&ll=47.42537930000002%2C19.037390200000004&z=17'; 
            // ------------------------------------

            
            let currentPartIndex = 0;
            let currentHelpIndex = 0;
            let watchId = null; 
            
            // --- K√âP NAGY√çT√ÅS/KICINY√çT√âS √ÅLLAPOT ---
            let currentScale = 1.0; 
            const MAX_SCALE = 2.5; 
            const MIN_SCALE = 1.0; 
            
            // DOM elemek
            const contentBox = document.getElementById('content-box');
            const storyDisplay = document.getElementById('story-text-display');
            const nextButton = document.getElementById('next-page-button');
            const prevButton = document.getElementById('prev-page-button'); 
            const interactionContainer = document.getElementById('interaction-container'); 
            const multiChoiceContainer = document.getElementById('multi-choice-container'); 
            const choice1Button = document.getElementById('choice-1-button'); 
            const choice2Button = document.getElementById('choice-2-button'); 
            const choice3Button = document.getElementById('choice-3-button'); 
            const choice4Button = document.getElementById('choice-4-button'); 
            const discreetBackButton = document.getElementById('discreet-back-button'); 
            const passwordContainer = document.getElementById('password-container'); 
            const backButtonPassword = document.getElementById('back-button-password'); 
            const passwordInput = document.getElementById('password-input');
            const checkButton = document.getElementById('check-password-button');
            const messageDisplay = document.getElementById('message');
            const storyImage = document.getElementById('story-image'); 
            const avatarImg = document.getElementById('avatar-img');
            const imageButton = document.getElementById('image-button');
            const mapButton = document.getElementById('map-button'); 
            const storyAudio1 = document.getElementById('story-audio-1');
            const playAudioButton1 = document.getElementById('play-audio-button-1');
            const audioContainer1 = document.getElementById('audio-container-1');
            const storyAudio2 = document.getElementById('story-audio-2');
            const playAudioButton2 = document.getElementById('play-audio-button-2');
            const audioContainer2 = document.getElementById('audio-container-2'); 
            const galleryModal = document.getElementById('galleryModal');
            const galleryContainer = document.getElementById('gallery-container');
            const fullImageDisplayModal = document.getElementById('full-image-display');
            const fullImageDisplay = document.getElementById('fullImageDisplay');
            const helpButton = document.getElementById('help-button');
            const helpModal = document.getElementById('help-modal');
            const helpTextDisplay = document.getElementById('help-text-display');
            const helpNextButton = document.getElementById('help-next-button');
            const helpCloseButton = document.getElementById('help-close-button'); 
            const distanceModal = document.getElementById('distanceModal');
            const distanceDisplay = document.getElementById('distance-modal-display');
            const distanceStatus = document.getElementById('distance-status');
            const roomLinkButton = document.getElementById('room-link-button'); // √öJ GOMB
            const roomLinkContainer = document.getElementById('room-link-container'); // √öJ KONT√âNER

            // --- Seg√©d F√úGGV√âNYEK ---

            function saveProgress() {
                localStorage.setItem('gameProgress', currentPartIndex);
            }

            function loadProgress() {
                const savedIndex = localStorage.getItem('gameProgress');
                if (savedIndex !== null) {
                    // Csak a m√°r befejezett oldalakig engedj√ºk az indexet
                    currentPartIndex = Math.min(parseInt(savedIndex), storyPages.length); 
                } else {
                    currentPartIndex = 0;
                }
            }
            
            function stopAllAudio() {
                // Meg√°ll√≠tja √©s visszatekeri az √∂sszes audi√≥t
                storyAudio1.pause();
                storyAudio1.currentTime = 0;
                playAudioButton1.innerHTML = "‚ñ∂Ô∏è Lej√°tsz√°s (1)";
                storyAudio2.pause();
                storyAudio2.currentTime = 0;
                playAudioButton2.innerHTML = "‚ñ∂Ô∏è Lej√°tsz√°s (2)";
            }

            function toggleAudio(audioElement, buttonElement, buttonText) {
                if (audioElement.paused) {
                    stopAllAudio(); 
                    audioElement.play().catch(error => {
                        console.error('Autoplay failed, user interaction needed.', error);
                    });
                    buttonElement.innerHTML = `‚è∏Ô∏è Sz√ºnet (${buttonText})`;
                } else {
                    audioElement.pause();
                    buttonElement.innerHTML = `‚ñ∂Ô∏è Lej√°tsz√°s (${buttonText})`;
                }
            }

            // GAL√âRIA FUNKCI√ìK
            function populateGallery() {
                galleryContainer.innerHTML = ''; 
                
                // Ellen≈ërzi, hogy fel van-e oldva a portr√©
                const isPortraitUnlocked = localStorage.getItem('isPortraitUnlocked') === 'true';
                // Ellen≈ërzi, hogy fel van-e oldva a cetli
                const isNoteUnlocked = localStorage.getItem('isNoteUnlocked') === 'true'; 
                // Ellen≈ërzi, hogy fel van-e oldva az √ºzen≈ëfal
                const isUzenofalUnlocked = localStorage.getItem('isUzenofalUnlocked') === 'true'; 
                // Ellen≈ërzi, hogy fel van-e oldva a korl√°t
                const isKorlatUnlocked = localStorage.getItem('isKorlatUnlocked') === 'true'; 
                // Ellen≈ërzi, hogy fel van-e oldva a G k√≥d k√©p
                const isKorlatCodeUnlocked = localStorage.getItem('isKorlatCodeUnlocked') === 'true'; 
                // √öJ: A vas T k√©p ellen≈ërz√©se
                const isVasTKepUnlocked = localStorage.getItem('isVas_t_kepUnlocked') === 'true';
                // √öJ: Az eml√©kt√°bla k√©p ellen≈ërz√©se
                const isEmlektablaUnlocked = localStorage.getItem('isEmlektablaUnlocked') === 'true';
                // √öJ: Muci k√©p ellen≈ërz√©se
                const isMuciUnlocked = localStorage.getItem('isMuciUnlocked') === 'true'; 
                // √öJ: Szobarendetlen k√©p ellen≈ërz√©se
                const isSzobarendetlenUnlocked = localStorage.getItem('isSzobarendetlenUnlocked') === 'true'; 

                
                // Filterezz√ºk a gal√©ria elemeket az alapj√°n, hogy fel vannak-e oldva
                const visibleItems = ALL_GALLERY_ITEMS.filter(item => 
                    item.unlocked || 
                    (item.id === 'portre' && isPortraitUnlocked) || 
                    (item.id === 'cetli' && isNoteUnlocked) ||
                    (item.id === 'uzenofal' && isUzenofalUnlocked) ||
                    (item.id === 'korlat' && isKorlatUnlocked && !isKorlatCodeUnlocked) || // K≈ëkorl√°t csak akkor l√°tszik, ha a G k√≥d m√©g nincs feloldva
                    (item.id === 'korlat_code' && isKorlatCodeUnlocked) || // G K√≥d
                    (item.id === 'vas_t_kep' && isVasTKepUnlocked) || // Vas T k√©p
                    (item.id === 'emlektabla' && isEmlektablaUnlocked) || // √öJ: Eml√©kt√°bla √©jjel
                    (item.id === 'muci' && isMuciUnlocked) || // √öJ: Muci k√©p
                    (item.id === 'szobarendetlen' && isSzobarendetlenUnlocked) // √öJ: Szobarendetlen k√©p
                );

                visibleItems.forEach((image) => {
                    const thumbnailDiv = document.createElement('div');
                    thumbnailDiv.className = 'gallery-thumbnail';
                    const img = document.createElement('img');
                    img.src = image.url;
                    img.alt = image.title;
                    thumbnailDiv.onclick = () => openFullImage(image.url);
                    thumbnailDiv.appendChild(img);
                    
                    const title = document.createElement('div');
                    title.style.cssText = `
                        position: absolute; bottom: 0; left: 0; right: 0; 
                        background-color: rgba(0, 0, 0, 0.7); 
                        color: white; font-size: 0.9em; padding: 5px; 
                        text-align: center;
                    `;
                    title.textContent = image.title;
                    thumbnailDiv.appendChild(title);
                    galleryContainer.appendChild(thumbnailDiv);
                });
            }
            
            function setScaleTransform() {
                fullImageDisplay.style.transform = `scale(${currentScale})`;
                fullImageDisplay.style.cursor = currentScale > MIN_SCALE ? 'zoom-out' : 'zoom-in';
            }

            function toggleZoom() {
                if (currentScale > MIN_SCALE) {
                    currentScale = MIN_SCALE; // Zoom Out
                } else {
                    currentScale = MAX_SCALE; // Zoom In
                }
                setScaleTransform();
            }

            function openFullImage(imageUrl) {
                fullImageDisplay.src = imageUrl;
                
                // RESET ZOOM
                currentScale = MIN_SCALE; 
                setScaleTransform(); 
                
                fullImageDisplayModal.style.display = 'flex'; // Flexre √°ll√≠tva a cent√≠roz√°s miatt
                galleryModal.style.display = 'none'; 
                history.pushState(null, null, '#full-image');
            }
            
            function closeFullImage() {
                fullImageDisplayModal.style.display = 'none';
            }

            function openGallery() {
                populateGallery(); 
                galleryModal.style.display = "block";
                history.pushState(null, null, '#gallery');
            }

            function closeGallery() {
                galleryModal.style.display = "none";
                fullImageDisplayModal.style.display = 'none'; 
            }

            // --- DRAG/PAN LOGIC (ELT√ÅVOL√çTVA √âS HELYETTES√çTVE ZOOMMAL) ---
            // Dupla kattint√°s/koppint√°s a nagy√≠t√°shoz
            let lastTap = 0;
            fullImageDisplay.addEventListener('click', (e) => {
                const now = new Date().getTime();
                const timesince = now - lastTap;
                
                if (timesince < 300 && timesince > 0) {
                    e.preventDefault(); // Megakad√°lyozza a dupla kattint√°s alap√©rtelmezett viselked√©s√©t
                    toggleZoom();
                } 
                lastTap = now;
            });
            
            // Dupla kattint√°s az eg√©rrel (Desktop)
            fullImageDisplay.addEventListener('dblclick', (e) => {
                e.preventDefault();
                toggleZoom();
            });
            
            // S√öG√ì FUNKCI√ìK
            function closeHelpModal() {
                helpModal.style.display = 'none';
            }

            function showHelpMessage() {
                // A HELP_MESSAGES tartalm√°t a jelenlegi password oldalon l√©v≈ë adatokb√≥l √°ll√≠tjuk be.
                const currentPage = storyPages[currentPartIndex];
                if (currentPage.type !== 'password' || !currentPage.helpMessage) return;

                // Dinamikusan √°ll√≠tja be a s√∫g√≥√ºzeneteket a currentPage.helpMessage alapj√°n
                const currentHelpMessages = [currentPage.helpMessage];
                // Ha van egyedi tartalom a s√∫g√≥ban, itt jelenik meg
                
                if (currentHelpIndex < currentHelpMessages.length) {
                    helpTextDisplay.textContent = currentHelpMessages[currentHelpIndex];
                    helpModal.style.display = 'block';
                    
                    if (currentHelpIndex === currentHelpMessages.length - 1) {
                        helpNextButton.textContent = '√ârtem';
                    } else {
                        helpNextButton.textContent = 'Tov√°bb';
                    }
                    
                } else {
                    closeHelpModal();
                    currentHelpIndex = currentHelpMessages.length - 1; 
                }
            }

            function nextHelpStep() {
                // Mivel csak egy s√∫g√≥√ºzenet van most minden oldalon, csak be kell z√°rni.
                closeHelpModal();
            }
            
            // GPS/T√ÅVOLS√ÅG FUNKCI√ìK
            
            function tavolsagotKiszamol(lat1, lon1, lat2, lon2) {
                const R = 6371e3; // F√∂ld sugara m√©terben
                const phi1 = lat1 * Math.PI / 180;
                const phi2 = lat2 * Math.PI / 180;
                const deltaPhi = (lat2 - lat1) * Math.PI / 180;
                const deltaLambda = (lon2 - lon1) * Math.PI / 180;

                const a = Math.sin(deltaPhi / 2) * Math.sin(deltaPhi / 2) +
                        Math.cos(phi1) * Math.cos(phi2) *
                        Math.sin(deltaLambda / 2) * Math.sin(deltaLambda / 2);
                
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                
                return R * c; // T√°vols√°g m√©terben
            }
            
            function restartCompassTracking() {
                console.log("GPS Hiba t√∂rt√©nt, √∫jrapr√≥b√°lkoz√°s 2 m√°sodperc m√∫lva...");
                setTimeout(startCompassTracking, 2000);
            }
            
            function setDistanceStatus(message, isError = false) {
                distanceStatus.textContent = message;
                if (isError || message.includes("Hiba") || message.includes("v√°rjon")) {
                    distanceStatus.classList.add('visible');
                    // Helyzetmeghat√°roz√°s √°llapot√°nak vizu√°lis jelz√©se
                    distanceDisplay.style.color = isError ? '#ff4500' : '#ffff00';
                    distanceDisplay.style.boxShadow = `0 0 15px rgba(${isError ? '255, 69, 0, 0.5' : '255, 255, 0, 0.5'})`;
                } else {
                    distanceStatus.classList.remove('visible');
                    distanceDisplay.style.color = '#00ff00';
                    distanceDisplay.style.boxShadow = `0 0 15px rgba(0, 255, 0, 0.5)`;
                }
            }

            function startCompassTracking() {
                if (!("geolocation" in navigator)) {
                    setDistanceStatus("Hiba: A b√∂ng√©sz≈ëje nem t√°mogatja a helymeghat√°roz√°st.", true);
                    return;
                }
                
                if (watchId) {
                    navigator.geolocation.clearWatch(watchId);
                    watchId = null;
                }
                
                setDistanceStatus("Helymeghat√°roz√°s ind√≠t√°sa, k√©rj√ºk v√°rjon...", true);
                distanceDisplay.textContent = "-- M"; 

                watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        const latDeg = position.coords.latitude;
                        const lonDeg = position.coords.longitude;
                        
                        console.log(`GPS OK: Lat=${latDeg}, Lon=${lonDeg}, Accuracy=${position.coords.accuracy}`);

                        const tavolsag = tavolsagotKiszamol(latDeg, lonDeg, COMPASS_LAT, COMPASS_LON);
                        
                        distanceDisplay.textContent = `${tavolsag.toFixed(0)} M`; 
                        setDistanceStatus(`Pontoss√°g: ¬±${position.coords.accuracy.toFixed(0)} m. Jelenlegi t√°vols√°g:`, false);

                        if (tavolsag <= COMPASS_RADIUS) {
                            setDistanceStatus("C√©l el√©rve! √Åtir√°ny√≠t√°s 5 m√°sodperc m√∫lva...", true);
                            navigator.geolocation.clearWatch(watchId);
                            watchId = null;
                            setTimeout(() => {
                                window.location.href = SUCCESS_LINK; // √Åtir√°ny√≠t√°s a next.html-re
                            }, 5000);
                            return;
                        }
                    },
                    
                    (error) => {
                        console.error("GPS Error Code:", error.code, "Message:", error.message);
                        
                        if (watchId) {
                            navigator.geolocation.clearWatch(watchId);
                            watchId = null;
                        }
                        
                        if (error.code === error.PERMISSION_DENIED) {
                            setDistanceStatus("Hiba: K√©rj√ºk, enged√©lyezze a helymeghat√°roz√°st (enged√©ly letiltva).", true);
                            distanceDisplay.textContent = "X";
                        } else if (error.code === error.POSITION_UNAVAILABLE) {
                                setDistanceStatus("Hiba: A helyzetadatok nem √©rhet≈ëk el (rossz GPS v√©tel). √öjrapr√≥b√°lkoz√°s...", true);
                                distanceDisplay.textContent = "X";
                                restartCompassTracking(); 
                        } else if (error.code === error.TIMEOUT) {
                                setDistanceStatus("Hiba: T√∫l sok√°ig tartott a helyzet meghat√°roz√°sa. √öjrapr√≥b√°lkoz√°s...", true);
                                distanceDisplay.textContent = "X";
                                restartCompassTracking(); 
                        } else {
                            setDistanceStatus("Hiba a helymeghat√°roz√°sban.", true);
                            distanceDisplay.textContent = "X";
                        }
                    },
                    
                    {
                        enableHighAccuracy: true,
                        timeout: 15000, 
                        maximumAge: 0 
                    }
                );
            }

            function showDistanceModal() {
                // Elrejti a f≈ë tartalomdobozt (t√∂rt√©net)
                contentBox.style.display = 'none'; 
                
                document.body.classList.add('modal-open');
                distanceModal.style.display = 'flex'; 
                
                // Be√°ll√≠tja a GPS modal t√©rk√©p gomb linkj√©t
                document.getElementById('distance-modal-map-button').href = GPS_MODAL_MAP_URL;
                
                // Elind√≠tja a GPS k√∂vet√©st
                startCompassTracking(); 
            }
            
            // T√ñRT√âNET/INTERAKCI√ì FUNKCI√ìK

            function updateButtons() {
                stopAllAudio(); 
                multiChoiceContainer.style.display = 'none'; 
                passwordContainer.classList.remove('visible');
                discreetBackButton.style.display = 'none'; 
                roomLinkContainer.style.display = 'none'; // Rejtj√ºk az √∫j gombot alapb√≥l
                
                // Vissza√°ll√≠tjuk a gombokat az alap√©rtelmezett √°llapotukra (szekvenci√°lis n√©zet)
                nextButton.classList.remove('full-width'); 
                interactionContainer.style.justifyContent = 'space-between';
                prevButton.style.display = 'block'; 
                prevButton.disabled = currentPartIndex === 0;

                if (currentPartIndex < storyPages.length) {
                    const currentPage = storyPages[currentPartIndex];
                    
                    const isChoicePage = currentPage.type === 'choice';
                    const isPasswordPage = currentPage.type === 'password';
                    
                    if (isChoicePage) {
                        // 1. CHOICE PAGE LOGIC
                        interactionContainer.style.display = 'none';
                        multiChoiceContainer.style.display = 'flex';
                        
                        const choices = currentPage.choices || []; // Biztons√°gi ellen≈ërz√©s
                        
                        // Gombok konfigur√°l√°sa (max 4)
                        const choiceButtons = [choice1Button, choice2Button, choice3Button, choice4Button]; 
                        
                        choiceButtons.forEach((button, index) => {
                            if (choices[index]) {
                                button.style.display = 'block';
                                button.textContent = choices[index].text;
                                button.dataset.nextIndex = choices[index].nextIndex;
                                
                                // √öJ: K√ºls≈ë URL be√°ll√≠t√°sa a gomb adat√°ban
                                if (choices[index].externalUrl) {
                                    button.dataset.externalUrl = choices[index].externalUrl;
                                } else {
                                    delete button.dataset.externalUrl;
                                }
                            } else {
                                button.style.display = 'none'; // Elrejti, ha kevesebb van
                            }
                        });

                        // Diszkr√©t gomb megjelen√≠t√©se (CSAK ITT)
                        discreetBackButton.style.display = 'flex';
                        // A diszkr√©t gomb csak akkor disabled, ha ez az els≈ë oldal (0)
                        discreetBackButton.disabled = currentPartIndex === 0; 

                    } else if (isPasswordPage) {
                        // 2. PASSWORD PAGE LOGIC
                        interactionContainer.style.display = 'none';
                        multiChoiceContainer.style.display = 'none';
                        passwordContainer.classList.add('visible');
                        discreetBackButton.style.display = 'none';
                        
                        // √Åll√≠tsuk be a vissza gombot
                        backButtonPassword.style.display = currentPage.backIndex !== undefined ? 'block' : 'none';
                        
                        // √Åll√≠tsuk be a s√∫g√≥ gombot
                        helpButton.style.display = currentPage.helpMessage ? 'block' : 'none';
                        
                        // √öJ: K√ºls≈ë link gomb kezel√©se
                        if (currentPage.externalLink) {
                            roomLinkContainer.style.display = 'block';
                            roomLinkButton.textContent = currentPage.externalLink.text;
                            roomLinkButton.dataset.url = currentPage.externalLink.url;
                        } else {
                            roomLinkContainer.style.display = 'none';
                        }
                        
                        // √Åll√≠tsuk be a bemenet param√©tereit (max hossz, type)
                        passwordInput.type = currentPage.isCaseInsensitive ? 'text' : 'password';
                        // A max hossz be√°ll√≠t√°s√°t elhagyjuk, helyette a CSS/HTML alapelemeket haszn√°ljuk.
                        
                    } else {
                        // 3. SEQUENTIAL PAGE / NOTE PAGE LOGIC
                        interactionContainer.style.display = 'flex';
                        
                        const customText = currentPage.nextButtonText;
                        const nextIndexDefined = currentPage.nextIndex !== undefined;
                        
                        if (customText) {
                            nextButton.textContent = customText;
                        } else {
                            // M√ìDOS√çT√ÅS: A Folytat√°s helyett Tov√°bb (minden szekvenci√°lis oldalon)
                            nextButton.textContent = 'Tov√°bb';
                        }
                        
                        nextButton.dataset.forcedNextIndex = nextIndexDefined ? currentPage.nextIndex : '';
                        
                        // Kieg√©sz√≠t≈ë felt√©tel: Bels≈ë zs√°kutca oldalak (55, 57) vagy GPS oldal (68) eset√©n a Vissza gomb elrejt√©se
                        const isInternalDeadEnd = [55, 57].includes(currentPartIndex);
                        
                        // C√âLPONT EL√âR√âS GOMB LEKEZEL√âS√âHEZ (GPS modal el≈ëtti oldal) √âS BELS≈ê ZS√ÅKUTCA
                        if (currentPartIndex === 68 || isInternalDeadEnd) { 
                            interactionContainer.style.justifyContent = 'center'; 
                            prevButton.style.display = 'none'; // Teljes elt√°vol√≠t√°s
                            prevButton.disabled = true;
                        } else {
                            interactionContainer.style.justifyContent = 'space-between';
                            prevButton.style.display = 'block';
                            prevButton.disabled = currentPartIndex === 0;
                        }
                    }

                } else {
                    // Ezt az √°gat m√°r nem haszn√°ljuk a be√°gyazott password oldalak miatt, de tartal√©kknak hagyjuk.
                    interactionContainer.style.display = 'none';
                    passwordContainer.classList.remove('visible');
                    discreetBackButton.style.display = 'none';
                }
            }

            function updateAvatar(pageIndex) {
                const speaker = pageIndex < storyPages.length ? storyPages[pageIndex].speaker : 'Narrator';
                
                let avatarUrl = MARK_AVATAR_URL;
                let opacity = 1;
                
                if (speaker === 'Tourist') {
                    avatarUrl = TOURIST_AVATAR_URL;
                } else if (speaker === 'Painter') {
                    avatarUrl = PAINTER_AVATAR_URL;
                } else if (speaker === 'Francois') {
                    avatarUrl = FRANCOIS_AVATAR_URL;
                } else if (speaker === 'MarkPhone') {
                    avatarUrl = MARK_PHONE_AVATAR_URL;
                } else if (speaker === 'Luceb') { // √öJ LUCEB AVATAR
                    avatarUrl = LUCEB_AVATAR_URL;
                } else if (speaker === 'Mark') {
                    avatarUrl = MARK_AVATAR_URL;
                } else { // Narrator/V√°laszt√°s/Password
                    avatarUrl = MARK_AVATAR_URL; 
                    opacity = 0; 
                }
                
                avatarImg.src = avatarUrl;
                avatarImg.style.opacity = opacity;
            }

            function showStoryPart() {
                messageDisplay.textContent = ''; 
                passwordInput.value = ''; 
                contentBox.style.opacity = 0;

                setTimeout(() => {
                    stopAllAudio(); 
                    audioContainer1.style.display = 'none';
                    audioContainer2.style.display = 'none';
                    storyDisplay.innerHTML = ''; 
                    
                    passwordContainer.classList.remove('visible'); // Mindig rejtsd el alapb√≥l

                    if (currentPartIndex < storyPages.length) {
                        const currentPage = storyPages[currentPartIndex];
                        
                        // K√©p felold√°si logik√°ja
                        if (currentPage.unlockImage) {
                            // Speci√°lis kezel√©s a k≈ëkorl√°t elt√ºntet√©s√©re (ha feloldjuk a G-t)
                            if (currentPage.unlockImage === 'korlat_code') {
                                localStorage.setItem('isKorlatUnlocked', 'false'); 
                            }
                            
                            localStorage.setItem(`is${currentPage.unlockImage.charAt(0).toUpperCase() + currentPage.unlockImage.slice(1)}Unlocked`, 'true');
                            console.log(`K√©p feloldva: ${currentPage.unlockImage}`);
                        }
                        
                        updateAvatar(currentPartIndex); 
                        
                        if (currentPage.type === 'password') {
                            storyDisplay.innerHTML = currentPage.content;
                        }
                        else if (currentPage.type === 'text' || currentPage.type === 'audio' || currentPage.type === 'choice' || currentPage.type === 'note_image') {
                            if (currentPage.content.trim() !== '') {
                            storyDisplay.innerHTML = currentPage.content;
                            }
                            
                            if (currentPage.type === 'audio') {
                                if (currentPage.audioId === 1) {
                                    audioContainer1.style.display = 'block';
                                } else if (currentPage.audioId === 2) {
                                    audioContainer2.style.display = 'block';
                                }
                            }
                        }
                        
                        storyImage.src = currentPage.image || STABLE_IMAGE_URL; 
                        
                    } else {
                        // Ez a blokk elvileg m√°r nem fut le a be√°gyazott password oldalak miatt, de tartal√©kknak hagyjuk.
                        updateAvatar(currentPartIndex); 
                        storyImage.src = STABLE_IMAGE_URL; 
                        storyDisplay.innerHTML = '';
                    }

                    contentBox.style.opacity = 1;
                    updateButtons();
                }, 100); 
            }
            
            // --- ESEM√âNYKEZEL≈êK ---
            
            // Modal bez√°r√°s a b√∂ng√©sz≈ë visszany√≠llal
            window.addEventListener('popstate', function(event) {
                if (fullImageDisplayModal.style.display === 'flex') {
                    closeFullImage();
                    history.pushState(null, null, '#gallery'); 
                } else if (galleryModal.style.display === 'block') {
                    closeGallery();
                    // Vissza√°ll√≠tja a hash-t a norm√°l √°llapotba (elt√°vol√≠tja a #gallery-t)
                    history.pushState(null, null, window.location.pathname + window.location.search);
                }
            });

            // Gal√©ria/K√©p bez√°r√≥ gombok
            document.querySelector('#galleryModal .close-gallery').onclick = () => { history.back(); };
            document.querySelector('#full-image-display .close-gallery').onclick = () => { history.back(); };

            nextButton.addEventListener('click', () => {
                // UNLOCK LOGIC for PORTRAIT: 80. index ut√°n
                if (currentPartIndex === 80) { // Eredeti 85 -> 80
                    localStorage.setItem('isPortraitUnlocked', 'true');
                    console.log("Fest≈ë Portr√©ja feloldva!");
                }
                
                const currentPage = storyPages[currentPartIndex];
                
                // √öJ LOGIKA: Egyedi akci√≥ kezel√©se (GPS modal)
                if (currentPage && currentPage.customAction === 'open_distance_modal') {
                    stopAllAudio();
                    localStorage.removeItem('gameProgress'); // T√∂r√∂lj√ºk a ment√©st
                    showDistanceModal(); 
                    return;
                }
                
                // CUSTOM ACTION: L√©pcs≈ë felold√°sa (Index 47) - Eredeti 52
                if (currentPage && currentPage.customAction === 'unlock_stairs') {
                    localStorage.setItem('isStairsUnlocked', 'true');
                    console.log("L√©pcs≈ë feloldva!");
                }

                const forcedNextIndex = nextButton.dataset.forcedNextIndex;
                if (forcedNextIndex !== undefined && forcedNextIndex !== '') {
                    // K√©nyszer√≠tett ugr√°s a megadott indexre
                    currentPartIndex = parseInt(forcedNextIndex);
                } else {
                    // Norm√°l l√©p√©s a k√∂vetkez≈ë oldalra
                    currentPartIndex++;
                }
                saveProgress();
                showStoryPart();
            });

            // Szekvenci√°lis oldalak norm√°l "Vissza" gombj√°nak esem√©nykezel≈ëje
            prevButton.addEventListener('click', () => {
                const currentPage = storyPages[currentPartIndex];
                
                // √öJ LOGIKA: Ha a sz√∂veges oldalon van backIndex defini√°lva, azt haszn√°lja
                if (currentPage.backIndex !== undefined && currentPage.type === 'text') {
                    currentPartIndex = currentPage.backIndex;
                } 
                // Alap√©rtelmezett viselked√©s
                else if (currentPartIndex > 0) {
                    currentPartIndex--;
                }
                
                saveProgress();
                showStoryPart();
            });

            backButtonPassword.addEventListener('click', () => {
                const currentPage = storyPages[currentPartIndex];
                if (currentPage.type === 'password' && currentPage.backIndex !== undefined) {
                    currentPartIndex = currentPage.backIndex;
                    saveProgress();
                    showStoryPart();
                }
            });

            checkButton.addEventListener('click', () => {
                const currentPage = storyPages[currentPartIndex];
                if (currentPage.type !== 'password') return;

                const enteredPassword = passwordInput.value.trim();
                const correctPassword = currentPage.correctPassword;
                const isCaseInsensitive = currentPage.isCaseInsensitive || false;
                
                let isCorrect = false;
                if (isCaseInsensitive) {
                    isCorrect = enteredPassword.toLowerCase() === correctPassword.toLowerCase();
                } else {
                    isCorrect = enteredPassword === correctPassword;
                }
                
                if (isCorrect) {
                    messageDisplay.textContent = 'K√≥d elfogadva!';
                    messageDisplay.style.color = '#00FF00';
                    
                    // K√ìD SIKER UT√ÅNI AKCI√ìK
                    if (currentPartIndex === 45) { // Korl√°t (G) k√≥d
                        // Megjelenik a G.jpg a gal√©ri√°ban
                        localStorage.setItem('isKorlatCodeUnlocked', 'true'); 
                        // Elt√ºnteti a K≈ëkorl√°t k√©pet a gal√©ri√°b√≥l
                        localStorage.setItem('isKorlatUnlocked', 'false'); 
                        messageDisplay.textContent = 'K√≥d elfogadva! A bet≈± megjelent a gal√©ri√°ban, a k≈ëkorl√°t elt≈±nt.';
                    } else if (currentPartIndex === 46) { // √úzen≈ëfal (214) k√≥d
                        // Elt√ºnteti a Lak√≥k√∂z√∂ss√©g √ºzen≈ëfala k√©pet a gal√©ri√°b√≥l
                        localStorage.setItem('isUzenofalUnlocked', 'false'); 
                        messageDisplay.textContent = 'K√≥d elfogadva! Az √ºzen≈ëfal elt≈±nt a gal√©ri√°b√≥l.';
                    }
                    // A 214-es k√≥d logik√°j√°t most a k√∂vetkez≈ë oldal (Index 47) v√©gzi a `customAction` seg√≠ts√©g√©vel. - Eredeti 52
                    
                    if (currentPartIndex === 72) { // Telefonf√ºlke (8127) k√≥d - SHIFTED
                        localStorage.setItem('isNoteUnlocked', 'true');
                        messageDisplay.textContent = 'K√≥d elfogadva! Egy √ºzenetet tal√°lt√°l...';
                    }
                    
                    // √öJ: K√°lv√°riahegy (66-es index) - Elt√°vol√≠tja a "Furcsa fal" k√©pet
                    if (currentPartIndex === 66) {
                        localStorage.setItem('isEmlektablaUnlocked', 'false'); // Elt√°vol√≠tja a "Furcsa fal" k√©pet a gal√©ri√°b√≥l
                        messageDisplay.textContent = 'K√≥d elfogadva! Egy apr√≥ rekeszt tal√°lt√°l...';
                    }
                    
                    // Ugr√°s a sikeres oldalra
                    setTimeout(() => {
                        currentPartIndex = currentPage.nextIndexSuccess; 
                        saveProgress();
                        showStoryPart(); 
                    }, 1000);
                    
                } else {
                    messageDisplay.textContent = 'Helytelen jelsz√≥! Pr√≥b√°ld √∫jra.';
                    messageDisplay.style.color = '#ff4500';
                    passwordInput.value = '';
                }
            });

            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    checkButton.click(); 
                }
            });
            
            // √öJ: Szoba gomb esem√©nykezel≈ëje
            roomLinkButton.addEventListener('click', () => {
                const url = roomLinkButton.dataset.url;
                if (url) {
                    window.open(url, '_blank');
                }
            });
            
            playAudioButton1.addEventListener('click', () => toggleAudio(storyAudio1, playAudioButton1, '1'));
            playAudioButton2.addEventListener('click', () => toggleAudio(storyAudio2, playAudioButton2, '2'));

            imageButton.addEventListener('click', openGallery);
            
            mapButton.addEventListener('click', () => {
                // Megnyitja az √°ltal√°nos t√©rk√©pet
                window.open(MENU_MAP_URL, '_blank');
            });

            if (helpButton) {
                helpButton.addEventListener('click', () => {
                    currentHelpIndex = 0; // A help index mindig 0-r√≥l indul az √∫j logik√°ban
                    showHelpMessage();
                });
            }

            if (helpNextButton) {
                helpNextButton.addEventListener('click', nextHelpStep);
            }
            
            if (helpCloseButton) {
                helpCloseButton.addEventListener('click', closeHelpModal);
            }

            // Choice button esem√©nykezel≈ëk
            [choice1Button, choice2Button, choice3Button, choice4Button].filter(Boolean).forEach((button, index) => {
                button.addEventListener('click', (e) => {
                    const currentPage = storyPages[currentPartIndex];
                    const chosenChoice = currentPage.choices ? currentPage.choices[index] : null;

                    // EGYEDI LOGIKA A LAK√ÅSBELI K√ñR√úLN√âZ√âS GOMBHOZ (Index 54, Choice 0)
                    if (currentPartIndex === 54 && index === 0) {
                        localStorage.setItem('isSzobarendetlenUnlocked', 'true');
                        console.log("Szobarendetlen k√©p feloldva a gal√©ri√°ban!");
                    }

                    // K√úLS≈ê LINK KEZEL√âSE
                    if (chosenChoice && chosenChoice.externalUrl) {
                        window.open(chosenChoice.externalUrl, '_blank');
                    }

                    const chosenNextIndex = parseInt(e.currentTarget.dataset.nextIndex);
                    
                    // EGYEDI LOGIKA: L√âPCS≈ê Z√ÅR (Index 43)
                    if (currentPartIndex === 43 && e.currentTarget === choice2Button) {
                        const isStairsUnlocked = localStorage.getItem('isStairsUnlocked') === 'true';
                        
                        if (isStairsUnlocked) {
                            // Feloldva: ugorjon az 49-es indexre (L√©pcs≈ën felfel√© - Fels√©t√°lsz)
                            currentPartIndex = 49;
                        } else {
                            // Z√°rva: ugorjon az 48-as indexre (Z√°rt √ºzenet - Egyel≈ëre nincs dolgod errefel√©.)
                            currentPartIndex = 48;
                        }
                    } else {
                        // Norm√°l l√©p√©s (vagy visszaugr√°s a link nyit√°sa ut√°n)
                        currentPartIndex = chosenNextIndex;
                    }

                    saveProgress();
                    showStoryPart();
                });
            });

            // Diszkr√©t Vissza gomb esem√©nykezel≈ë (csak a choice k√©perny≈ën l√°tszik)
            discreetBackButton.addEventListener('click', () => {
                if (currentPartIndex > 0) {
                    // Visszakeresi az el≈ëz≈ë nem-v√°laszt√≥ oldalt
                    let targetIndex = currentPartIndex - 1;
                    while (targetIndex > 0 && storyPages[targetIndex].type === 'choice') {
                        targetIndex--;
                    }
                    currentPartIndex = targetIndex; 

                    saveProgress();
                    showStoryPart();
                }
            });


            function initializeApp() {
                if (document.body.style.visibility === 'visible') return; 

                loadProgress(); 
                showStoryPart();
                
                document.body.style.visibility = 'visible';
                document.body.style.opacity = 1;
            }

            window.onload = () => {
                initializeApp(); 
            };
        })(); // Az IIFE lez√°r√°sa
    </script>
</body>
</html>
