<!doctype html>
<html lang="hu">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Játék Exportálás</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #1a1a1a; color: #e0e0e0; }
        .card { background-color: #2c2c2c; border: 2px solid #8a2be2; box-shadow: 0 0 20px rgba(138, 43, 226, 0.4); }
        .btn-primary { background-color: #8a2be2; color: white; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #7b1cd1; }
        .btn-secondary { background-color: #00ffff; color: #1a1a1a; font-weight: bold; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex items-center justify-center">

    <div class="max-w-xl mx-auto space-y-8 text-center card p-8 rounded-xl">
        <h1 class="text-4xl font-bold text-white mb-4">Játékfájl Generálása</h1>
        
        <p id="statusMessage" class="text-xl text-yellow-400">Betöltés...</p>
        
        <div id="downloadSection" class="space-y-4 hidden">
            <p class="text-green-400 font-semibold text-lg">A konfiguráció betöltve. Készen áll a letöltésre!</p>
            <button id="downloadButton" class="btn-secondary p-4 rounded-xl text-lg font-bold uppercase w-full">
                <i class="fa-solid fa-file-arrow-down mr-2"></i> GAME.HTML Letöltése
            </button>
            <textarea id="gameHtmlOutput" rows="15" class="w-full p-3 rounded-lg bg-gray-700 text-gray-200 font-mono text-sm" readonly></textarea>
        </div>
        
        <p id="errorMessage" class="text-red-500 font-bold hidden">Hiba történt a konfiguráció betöltésekor. Kérjük, térjen vissza az admin oldalra.</p>

        <a href="admin.html" class="btn-primary p-3 rounded-lg inline-block mt-4"><i class="fa-solid fa-wrench mr-2"></i> Vissza az Adminisztrációhoz</a>
    </div>

    <script>
        const STORAGE_KEY = 'DYNAMIC_CONFIG';
        
        // A game.html tartalmát tölti be (amit az előző részben generáltunk)
        const GAME_HTML_TEMPLATE = `
            ${document.querySelector('html').outerHTML.split('</script>').join('</script>').replace(/<\/body>.*$/s, '</body></html>')}`; // Ez a trükkös rész a beágyazott scriptek miatt

        function getGameTemplate() {
            // Mivel a game.html nem létezik fizikailag, a forráskódját használjuk a beágyazáshoz
            // A legkézenfekvőbb a game.html tartalmát AJAX-szal betölteni, de önálló fájlként generáljuk most.
            // Másoljuk a game.html kódját ide, kivéve a CONFIG-ot
            return \`
                ${document.querySelector('#gameHtmlOutput').value}\`;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const statusMessage = document.getElementById('statusMessage');
            const downloadSection = document.getElementById('downloadSection');
            const errorMessage = document.getElementById('errorMessage');
            const gameHtmlOutput = document.getElementById('gameHtmlOutput');

            // 1. A játék HTML sablonjának betöltése (a game.html-t a felhasználónak kell mentenie)
            // Itt a GAME_HTML_TEMPLATE-et használom, aminek a VALÓDI game.html kódnak kellene lennie!
            const gameTemplateUrl = 'game.html'; // Tegyük fel, hogy ez a fájl letölthető
            
            try {
                // Ideális esetben a game.html tartalmát tölti be
                // Mivel nem tudom letölteni, a felhasználónak megadott game.html kódot használom sablonként
                
                statusMessage.textContent = 'Konfiguráció betöltése a LocalStorage-ból...';
                const savedConfig = localStorage.getItem(STORAGE_KEY);
                
                if (!savedConfig) {
                    throw new Error("Nincs mentett konfiguráció.");
                }

                // Generáljuk le a game.html tartalmát a beágyazott CONFIG-gal
                let gameHtmlContent = \`${document.querySelector('body').innerHTML}\`; // Ez csak a download.html tartalma...

                // Ideális megoldás: beolvasni a game.html-t, és a CONFIG-ot kicserélni
                // Mivel ezt a kódban nem tehetem meg, a VÉGSŐ JÁTÉK KÓDJÁT be kell illesztenünk valahova
                
                // Jelenleg: A user által letöltendő game.html tartalma (a CONFIG beágyazva)
                gameHtmlContent = \`
<!doctype html>
<html lang="hu">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=10.0">
    <title id="gameTitle">Interaktív Kém Játék</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #1a1a1a; color: #e0e0e0; transition: background-color 0.5s; }
        .game-screen { background-color: rgba(0, 0, 0, 0.7); border: 2px solid #8a2be2; box-shadow: 0 0 30px rgba(0, 255, 255, 0.3), 0 0 10px rgba(138, 43, 226, 0.7); border-radius: 12px; min-height: calc(100vh - 64px); }
        .dialogue-box { background-color: rgba(44, 44, 44, 0.85); padding: 1rem; border-radius: 8px; border-left: 5px solid #00ffff; line-height: 1.6; margin-bottom: 1rem; animation: fadeIn 0.8s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .avatar { width: 70px; height: 70px; border-radius: 50%; border: 3px solid #00ffff; object-fit: cover; flex-shrink: 0; transition: transform 0.3s; }
        .avatar:hover { transform: scale(1.05); }
        .action-btn { background-color: #8a2be2; color: white; transition: background-color 0.2s, transform 0.1s; font-weight: bold; text-transform: uppercase; box-shadow: 0 4px #7b1cd1; }
        .action-btn:hover { background-color: #7b1cd1; box-shadow: 0 2px #6a0bba; transform: translateY(2px); }
        .action-btn:active { transform: translateY(4px); box-shadow: none; }
        .map-btn { background-color: #00ffff; color: #1a1a1a; box-shadow: 0 4px #00ddee; }
        .map-btn:hover { background-color: #00ddee; box-shadow: 0 2px #00bbcc; }
        .password-input { background-color: #3f3f46; color: #00ffff; border: 2px solid #ff00ff; }
        .password-input:focus { border-color: #8a2be2; box-shadow: 0 0 10px #8a2be2; }
        .gallery-image { max-height: 200px; width: 100%; object-fit: cover; border-radius: 6px; border: 2px solid rgba(0, 255, 255, 0.5); margin-bottom: 10px; }
    </style>
</head>
<body class="p-4 flex flex-col items-center" style="background-image: url('https://treasurehuntsites.github.io/annaesmark/Img/kr.jpg'); background-size: cover; background-position: center;">

    <div id="gameScreen" class="game-screen max-w-xl w-full p-6 space-y-4 relative">
        <div id="topMenu" class="flex justify-between items-center mb-4 pb-2 border-b border-gray-600/50">
            <button id="menuBtn" class="action-btn p-2 rounded text-sm"><i class="fa-solid fa-bars mr-1"></i> Menü</button>
            <h1 class="text-xl font-bold text-white uppercase tracking-wider hidden sm:block">KÓD-AKCIÓ: <span id="currentStatus" class="text-[#00ffff]">START</span></h1>
            <button id="gpsBtn" class="map-btn p-2 rounded text-sm"><i class="fa-solid fa-location-crosshairs mr-1"></i> GPS</button>
        </div>

        <div id="mainContent" class="space-y-4"></div>

        <div id="actionButtons" class="pt-4 border-t border-gray-600/50 space-y-3"></div>
        
        <div id="galleryContainer" class="grid grid-cols-2 gap-4 mt-4 p-4 bg-gray-900/50 rounded-lg hidden"></div>

        <button id="backBtn" class="action-btn w-full p-3 rounded-lg opacity-50 text-sm mt-4 hidden" onclick="navigate(-1)">
            <i class="fa-solid fa-arrow-left mr-2"></i> Vissza az előző oldalra
        </button>
    </div>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 hidden">
        <div class="card p-6 rounded-xl space-y-4 w-full max-w-md">
            <h2 id="modalTitle" class="text-2xl font-bold text-white border-b border-gray-600 pb-2">Menü</h2>
            <div id="modalContent" class="space-y-3">
                <a id="modalMapLink" href="#" target="_blank" class="map-btn w-full p-3 rounded-lg block text-center"><i class="fa-solid fa-map-location-dot mr-2"></i> Fő Térkép Megnyitása</a>
                <button id="closeModalBtn" class="action-btn w-full p-3 rounded-lg mt-4"><i class="fa-solid fa-xmark mr-2"></i> Bezárás</button>
            </div>
        </div>
    </div>
    
    <div id="gpsModal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 hidden">
        <div class="card p-6 rounded-xl space-y-4 w-full max-w-md text-center">
            <h2 class="text-2xl font-bold text-white border-b border-gray-600 pb-2">Célpont Keresése (GPS)</h2>
            <p id="distanceText" class="text-4xl font-extrabold text-[#00ffff] my-4">Távolság: ? m</p>
            <p id="accuracyText" class="text-sm text-yellow-400">Pontosság: ? m</p>
            <a id="gpsMapLink" href="#" target="_blank" class="map-btn w-full p-3 rounded-lg block text-center"><i class="fa-solid fa-road-circle-check mr-2"></i> Útvonal Térképen</a>
            <button id="closeGpsModalBtn" class="action-btn w-full p-3 rounded-lg mt-4"><i class="fa-solid fa-arrow-right-to-bracket mr-2"></i> Vissza a Történethez</button>
        </div>
    </div>
    <script>
        // Ezt a konfigurációt az adminisztrációs oldal fogja betölteni/átírni a letöltéskor.
        const CONFIG = ${savedConfig};

        // A teljes Game JS kód a game.html-ből.
        // Mivel nem tudom beilleszteni a teljes game.html scriptet a kódomba, 
        // egy üres placeholder van itt. Ezért ez a letöltés csak MINTÁNAK jó. 
        // A teljes, működő letöltéshez a game.html teljes kódjára szükség van a CONFIG felett és alatt.
        
        // --- Ide jönne a game.html teljes JS kódja a CONFIG alá ---
        // A CONFIG már tartalmazza a mentett adatokat. A loadConfig() nem szükséges.
        
        const elements = {
            gameTitle: document.getElementById('gameTitle'),
            gameScreen: document.getElementById('gameScreen'),
            mainContent: document.getElementById('mainContent'),
            actionButtons: document.getElementById('actionButtons'),
            backBtn: document.getElementById('backBtn'),
            menuBtn: document.getElementById('menuBtn'),
            gpsBtn: document.getElementById('gpsBtn'),
            modal: document.getElementById('modal'),
            modalTitle: document.getElementById('modalTitle'),
            modalContent: document.getElementById('modalContent'),
            closeModalBtn: document.getElementById('closeModalBtn'),
            gpsModal: document.getElementById('gpsModal'),
            closeGpsModalBtn: document.getElementById('closeGpsModalBtn'),
            distanceText: document.getElementById('distanceText'),
            accuracyText: document.getElementById('accuracyText'),
            currentStatus: document.getElementById('currentStatus'),
            galleryContainer: document.getElementById('galleryContainer'),
            modalMapLink: document.getElementById('modalMapLink'),
            gpsMapLink: document.getElementById('gpsMapLink')
        };
        
        let audioPlayer = null;

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Föld sugara méterben
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // Távolság méterben
        }
        
        // Nincs szükség mentésre és betöltésre, ha a CONFIG be van ágyazva, 
        // de az aktuális állapotot menteni kell a játékmenet során.
        function saveConfig() {
             localStorage.setItem('RUNTIME_CONFIG', JSON.stringify(CONFIG)); // Másik kulcs a runtime adatoknak
        }

        function loadConfig() {
            try {
                const runtimeData = localStorage.getItem('RUNTIME_CONFIG');
                if (runtimeData) {
                    const runtimeConfig = JSON.parse(runtimeData);
                    CONFIG.currentState = runtimeConfig.currentState || CONFIG.currentState;
                }
            } catch (e) {
                console.error("Hiba a futásidejű konfiguráció betöltésekor:", e);
            }
        }
        
        function updateStyles() {
            document.body.style.backgroundColor = CONFIG.BODY_BG_COLOR;
            document.body.style.color = CONFIG.BODY_TEXT_COLOR;
            elements.gameTitle.textContent = CONFIG.APP_TITLE;
            
            if (CONFIG.storyPages[CONFIG.currentState.storyIndex].customBackgroundUrl) {
                document.body.style.backgroundImage = \`url('\${CONFIG.storyPages[CONFIG.currentState.storyIndex].customBackgroundUrl}')\`;
            } else if (CONFIG.BACKGROUND_URL) {
                document.body.style.backgroundImage = \`url('\${CONFIG.BACKGROUND_URL}')\`;
            } else {
                document.body.style.backgroundImage = 'none';
            }
        }
        
        function updateGallery(page) {
            if (page.customGalleryUrl) {
                const urls = page.customGalleryUrl.split('\\n').map(url => url.trim()).filter(url => url.length > 0);
                const mode = page.galleryMode || 'add_url';
                
                if (mode === 'clear') {
                    CONFIG.currentState.galleryImages = [];
                } else if (mode === 'add_url') {
                    urls.forEach(url => {
                        if (!CONFIG.currentState.galleryImages.includes(url)) {
                            CONFIG.currentState.galleryImages.push(url);
                        }
                    });
                } else if (mode === 'remove_url') {
                    CONFIG.currentState.galleryImages = CONFIG.currentState.galleryImages.filter(img => !urls.includes(img));
                }
                
                saveConfig();
            }

            elements.galleryContainer.innerHTML = '';
            if (CONFIG.currentState.galleryImages.length > 0) {
                elements.galleryContainer.classList.remove('hidden');
                CONFIG.currentState.galleryImages.forEach(url => {
                    elements.galleryContainer.innerHTML += \`
                        <a href="\${url}" target="_blank" class="block">
                            <img src="\${url}" class="gallery-image" onerror="this.src='https://placehold.co/400x200?text=KÉP+HIBA'">
                        </a>
                    \`;
                });
            } else {
                elements.galleryContainer.classList.add('hidden');
            }
        }

        function renderPage(index) {
            const page = CONFIG.storyPages[index];
            if (!page) {
                elements.mainContent.innerHTML = \`<div class="dialogue-box text-red-500">Hiba: A(\${index}) oldal nem található!</div>\`;
                elements.actionButtons.innerHTML = \`<button class="action-btn w-full p-3 rounded-lg" onclick="navigate(0)">Újraindítás</button>\`;
                elements.backBtn.classList.add('hidden');
                return;
            }

            updateStyles();
            updateGallery(page);
            
            let [avatarUrl, cleanText, isAvatarVisible] = processDialogueContent(page.content, page.customAvatarUrl);
            
            elements.mainContent.innerHTML = \`
                <div class="dialogue-box">
                    <div class="flex items-start">
                        <img src="\${avatarUrl}" class="avatar mr-4" style="display: \${isAvatarVisible ? 'block' : 'none'};" onerror="this.src='\${CONFIG.AVATARS.DEFAULT_AVATAR_URL}'">
                        <div class="flex-1">
                            <p class="text-lg leading-relaxed whitespace-pre-wrap">\${cleanText}</p>
                        </div>
                    </div>
                </div>
            \`;
            
            elements.actionButtons.innerHTML = '';
            elements.backBtn.classList.add('hidden');

            if (page.type === 'text') {
                elements.actionButtons.innerHTML = \`<button class="action-btn w-full p-3 rounded-lg" onclick="navigate(\${page.nextIndex || index + 1})"><i class="fa-solid fa-arrow-right mr-2"></i> Tovább</button>\`;
                if (page.backIndex !== undefined) {
                    elements.backBtn.classList.remove('hidden');
                }
            } else if (page.type === 'audio') {
                const audioUrl = CONFIG.MEDIA[\`AUDIO_\${page.audioId}_URL\`];
                if (audioPlayer) { audioPlayer.pause(); }
                audioPlayer = new Audio(audioUrl);
                
                elements.mainContent.innerHTML += \`
                    <div class="bg-cyan-900/40 p-3 rounded-lg flex justify-between items-center mt-3">
                        <p class="text-cyan-300 font-bold">Audio Üzenet \${page.audioId}</p>
                        <button class="action-btn map-btn text-white px-4 py-2 rounded-lg" onclick="audioPlayer.play()"><i class="fa-solid fa-volume-up mr-2"></i> Lejátszás</button>
                    </div>
                \`;
                elements.actionButtons.innerHTML = \`<button class="action-btn w-full p-3 rounded-lg" onclick="audioPlayer.pause(); navigate(\${page.nextIndex || index + 1})"><i class="fa-solid fa-forward mr-2"></i> \${page.nextButtonText || 'Tovább'}</button>\`;
                elements.backBtn.classList.remove('hidden');
            } else if (page.type === 'password') {
                elements.actionButtons.innerHTML = \`
                    <input type="text" id="passwordInput" class="password-input w-full p-3 rounded-lg text-center text-xl font-bold mb-3" placeholder="\${CONFIG.PASSWORD_PAGE.PROMPT_TEXT}">
                    <button class="action-btn w-full p-3 rounded-lg" onclick="checkPassword(\${index})"><i class="fa-solid fa-shield-halved mr-2"></i> \${CONFIG.PASSWORD_PAGE.CHECK_BUTTON_TEXT}</button>
                    <p id="passwordMessage" class="text-center text-red-400 mt-2"></p>
                \`;
                elements.backBtn.classList.remove('hidden');
            } else if (page.type === 'choice') {
                page.choices.forEach(choice => {
                    elements.actionButtons.innerHTML += \`
                        <button class="action-btn w-full p-3 rounded-lg" onclick="navigate(\${choice.nextIndex})">\${choice.text}</button>
                    \`;
                });
                elements.backBtn.classList.remove('hidden');
            } else {
                 elements.actionButtons.innerHTML = \`<button class="action-btn w-full p-3 rounded-lg" onclick="navigate(\${index + 1})"><i class="fa-solid fa-arrow-right mr-2"></i> Tovább</button>\`;
            }
        }
        
        function processDialogueContent(content, customAvatar) {
            const parts = content.trim().split(/\\s+/);
            const prefix = parts.length > 0 ? parts[0] : '';
            let avatarUrl = CONFIG.AVATARS.DEFAULT_AVATAR_URL;
            let cleanText = content;
            let isAvatarVisible = true;

            if (customAvatar && customAvatar.trim() !== '') {
                avatarUrl = customAvatar;
                if (CONFIG.AVATARS.AVATAR_MAP[prefix]) {
                    cleanText = content.substring(prefix.length).trim();
                } else if (CONFIG.AVATARS.HIDDEN_PREFIXES.includes(prefix)) {
                    isAvatarVisible = false;
                    cleanText = content.substring(prefix.length).trim();
                }
            } else {
                if (CONFIG.AVATARS.AVATAR_MAP[prefix]) {
                    avatarUrl = CONFIG.AVATARS.AVATAR_MAP[prefix];
                    cleanText = content.substring(prefix.length).trim();
                } else if (CONFIG.AVATARS.HIDDEN_PREFIXES.includes(prefix)) {
                    isAvatarVisible = false;
                    cleanText = content.substring(prefix.length).trim();
                } else {
                    isAvatarVisible = false;
                }
            }
            return [avatarUrl, cleanText, isAvatarVisible];
        }

        window.navigate = function(targetIndex) {
            const currentIndex = CONFIG.currentState.storyIndex;
            
            if (targetIndex === -1 && CONFIG.currentState.visitedIndexes.length > 1) {
                CONFIG.currentState.visitedIndexes.pop();
                const prevIndex = CONFIG.currentState.visitedIndexes.pop();
                CONFIG.currentState.storyIndex = prevIndex;
                CONFIG.currentState.visitedIndexes.push(prevIndex);
                renderPage(prevIndex);
                saveConfig();
                return;
            } else if (targetIndex === -1 && CONFIG.currentState.visitedIndexes.length <= 1) {
                return;
            }
            
            const nextIndex = parseInt(targetIndex);

            if (isNaN(nextIndex)) {
                return;
            }

            if (nextIndex === -1) {
                openGpsModal();
                return;
            }

            if (nextIndex !== currentIndex) {
                 CONFIG.currentState.visitedIndexes.push(nextIndex);
            }
            CONFIG.currentState.storyIndex = nextIndex;
            
            if (CONFIG.storyPages[nextIndex].backIndex !== undefined) {
                 elements.backBtn.classList.remove('hidden');
            } else {
                 elements.backBtn.classList.add('hidden');
            }

            renderPage(nextIndex);
            saveConfig();
        }
        
        window.checkPassword = function(currentIndex) {
            const page = CONFIG.storyPages[currentIndex];
            const input = document.getElementById('passwordInput').value.trim();
            const message = document.getElementById('passwordMessage');
            
            message.textContent = '';
            
            if (input.toLowerCase() === page.correctPassword.toLowerCase()) {
                message.textContent = CONFIG.PASSWORD_PAGE.SUCCESS_MESSAGE;
                message.style.color = '#00FF00';
                
                setTimeout(() => {
                    navigate(page.nextIndexSuccess);
                }, 1500);
            } else {
                message.textContent = CONFIG.PASSWORD_PAGE.ERROR_MESSAGE;
                message.style.color = '#FF5555';
            }
        }
        
        function openModal() {
            elements.modalTitle.textContent = "Térkép és Információk";
            elements.modalMapLink.href = CONFIG.MENU_LINKS.MAP_LINK_URL;
            elements.modal.classList.remove('hidden');
        }

        function closeModal() {
            elements.modal.classList.add('hidden');
        }
        
        let watchId = null;

        function openGpsModal() {
            elements.gpsMapLink.href = CONFIG.GPS_COMPASS.MAP_BUTTON_URL;
            elements.gpsModal.classList.remove('hidden');
            
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(updateGps, errorGps, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
                elements.distanceText.textContent = "Helyzet keresése...";
                elements.accuracyText.textContent = "";
            } else {
                elements.distanceText.textContent = "GPS nem támogatott.";
            }
        }

        function closeGpsModal() {
            elements.gpsModal.classList.add('hidden');
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            if (CONFIG.storyPages[CONFIG.currentState.storyIndex].type === 'password' && CONFIG.storyPages[CONFIG.currentState.storyIndex].nextIndexSuccess === -1) {
                navigate(CONFIG.currentState.storyIndex);
            }
        }
        
        function updateGps(position) {
            const currentLat = position.coords.latitude;
            const currentLon = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            const targetLat = CONFIG.GPS_COMPASS.TARGET_LATITUDE;
            const targetLon = CONFIG.GPS_COMPASS.TARGET_LONGITUDE;
            const distance = calculateDistance(currentLat, currentLon, targetLat, targetLon);
            
            elements.distanceText.textContent = \`Távolság: \${distance.toFixed(1)} m\`;
            elements.accuracyText.textContent = \`Pontosság: \${accuracy.toFixed(1)} m\`;

            if (distance <= CONFIG.GPS_COMPASS.DISTANCE_THRESHOLD_METERS) {
                elements.distanceText.textContent = "Célpont elérve!";
                elements.gpsModal.classList.add('bg-green-800/80');
                if (watchId !== null) {
                    navigator.geolocation.clearWatch(watchId);
                    watchId = null;
                }
                
                setTimeout(() => {
                    window.location.href = CONFIG.GPS_COMPASS.SUCCESS_REDIRECT_URL;
                }, 2000);
            }
        }

        function errorGps(error) {
            let message = "GPS hiba: ";
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message += "A felhasználó megtagadta a helymeghatározást.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    message += "A hely adatok nem állnak rendelkezésre.";
                    break;
                case error.TIMEOUT:
                    message += "A kérés időtúllépés miatt meghiúsult.";
                    break;
                case error.UNKNOWN_ERROR:
                    message += "Ismeretlen hiba történt.";
                    break;
            }
            elements.distanceText.textContent = message;
            elements.accuracyText.textContent = "";
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            loadConfig();
            
            if (CONFIG.currentState.storyIndex === undefined || CONFIG.currentState.storyIndex >= CONFIG.storyPages.length) {
                CONFIG.currentState.storyIndex = 0;
                CONFIG.currentState.visitedIndexes = [0];
            }
            
            renderPage(CONFIG.currentState.storyIndex);
            
            elements.menuBtn.addEventListener('click', openModal);
            elements.closeModalBtn.addEventListener('click', closeModal);
            elements.gpsBtn.addEventListener('click', openGpsModal);
            elements.closeGpsModalBtn.addEventListener('click', closeGpsModal);
            
            saveConfig(); // Ezt a mentést használja a játék a runtime adatokhoz
        });
        // --- Vége a game.html teljes JS kódjának ---

    </script>
</body>
</html>
                \`;

                gameHtmlOutput.value = gameHtmlContent.trim();
                statusMessage.textContent = 'A játék HTML sikeresen generálva!';
                statusMessage.classList.remove('text-yellow-400');
                statusMessage.classList.add('text-green-400');
                downloadSection.classList.remove('hidden');

                // Letöltés gomb eseménykezelő
                document.getElementById('downloadButton').addEventListener('click', () => {
                    const blob = new Blob([gameHtmlOutput.value], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'game.html';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    document.getElementById('downloadButton').innerHTML = '<i class="fa-solid fa-check mr-2"></i> Letöltés Kész!';
                });
                
            } catch (e) {
                console.error(e);
                statusMessage.classList.add('hidden');
                errorMessage.textContent = 'Hiba a generálás során: ' + e.message;
                errorMessage.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
