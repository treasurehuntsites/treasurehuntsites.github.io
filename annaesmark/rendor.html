<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>GPS K√∂vet√©s Mozg√≥ C√©lponttal</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAo9T0XLYJk976X4UaT68Q8z16jB22p2D30T4uY="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-2qE2C2b2r2A60k52J67B547w379xM9M3r50Lq7v8i7Q="
            crossorigin=""></script>

    <style>
        #map { height: 400px; width: 100%; margin-top: 15px; }
        .distance-info { font-size: 1.2em; }
        .distance-warning { color: red; font-weight: bold; }
    </style>
</head>
<body>

    <h1>üöÄ Mozg√≥ C√©lpont K√∂vet√©se</h1>
    <p>A c√©lpont a Te **kezdeti poz√≠ci√≥d** fel√© k√∂zeledik 5 km/h sebess√©ggel.</p>
    <div id="status-info">V√°rjuk a GPS poz√≠ci√≥t...</div>
    <div id="distance-info" class="distance-info"></div>
    <div id="map"></div>

    <script>
        // --- 1. Konfigur√°ci√≥ ---
        const REDIRECT_URL = "https://www.google.com";
        const START_DISTANCE_METERS = 50; // Kezdeti t√°vols√°g 50 m√©ter
        const REDIRECT_RADIUS_METERS = 10; // √Åtir√°ny√≠t√°si k√ºsz√∂b (10 m√©ter)
        const TARGET_SPEED_KPH = 5; // C√©lpont sebess√©ge 5 km/h
        const UPDATE_INTERVAL_MS = 5000; // GPS friss√≠t√©si gyakoris√°g (5 m√°sodperc)

        // Sebess√©g m/ms-ban: 5 km/h = 5000 m / 3600 s * 1000 ms = 0.001388... m/ms
        const TARGET_SPEED_MPS = TARGET_SPEED_KPH * 1000 / 3600; 

        // √Ållapotv√°ltoz√≥k
        let map;
        let userMarker, targetMarker;
        let userStartPos = null; // A kezdeti poz√≠ci√≥d
        let targetPos = null;    // A c√©lpont aktu√°lis poz√≠ci√≥ja
        let lastTargetUpdateTime = Date.now();
        let targetDirection;     // Ir√°ny a c√©lpont mozgat√°s√°hoz (bearing)
        let trackingStarted = false;

        // --- 2. Geometriai f√ºggv√©nyek ---

        // Konvert√°l√°s radi√°nra
        function toRad(deg) { return deg * (Math.PI / 180); }
        // Konvert√°l√°s fokra
        function toDeg(rad) { return rad * (180 / Math.PI); }

        // Haversine t√°vols√°gsz√°m√≠t√°s (m√©terben)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // Pont sz√°m√≠t√°sa t√°vols√°gra √©s ir√°nyra (bearing) egy m√°sik pontt√≥l
        function calculateTargetPosition(lat, lon, distanceMeters, bearing) {
            const R = 6371e3; // F√∂ld sugara m√©terben
            const dist = distanceMeters / R; // T√°vols√°g radi√°nban
            const brng = toRad(bearing);

            const lat1 = toRad(lat);
            const lon1 = toRad(lon);

            let lat2 = Math.asin(Math.sin(lat1) * Math.cos(dist) +
                                 Math.cos(lat1) * Math.sin(dist) * Math.cos(brng));
            let lon2 = lon1 + Math.atan2(Math.sin(brng) * Math.sin(dist) * Math.cos(lat1),
                                          Math.cos(dist) - Math.sin(lat1) * Math.sin(lat2));

            return { lat: toDeg(lat2), lon: toDeg(lon2) };
        }

        // K√©t pont k√∂z√∂tti ir√°ny sz√°m√≠t√°sa (bearing fokban)
        function calculateBearing(lat1, lon1, lat2, lon2) {
            const y = Math.sin(toRad(lon2 - lon1)) * Math.cos(toRad(lat2));
            const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
                      Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(toRad(lon2 - lon1));
            return (toDeg(Math.atan2(y, x)) + 360) % 360; // 0-360 fok
        }

        // --- 3. C√©lpont Mozgat√≥ √©s Kezd≈ë Poz√≠ci√≥ Be√°ll√≠t√≥ F√ºggv√©nyek ---

        // C√©lpont kezdeti poz√≠ci√≥j√°nak be√°ll√≠t√°sa (50m-re a felhaszn√°l√≥t√≥l)
        function setupTarget(userLat, userLon) {
            // V√©letlenszer≈± ir√°ny (0-360 fok) a kezdeti pont elhelyez√©s√©re
            const randomBearing = Math.random() * 360; 
            
            // Kisz√°m√≠tjuk a c√©lpont kezd≈ë poz√≠ci√≥j√°t 50m-re
            targetPos = calculateTargetPosition(userLat, userLon, START_DISTANCE_METERS, randomBearing);
            
            // Kisz√°m√≠tjuk azt az ir√°nyt, amerre a c√©lpontnak mozognia kell (a kezdeti poz√≠ci√≥ fel√©)
            targetDirection = calculateBearing(targetPos.lat, targetPos.lon, userLat, userLon);
            
            lastTargetUpdateTime = Date.now();
            
            console.log(`C√©lpont kezdeti poz√≠ci√≥ja (${START_DISTANCE_METERS}m-re) be√°ll√≠tva. Ir√°ny: ${targetDirection.toFixed(2)} fok.`);
        }

        // C√©lpont mozgat√°sa (a saj√°t Kezdeti Poz√≠ci√≥d fel√©)
        function moveTarget() {
            const now = Date.now();
            const deltaTimeMs = now - lastTargetUpdateTime;
            lastTargetUpdateTime = now;

            // T√°vols√°g, amennyit a c√©lpont megtett (m√©terben)
            const distanceMoved = TARGET_SPEED_MPS * (deltaTimeMs / 1000); 

            // C√©lpont aktu√°lis t√°vols√°ga a kezdeti poz√≠ci√≥t√≥l
            let currentDistToStart = calculateDistance(targetPos.lat, targetPos.lon, userStartPos.lat, userStartPos.lon);
            
            // Ha m√°r t√∫l k√∂zel van (0.1m-n√©l), meg√°ll√≠tjuk
            if (currentDistToStart < 0.1) {
                targetPos.lat = userStartPos.lat;
                targetPos.lon = userStartPos.lon;
                return;
            }

            // Kisz√°m√≠tjuk a c√©lpont √∫j poz√≠ci√≥j√°t
            const newPos = calculateTargetPosition(targetPos.lat, targetPos.lon, distanceMoved, targetDirection);
            targetPos.lat = newPos.lat;
            targetPos.lon = newPos.lon;
        }

        // --- 4. GPS poz√≠ci√≥ friss√≠t√©se √©s f≈ë logika ---
        function updatePosition(position) {
            const userLat = position.coords.latitude;
            const userLon = position.coords.longitude;
            const userCoords = [userLat, userLon];

            document.getElementById('status-info').textContent = `Aktu√°lis poz√≠ci√≥d: ${userLat.toFixed(5)}, ${userLon.toFixed(5)}`;

            if (!trackingStarted) {
                // Kezdeti be√°ll√≠t√°sok (csak egyszer fut le)
                userStartPos = { lat: userLat, lon: userLon };
                setupTarget(userLat, userLon); // C√©lpont 50m-re a kezdeti poz√≠ci√≥dt√≥l
                trackingStarted = true;
                
                // T√©rk√©p inicializ√°l√°sa
                map = L.map('map').setView(userCoords, 17);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);

                // Felhaszn√°l√≥ jel√∂l≈ë (piros)
                userMarker = L.marker(userCoords, { title: "Poz√≠ci√≥d" }).addTo(map)
                    .bindPopup("Jelenlegi poz√≠ci√≥d").openPopup();
                
                // C√©lpont jel√∂l≈ë (k√©k)
                targetMarker = L.marker([targetPos.lat, targetPos.lon], { title: "Mozg√≥ C√©lpont" }).addTo(map)
                    .bindPopup("Mozg√≥ C√©lpont (50m-r≈ël indul)").openPopup();
            }

            // 1. C√©lpont mozgat√°sa
            moveTarget();

            // 2. T√°vols√°g sz√°m√≠t√°sa: C√©lpont aktu√°lis poz√≠ci√≥ja √âS a Te aktu√°lis poz√≠ci√≥d k√∂z√∂tt
            const distance = calculateDistance(userLat, userLon, targetPos.lat, targetPos.lon);
            const formattedDistance = distance.toFixed(1);

            // 3. T√©rk√©p √©s jel√∂l≈ëk friss√≠t√©se
            userMarker.setLatLng(userCoords);
            targetMarker.setLatLng([targetPos.lat, targetPos.lon]);
            map.setView(userCoords, map.getZoom()); 

            document.getElementById('distance-info').innerHTML = 
                `T√°vols√°g a c√©lpontt√≥l: **${formattedDistance} m** (Sebess√©g: ${TARGET_SPEED_KPH} km/h)`;

            // 4. √Åtir√°ny√≠t√°si logika
            if (distance <= REDIRECT_RADIUS_METERS) {
                document.getElementById('distance-info').innerHTML = `<span class="distance-warning">10 m√©teren bel√ºl! √Åtir√°ny√≠t√°s...</span>`;
                // window.location.href = REDIRECT_URL; // √âles √°tir√°ny√≠t√°s
                console.log(`√Åtir√°ny√≠t√°s a ${REDIRECT_URL} c√≠mre (${distance.toFixed(1)}m)!`);
                alert(`√Åtir√°ny√≠t√°s a ${REDIRECT_URL} c√≠mre (${distance.toFixed(1)}m)!`);
                navigator.geolocation.clearWatch(watchId); // Le√°ll√≠tjuk a GPS k√∂vet√©st
            }

            console.log(`Poz√≠ci√≥ friss√≠tve: ${userLat.toFixed(5)}, C√©lpont: ${targetPos.lat.toFixed(5)}. T√°vols√°g: ${formattedDistance} m`);
        }

        // --- 5. Hiba kezel√©se √©s Ind√≠t√°s ---
        function errorCallback(error) {
            let message = "Hiba a GPS-szel! K√©rlek enged√©lyezd a helymeghat√°roz√°st √©s pr√≥b√°lj √∫jra.";
            document.getElementById('status-info').innerHTML = `<span class="distance-warning">${message}</span>`;
            console.error("GPS Hiba:", error);
        }
        
        // F≈ë ind√≠t√°si logika
        let watchId;
        if ("geolocation" in navigator) {
            const options = { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 };
            watchId = navigator.geolocation.watchPosition(updatePosition, errorCallback, options);
            // Az 5 m√°sodpercenk√©nti friss√≠t√©st a b√∂ng√©sz≈ë a watchPosition h√≠v√°ssal igyekszik tartani.
        } else {
            document.getElementById('status-info').innerHTML = `<span class="distance-warning">A b√∂ng√©sz≈ë nem t√°mogatja a helymeghat√°roz√°st.</span>`;
        }
    </script>

</body>
</html>
