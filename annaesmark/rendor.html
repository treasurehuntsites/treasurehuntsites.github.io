<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>GPS K√∂vet√©s Mozg√≥ C√©lponttal & K√∂r√∂kkel</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAo9T0XLYJk976X4UaT68Q8z16jB22p2D30T4uY="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-2qE2C2b2r2A60k52J67B547w379xM9M3r50Lq7v8i7Q="
            crossorigin=""></script>

    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; }
        h1 { color: #333; }
        p { color: #555; }
        #map { 
            height: 600px; 
            width: 80%; 
            margin: 20px auto; 
            border: 1px solid #ccc; 
            border-radius: 8px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .info-box {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 15px;
            max-width: 80%;
            margin-left: auto;
            margin-right: auto;
        }
        .distance-info { font-size: 1.2em; font-weight: bold; color: #007bff; }
        .distance-warning { color: red; font-weight: bold; }
        .status-info { color: #666; }

        /* Custom icons for better visibility */
        .leaflet-marker-icon.user-icon {
            background-color: red;
            border-radius: 50%;
            border: 2px solid white;
            width: 20px !important;
            height: 20px !important;
            margin-left: -10px !important;
            margin-top: -10px !important;
        }
        .leaflet-marker-icon.target-icon {
            background-color: blue;
            border-radius: 50%;
            border: 2px solid white;
            width: 20px !important;
            height: 20px !important;
            margin-left: -10px !important;
            margin-top: -10px !important;
        }
    </style>
</head>
<body>

    <h1>üöÄ GPS K√∂vet√©s & Mozg√≥ C√©lpont</h1>
    <p>A t√©rk√©pen l√°thatod a kezdeti poz√≠ci√≥dat, a mozg√≥ c√©lpontot, √©s 5 m√©terenk√©nti k√∂r√∂ket.</p>
    
    <div class="info-box">
        <div id="status-info" class="status-info">V√°rjuk a GPS poz√≠ci√≥t...</div>
        <div id="distance-info" class="distance-info"></div>
    </div>

    <div id="map"></div>

    <script>
        // --- 1. Konfigur√°ci√≥ ---
        const REDIRECT_URL = "https://www.google.com";
        const START_DISTANCE_METERS = 50;      // C√©lpont kezdeti t√°vols√°ga a kiindul√≥pontt√≥l
        const REDIRECT_RADIUS_METERS = 10;      // √Åtir√°ny√≠t√°si k√ºsz√∂b
        const TARGET_SPEED_KPH = 5;             // C√©lpont sebess√©ge 5 km/h
        const UPDATE_INTERVAL_MS = 5000;        // GPS friss√≠t√©si gyakoris√°g (5 m√°sodperc)
        const CIRCLE_INTERVAL_METERS = 5;       // K√∂r√∂k k√∂z√∂tti t√°vols√°g
        const MAX_CIRCLE_RADIUS = 50;           // Maxim√°lis k√∂r sugara
        
        // Sebess√©g m/ms-ban: 5 km/h = 5000 m / 3600 s * 1000 ms = 0.001388... m/ms
        const TARGET_SPEED_MPS = TARGET_SPEED_KPH * 1000 / 3600; 

        // √Ållapotv√°ltoz√≥k
        let map;
        let userStartPos = null;    // A felhaszn√°l√≥ kezdeti poz√≠ci√≥ja
        let userMarker;             // Felhaszn√°l√≥ aktu√°lis poz√≠ci√≥j√°nak jel√∂l≈ëje
        let startPointMarker;       // A kiindul√≥ poz√≠ci√≥ jel√∂l≈ëje (fix)
        let targetPos = null;       // A c√©lpont aktu√°lis poz√≠ci√≥ja
        let targetMarker;           // C√©lpont jel√∂l≈ëje
        let lastTargetUpdateTime = Date.now();
        let targetDirection;        // Ir√°ny a c√©lpont mozgat√°s√°hoz (bearing)
        let trackingStarted = false;
        let circles = [];           // A k√∂r√∂k t√°rol√°sa

        // Egyedi ikonok
        const userIcon = L.divIcon({ className: 'user-icon' });
        const targetIcon = L.divIcon({ className: 'target-icon' });
        const startPointIcon = L.divIcon({ 
            className: 'start-point-icon', 
            html: '<div style="background-color: green; border-radius: 50%; border: 2px solid white; width: 20px; height: 20px;"></div>',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });

        // --- 2. Geometriai f√ºggv√©nyek ---

        // Konvert√°l√°s radi√°nra √©s fokra
        function toRad(deg) { return deg * (Math.PI / 180); }
        function toDeg(rad) { return rad * (180 / Math.PI); }

        // Haversine t√°vols√°gsz√°m√≠t√°s (m√©terben)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // Pont sz√°m√≠t√°sa t√°vols√°gra √©s ir√°nyra (bearing) egy m√°sik pontt√≥l
        function calculateNewPosition(lat, lon, distanceMeters, bearing) {
            const R = 6371e3;
            const dist = distanceMeters / R;
            const brng = toRad(bearing);

            const lat1 = toRad(lat);
            const lon1 = toRad(lon);

            let lat2 = Math.asin(Math.sin(lat1) * Math.cos(dist) +
                                 Math.cos(lat1) * Math.sin(dist) * Math.cos(brng));
            let lon2 = lon1 + Math.atan2(Math.sin(brng) * Math.sin(dist) * Math.cos(lat1),
                                          Math.cos(dist) - Math.sin(lat1) * Math.sin(lat2));

            return { lat: toDeg(lat2), lon: toDeg(lon2) };
        }

        // K√©t pont k√∂z√∂tti ir√°ny sz√°m√≠t√°sa (bearing fokban)
        function calculateBearing(lat1, lon1, lat2, lon2) {
            const y = Math.sin(toRad(lon2 - lon1)) * Math.cos(toRad(lat2));
            const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
                      Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(toRad(lon2 - lon1));
            return (toDeg(Math.atan2(y, x)) + 360) % 360;
        }

        // --- 3. T√©rk√©p Rajzol√≥ F√ºggv√©nyek ---

        // K√∂r√∂k rajzol√°sa a kezdeti poz√≠ci√≥ k√∂r√ºl
        function drawCircles(centerLat, centerLon) {
            // El≈ësz√∂r t√∂r√∂lj√ºk a r√©gi k√∂r√∂ket
            circles.forEach(circle => map.removeLayer(circle));
            circles = [];

            for (let r = CIRCLE_INTERVAL_METERS; r <= MAX_CIRCLE_RADIUS; r += CIRCLE_INTERVAL_METERS) {
                const circle = L.circle([centerLat, centerLon], {
                    color: 'purple',
                    fillColor: '#f03',
                    fillOpacity: 0.05,
                    radius: r
                }).addTo(map);
                circles.push(circle);
            }
             // √Åtir√°ny√≠t√°si z√≥na (10m-es k√∂r)
             const redirectCircle = L.circle([centerLat, centerLon], {
                color: 'red',
                fillColor: 'red',
                fillOpacity: 0.1,
                radius: REDIRECT_RADIUS_METERS,
                dashArray: '5, 5' // Szaggatott vonal
            }).addTo(map);
            circles.push(redirectCircle);
        }

        // --- 4. C√©lpont Mozgat√≥ √©s Kezd≈ë Poz√≠ci√≥ Be√°ll√≠t√≥ F√ºggv√©nyek ---

        // C√©lpont kezdeti poz√≠ci√≥j√°nak be√°ll√≠t√°sa (50m-re a felhaszn√°l√≥t√≥l)
        function setupTarget(userLat, userLon) {
            const randomBearing = Math.random() * 360; 
            
            // Kisz√°m√≠tjuk a c√©lpont kezd≈ë poz√≠ci√≥j√°t 50m-re a userStartPos-t√≥l
            targetPos = calculateNewPosition(userLat, userLon, START_DISTANCE_METERS, randomBearing);
            
            // Kisz√°m√≠tjuk azt az ir√°nyt, amerre a c√©lpontnak mozognia kell (a userStartPos fel√©)
            targetDirection = calculateBearing(targetPos.lat, targetPos.lon, userLat, userLon);
            
            lastTargetUpdateTime = Date.now();
            console.log(`C√©lpont kezdeti poz√≠ci√≥ja (${START_DISTANCE_METERS}m-re) be√°ll√≠tva. Ir√°ny: ${targetDirection.toFixed(2)} fok.`);
        }

        // C√©lpont mozgat√°sa (a userStartPos fel√©)
        function moveTarget() {
            const now = Date.now();
            const deltaTimeMs = now - lastTargetUpdateTime;
            lastTargetUpdateTime = now;

            const distanceMoved = TARGET_SPEED_MPS * (deltaTimeMs / 1000); 

            let currentDistToStart = calculateDistance(targetPos.lat, targetPos.lon, userStartPos.lat, userStartPos.lon);
            
            if (currentDistToStart < 0.1) { // Ha m√°r nagyon k√∂zel van a c√©lponthoz
                targetPos.lat = userStartPos.lat;
                targetPos.lon = userStartPos.lon;
                return;
            }

            const newPos = calculateNewPosition(targetPos.lat, targetPos.lon, distanceMoved, targetDirection);
            targetPos.lat = newPos.lat;
            targetPos.lon = newPos.lon;
        }

        // --- 5. GPS poz√≠ci√≥ friss√≠t√©se √©s f≈ë logika ---
        function updatePosition(position) {
            const userLat = position.coords.latitude;
            const userLon = position.coords.longitude;
            const userCoords = [userLat, userLon];

            document.getElementById('status-info').textContent = `Aktu√°lis poz√≠ci√≥d: ${userLat.toFixed(5)}, ${userLon.toFixed(5)}`;

            if (!trackingStarted) {
                // Kezdeti be√°ll√≠t√°sok (csak egyszer fut le)
                userStartPos = { lat: userLat, lon: userLon };
                setupTarget(userLat, userLon); 
                trackingStarted = true;
                
                // T√©rk√©p inicializ√°l√°sa
                map = L.map('map').setView(userCoords, 17);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);

                // Kezd≈ëpont jel√∂l≈ë (fix, z√∂ld)
                startPointMarker = L.marker([userStartPos.lat, userStartPos.lon], { icon: startPointIcon, title: "Kezdeti Poz√≠ci√≥d" }).addTo(map)
                    .bindPopup("Ez a kezdeti poz√≠ci√≥d (fix)").openPopup();

                // Felhaszn√°l√≥ aktu√°lis poz√≠ci√≥j√°nak jel√∂l≈ëje (piros)
                userMarker = L.marker(userCoords, { icon: userIcon, title: "Jelenlegi Poz√≠ci√≥d" }).addTo(map)
                    .bindPopup("Jelenlegi poz√≠ci√≥d").openPopup();
                
                // C√©lpont jel√∂l≈ë (k√©k)
                targetMarker = L.marker([targetPos.lat, targetPos.lon], { icon: targetIcon, title: "Mozg√≥ C√©lpont" }).addTo(map)
                    .bindPopup("Mozg√≥ C√©lpont (50m-r≈ël indul fel√©d)").openPopup();

                // K√∂r√∂k rajzol√°sa a kezdeti poz√≠ci√≥ k√∂r√ºl
                drawCircles(userStartPos.lat, userStartPos.lon);

            }

            // 1. C√©lpont mozgat√°sa
            moveTarget();

            // 2. T√°vols√°g sz√°m√≠t√°sa: C√©lpont aktu√°lis poz√≠ci√≥ja √âS a Te aktu√°lis poz√≠ci√≥d k√∂z√∂tt
            const distance = calculateDistance(userLat, userLon, targetPos.lat, targetPos.lon);
            const formattedDistance = distance.toFixed(1);

            // 3. T√©rk√©p √©s jel√∂l≈ëk friss√≠t√©se
            userMarker.setLatLng(userCoords);
            targetMarker.setLatLng([targetPos.lat, targetPos.lon]);
            map.setView(userCoords, map.getZoom()); // R√°k√∂zepel√©s a felhaszn√°l√≥ra

            document.getElementById('distance-info').innerHTML = 
                `T√°vols√°g a c√©lpontt√≥l: **${formattedDistance} m** (C√©lpont sebess√©ge: ${TARGET_SPEED_KPH} km/h)`;

            // 4. √Åtir√°ny√≠t√°si logika
            if (distance <= REDIRECT_RADIUS_METERS) {
                document.getElementById('distance-info').innerHTML = `<span class="distance-warning">10 m√©teres k√∂rzetbe √©rt a c√©lpont! √Åtir√°ny√≠t√°s...</span>`;
                // window.location.href = REDIRECT_URL; // √âles √°tir√°ny√≠t√°s
                console.log(`√Åtir√°ny√≠t√°s a ${REDIRECT_URL} c√≠mre (${distance.toFixed(1)}m)!`);
                alert(`√Åtir√°ny√≠t√°s a ${REDIRECT_URL} c√≠mre (${distance.toFixed(1)}m)!`);
                navigator.geolocation.clearWatch(watchId); // Le√°ll√≠tjuk a GPS k√∂vet√©st
            }

            console.log(`Poz√≠ci√≥ friss√≠tve: ${userLat.toFixed(5)}, C√©lpont: ${targetPos.lat.toFixed(5)}. T√°vols√°g: ${formattedDistance} m`);
        }

        // --- 6. Hiba kezel√©se √©s Ind√≠t√°s ---
        function errorCallback(error) {
            let message = "Hiba a GPS-szel! K√©rlek enged√©lyezd a helymeghat√°roz√°st √©s pr√≥b√°lj √∫jra.";
            document.getElementById('status-info').innerHTML = `<span class="distance-warning">${message}</span>`;
            console.error("GPS Hiba:", error);
        }
        
        let watchId;
        if ("geolocation" in navigator) {
            const options = { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 };
            watchId = navigator.geolocation.watchPosition(updatePosition, errorCallback, options);
        } else {
            document.getElementById('status-info').innerHTML = `<span class="distance-warning">A b√∂ng√©sz≈ë nem t√°mogatja a helymeghat√°roz√°st.</span>`;
        }
    </script>

</body>
</html>
