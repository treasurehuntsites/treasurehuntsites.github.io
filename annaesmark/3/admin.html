<!doctype html>
<html lang="hu">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=10.0">
    <title>Játék Konfiguráció V3.1 (Reset)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #1a1a1a; color: #e0e0e0; }
        .card { background-color: #2c2c2c; border: 2px solid #8a2be2; box-shadow: 0 0 20px rgba(138, 43, 226, 0.4); }
        .input-style { background-color: #3f3f46; color: #00ffff; border: 1px solid #6b7280; }
        .btn-primary { background-color: #8a2be2; color: white; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #7b1cd1; }
        .btn-secondary { background-color: #00ffff; color: #1a1a1a; font-weight: bold; transition: background-color 0.2s; }
        .btn-secondary:hover { background-color: #00ddee; }
        .btn-add { background-color: #007bff; color: white; transition: background-color 0.2s; }
        .btn-add:hover { background-color: #0069d9; }
        .btn-danger { background-color: #dc3545; color: white; transition: background-color 0.2s; }
        .btn-danger:hover { background-color: #c82333; }
        .btn-reset { background-color: #ff5733; color: white; transition: background-color 0.2s; }
        .btn-reset:hover { background-color: #c70039; }
        .hidden { display: none; }
        
        /* Preview specifikus stílusok */
        .game-preview-box {
            background-color: rgba(0, 0, 0, 0.85);
            border: 2px solid #8a2be2;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            position: relative;
            color: #e0e0e0;
            font-family: 'Play', sans-serif; /* Játék fontja */
            background-size: cover;
            background-position: center;
        }
        .preview-avatar {
            width: 60px; height: 60px; border-radius: 50%; border: 2px solid #00ffff;
            object-fit: cover; margin-right: 15px;
        }
        .preview-btn {
            background-color: #8a2be2; color: white; padding: 8px 16px; 
            border-radius: 4px; font-weight: bold; text-transform: uppercase;
            font-size: 0.8rem; margin: 2px;
        }

        /* 5 gombos elrendezés segítése kis képernyőn */
        @media (min-width: 640px) {
            .btn-group-5 > * {
                width: calc(20% - 0.5rem); /* 20% mínusz a gap egy része */
            }
            .btn-group-5 {
                justify-content: space-between;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">
    <div class="max-w-4xl mx-auto space-y-8">
        <h1 class="text-4xl font-bold text-center text-white mb-6">Részletes Játék Konfiguráció V3.1</h1>

        <!-- ÁLTALÁNOS BEÁLLÍTÁSOK -->
        <div class="card p-6 rounded-xl space-y-6">
            <h2 class="text-2xl font-semibold text-white border-b border-gray-600 pb-2">Általános Beállítások</h2>
            
            <div>
                <label for="appTitle" class="block text-sm font-medium text-gray-300 mb-1">Weboldal Címe (Title)</label>
                <input type="text" id="appTitle" class="input-style w-full p-3 rounded-lg focus:ring-purple-500 focus:border-purple-500" placeholder="Pl.: Anna és Márk Kincskeresés">
            </div>

            <div>
                <label for="backgroundUrl" class="block text-sm font-medium text-gray-300 mb-1">Alapértelmezett Háttérkép URL (Global)</label>
                <input type="url" id="backgroundUrl" class="input-style w-full p-3 rounded-lg focus:ring-purple-500 focus:border-purple-500" placeholder="https://...">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="bgColor" class="block text-sm font-medium text-gray-300 mb-1">Háttér Színe (CSS)</label>
                    <input type="color" id="bgColor" class="input-style w-full h-12 rounded-lg" value="#1a1a1a">
                </div>
                <div>
                    <label for="textColor" class="block text-sm font-medium text-gray-300 mb-1">Szöveg Színe (CSS)</label>
                    <input type="color" id="textColor" class="input-style w-full h-12 rounded-lg" value="#e0e0e0">
                </div>
            </div>
        </div>
        
        <!-- AVATAR BEÁLLÍTÁSOK -->
        <div class="card p-6 rounded-xl space-y-4">
            <h2 class="text-2xl font-semibold text-white border-b border-gray-600 pb-2">Avatar Képek Beállítása</h2>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div>
                    <label for="avatarMUrl" class="block text-sm font-medium text-gray-300 mb-1">Márk (§M) Avatar URL</label>
                    <input type="url" id="avatarMUrl" class="input-style w-full p-3 rounded-lg" placeholder="https://.../mark.png">
                </div>
                <div>
                    <label for="avatarAUrl" class="block text-sm font-medium text-gray-300 mb-1">Anna (§A) Avatar URL</label>
                    <input type="url" id="avatarAUrl" class="input-style w-full p-3 rounded-lg" placeholder="https://.../anna.png">
                </div>
                <div>
                    <label for="avatarRUrl" class="block text-sm font-medium text-gray-300 mb-1">Rendőr/Egyéb (§R) Avatar URL</label>
                    <input type="url" id="avatarRUrl" class="input-style w-full p-3 rounded-lg" placeholder="https://.../rendor.png">
                </div>
            </div>
            <div>
                <label for="avatarDefaultUrl" class="block text-sm font-medium text-gray-300 mb-1">Alapértelmezett (Narrátor) Avatar URL</label>
                <input type="url" id="avatarDefaultUrl" class="input-style w-full p-3 rounded-lg" placeholder="https://placehold.co/70x70/1A1A1A/FFFFFF?text=?">
            </div>
        </div>
        
        <!-- MENÜ/GPS BEÁLLÍTÁSOK -->
        <div class="card p-6 rounded-xl space-y-6">
            <h2 class="text-2xl font-semibold text-white border-b border-gray-600 pb-2">Menü és GPS Beállítások</h2>
            
            <div>
                <label for="menuMapLink" class="block text-sm font-medium text-gray-300 mb-1">Menü Térkép Linkje (Fő Térkép)</label>
                <input type="url" id="menuMapLink" class="input-style w-full p-3 rounded-lg focus:ring-cyan-500 focus:border-cyan-500" placeholder="https://maps.google.com/...">
            </div>

            <h3 class="text-xl font-medium text-gray-200 mt-6">Célpont Keresése (GPS)</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="targetLat" class="block text-sm font-medium text-gray-300 mb-1">Célpont Szélesség (Lat)</label>
                    <input type="text" id="targetLat" class="input-style w-full p-3 rounded-lg" placeholder="47.47407">
                </div>
                <div>
                    <label for="targetLon" class="block text-sm font-medium text-gray-300 mb-1">Célpont Hosszúság (Lon)</label>
                    <input type="text" id="targetLon" class="input-style w-full p-3 rounded-lg" placeholder="19.04001">
                </div>
                <div>
                    <label for="successRedirectUrl" class="block text-sm font-medium text-gray-300 mb-1">Siker Átirányítás URL</label>
                    <input type="text" id="successRedirectUrl" class="input-style w-full p-3 rounded-lg" placeholder="busz.html">
                </div>
            </div>
            
            <div>
                <label for="gpsMapLink" class="block text-sm font-medium text-gray-300 mb-1">Végpont Keresése Térkép Link (GPS Modal)</label>
                <input type="url" id="gpsMapLink" class="input-style w-full p-3 rounded-lg focus:ring-cyan-500 focus:border-cyan-500" placeholder="https://maps.google.com/...">
            </div>
        </div>
        
        <!-- TÖRTÉNET SZERKESZTÉSE OLDALANKÉNT -->
        <div class="card p-6 rounded-xl space-y-6">
            <h2 class="text-2xl font-semibold text-white border-b border-gray-600 pb-2">Történet Szöveg Szerkesztése</h2>

            <!-- MÓDOSÍTOTT ELRENDEZÉS: Teljes szélességű Index Select és alatta Page Type Select -->
            <div class="space-y-4">
                <div class="space-y-1">
                    <label for="storyPageIndex" class="block text-sm font-medium text-gray-300 mb-1">Oldal kiválasztása (Index)</label>
                    <div class="flex gap-2">
                        <!-- Az eseménykezelő a JS-ben biztosítja az egykattintásos váltást. -->
                        <select id="storyPageIndex" class="input-style w-full p-3 rounded-lg text-base flex-grow"></select>
                        <button id="deletePageButton" class="btn-danger p-3 rounded-lg w-12 flex items-center justify-center" title="Aktuális oldal törlése">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">Összesen: <span id="pageCount">?</span> oldal.</p>
                </div>
                <div>
                    <label for="pageType" class="block text-sm font-medium text-gray-300 mb-1">Oldal típusa</label>
                    <select id="pageType" class="input-style w-full p-3 rounded-lg text-base">
                        <option value="text">Szöveg / Párbeszéd</option>
                        <option value="audio">Audio Lejátszás (Gomb)</option>
                        <option value="password">Jelszó Kérése</option>
                        <option value="choice">Elágazás (Választás)</option>
                    </select>
                </div>
            </div>
            
            <!-- ÁLTALÁNOS TARTALOM BLOKK -->
            <div id="textBlock">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                         <label for="customAvatarUrl" class="block text-sm font-medium text-green-400 mb-1">Egyedi Avatar URL (Ehhez az oldalhoz)</label>
                         <input type="url" id="customAvatarUrl" class="input-style w-full p-3 rounded-lg" placeholder="https://... (Üres = alapértelmezett)">
                    </div>
                    <div>
                         <label for="customBackgroundUrl" class="block text-sm font-medium text-yellow-400 mb-1">Egyedi Háttér URL (Ehhez az oldalhoz)</label>
                         <input type="url" id="customBackgroundUrl" class="input-style w-full p-3 rounded-lg" placeholder="https://... (Üres = előző háttér marad)">
                    </div>
                </div>
                
                <!-- ÚJ GALÉRIA MEZŐK (Több URL-t engedélyező textarea) -->
                <div class="mb-4 bg-gray-700/30 p-4 rounded-lg border border-pink-500/30">
                    <label class="block text-sm font-medium text-pink-400 mb-2">Galéria Kezelése</label>
                    <div class="flex gap-2">
                        <div class="w-2/3">
                             <textarea id="customGalleryUrl" rows="3" class="input-style w-full p-3 rounded-lg" placeholder="https://... (URL-ek, soronként egy)"></textarea>
                        </div>
                        <div class="w-1/3">
                            <select id="galleryMode" class="input-style w-full p-3 rounded-lg font-bold">
                                <option value="add_url">Kép hozzáadása (akkumulál)</option>
                                <option value="remove_url">Kép eltávolítása</option>
                                <option value="clear">Galéria ürítése</option>
                            </select>
                        </div>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">Add meg a kép URL(ek)et, soronként egyet. A hozzáadás/eltávolítás a listában szereplő összes URL-re vonatkozik.</p>
                </div>

                <div>
                    <label for="pageContent" class="block text-sm font-medium text-gray-300 mb-1">Oldal Szövege (Pl. §M Szia, Márk vagyok.)</label>
                    <textarea id="pageContent" rows="5" class="input-style w-full p-3 rounded-lg" placeholder="Pl.: §A Megvizsgáljuk a helyszínt. A szöveg elején lévő §X jelöli a beszélőt."></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <div>
                        <label for="nextIndex" class="block text-sm font-medium text-gray-300 mb-1">Ugrás Index (Next Index)</label>
                        <input type="number" id="nextIndex" class="input-style w-full p-3 rounded-lg" placeholder="Automatikus ha üres">
                    </div>
                    <div>
                        <label for="backIndex" class="block text-sm font-medium text-gray-300 mb-1">Vissza Index (Back Index)</label>
                        <input type="number" id="backIndex" class="input-style w-full p-3 rounded-lg" placeholder="Vissza ugrás indexe">
                    </div>
                </div>
            </div>

            <!-- AUDIO SPECIFIKUS BLOKK -->
            <div id="audioBlock" class="border border-cyan-500 p-4 rounded-lg bg-cyan-900/30 hidden space-y-4">
                 <p class="text-sm font-bold text-cyan-300">AUDIO BEÁLLÍTÁSOK</p>
                 <div>
                    <label for="audioId" class="block text-sm font-medium text-gray-300 mb-1">Audio Fájl kiválasztása</label>
                    <select id="audioId" class="input-style w-full p-3 rounded-lg text-base">
                        <option value="1">Audio 1</option>
                        <option value="2">Audio 2</option>
                    </select>
                </div>
                <div>
                    <label for="audioNextButtonText" class="block text-sm font-medium text-gray-300 mb-1">Tovább Gomb Szövege</label>
                    <input type="text" id="audioNextButtonText" class="input-style w-full p-3 rounded-lg" placeholder="Pl.: Megvizsgálom a fülkét">
                </div>
            </div>

            <!-- JELSZÓ SPECIFIKUS BLOKK -->
            <div id="passwordBlock" class="border border-red-500 p-4 rounded-lg bg-red-900/30 hidden space-y-4">
                <p class="text-sm font-bold text-red-300">JELSZÓ KÉRÉS BEÁLLÍTÁSAI</p>
                <div>
                    <label for="correctPassword" class="block text-sm font-medium text-gray-300 mb-1">Helyes Kód / Jelszó</label>
                    <input type="text" id="correctPassword" class="input-style w-full p-3 rounded-lg" placeholder="1940">
                </div>
                <div>
                    <label for="nextIndexSuccess" class="block text-sm font-medium text-gray-300 mb-1">Siker Ugrás Indexe (használj -1-et a GPS-hez)</label>
                    <input type="number" id="nextIndexSuccess" class="input-style w-full p-3 rounded-lg" placeholder="-1 (GPS) vagy Index (pl. 20)">
                </div>
                
                <!-- ÚJ SÚGÓ ÜZENETEK -->
                <div>
                    <label for="passwordHelpMessage" class="block text-sm font-medium text-gray-300 mb-1">Segítség Üzenet(ek) (Soronként egy üzenet a súgó gombhoz)</label>
                    <textarea id="passwordHelpMessage" rows="3" class="input-style w-full p-3 rounded-lg" placeholder="Pl.: Keresd a megoldást a falon. (Ez lesz az 1. segítség)"></textarea>
                </div>

                <div class="mt-4">
                    <label for="passwordPromptText" class="block text-sm font-medium text-gray-300 mb-1">Kódkérő Prompt Szöveg (Globális)</label>
                    <input type="text" id="passwordPromptText" class="input-style w-full p-3 rounded-lg" placeholder="Add meg a kódot:">
                </div>
            </div>

            <!-- ELÁGAZÁS (CHOICE) SPECIFIKUS BLOKK -->
            <div id="choiceBlock" class="border border-green-500 p-4 rounded-lg bg-green-900/30 hidden space-y-4">
                <p class="text-sm font-bold text-green-300 uppercase">Elágazás Beállítások (Max 4 gomb)</p>
                <div id="choicesContainer" class="space-y-3">
                    <!-- Itt jelennek meg dinamikusan a választási sorok -->
                </div>
                <button id="addChoiceBtn" class="btn-secondary w-full p-3 rounded-lg text-sm uppercase font-bold">
                    <i class="fa-solid fa-plus mr-2"></i> Új választási gomb hozzáadása
                </button>
                <p class="text-xs text-gray-400">Add meg a gomb feliratát és hogy hanyadik oldalra ugorjon (Index).</p>
            </div>
            
            <!-- MÉDIA URL-ek -->
            <h2 class="text-2xl font-semibold text-white border-b border-gray-600 pb-2 mt-6">Audio Média URL-ek</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="audio1Url" class="block text-sm font-medium text-gray-300 mb-1">Audio 1 URL</label>
                    <input type="url" id="audio1Url" class="input-style w-full p-3 rounded-lg" placeholder="https://.../Ugynokok1.mp3">
                </div>
                <div>
                    <label for="audio2Url" class="block text-sm font-medium text-gray-300 mb-1">Audio 2 URL</label>
                    <input type="url" id="audio2Url" class="input-style w-full p-3 rounded-lg" placeholder="https://.../Ugynokok2.mp3">
                </div>
            </div>

            <button id="addPageButton" class="btn-add w-full p-4 rounded-xl text-lg font-bold uppercase mt-6">
                <i class="fa-solid fa-plus mr-2"></i> Új oldal hozzáadása a történethez
            </button>
            
            <!-- ELŐNÉZET (PREVIEW) KONTÉNER -->
            <div id="previewContainer"></div>
            
        </div>
        
        <!-- GOMBOK: Mentés, Törlés, Preview, Import, Export -->
        <div class="flex flex-col sm:flex-row justify-between gap-4 pt-4 btn-group-5">
            <button id="saveButton" class="btn-primary w-full sm:w-1/5 p-4 rounded-xl text-lg font-bold uppercase">
                <i class="fa-solid fa-floppy-disk mr-2"></i> Mentés
            </button>
            <button id="resetButton" class="btn-reset w-full sm:w-1/5 p-4 rounded-xl text-lg font-bold uppercase">
                <i class="fa-solid fa-arrows-rotate mr-2"></i> Összes Törlése
            </button>
            <a id="goToGameButton" href="preview.html" target="_blank" class="btn-secondary w-full sm:w-1/5 p-4 rounded-xl text-lg font-bold uppercase text-center flex items-center justify-center">
                <i class="fa-solid fa-eye mr-2"></i> Preview
            </a>
            <!-- IMPORT GOMB -->
            <button id="loadConfigButton" class="bg-blue-600 hover:bg-blue-700 text-white w-full sm:w-1/5 p-4 rounded-xl text-lg font-bold uppercase text-center flex items-center justify-center transition-colors">
                <i class="fa-solid fa-upload mr-2"></i> Import
            </button>
            <!-- EXPORT GOMB -->
            <button id="downloadPageButton" class="bg-pink-600 hover:bg-pink-700 text-white w-full sm:w-1/5 p-4 rounded-xl text-lg font-bold uppercase text-center flex items-center justify-center transition-colors">
                <i class="fa-solid fa-download mr-2"></i> Export
            </button>
        </div>
        
        <!-- HIDDEN FILE INPUT az Importáláshoz -->
        <input type="file" id="fileInput" accept="application/json" class="hidden">

        <p id="message" class="text-center mt-4 text-xl font-bold"></p>
    </div>

    <script>
        // Az adminisztrációs logika
        (function() {
            const STORAGE_KEY = 'DYNAMIC_CONFIG';
            const MESSAGE_DISPLAY = document.getElementById('message');
            const goToGameButton = document.getElementById('goToGameButton');
            let currentStoryPages = [];
            let currentLoadedIndex = 0; 
            let isInitialLoad = true; // ÚJ: Flag a kezdeti betöltés jelzésére

            // DOM elemek
            const fields = {
                appTitle: document.getElementById('appTitle'), backgroundUrl: document.getElementById('backgroundUrl'), bgColor: document.getElementById('bgColor'), textColor: document.getElementById('textColor'),
                avatarMUrl: document.getElementById('avatarMUrl'), avatarAUrl: document.getElementById('avatarAUrl'), avatarRUrl: document.getElementById('avatarRUrl'), avatarDefaultUrl: document.getElementById('avatarDefaultUrl'),
                menuMapLink: document.getElementById('menuMapLink'), targetLat: document.getElementById('targetLat'), targetLon: document.getElementById('targetLon'), successRedirectUrl: document.getElementById('successRedirectUrl'), gpsMapLink: document.getElementById('gpsMapLink'),
                audio1Url: document.getElementById('audio1Url'), audio2Url: document.getElementById('audio2Url'),
                storyPageIndex: document.getElementById('storyPageIndex'), pageCount: document.getElementById('pageCount'), pageType: document.getElementById('pageType'), addPageButton: document.getElementById('addPageButton'),
                deletePageButton: document.getElementById('deletePageButton'),
                textBlock: document.getElementById('textBlock'), 
                pageContent: document.getElementById('pageContent'), 
                customAvatarUrl: document.getElementById('customAvatarUrl'),
                customBackgroundUrl: document.getElementById('customBackgroundUrl'),
                customGalleryUrl: document.getElementById('customGalleryUrl'), // Most textarea
                galleryMode: document.getElementById('galleryMode'), 
                nextIndex: document.getElementById('nextIndex'), backIndex: document.getElementById('backIndex'),
                audioBlock: document.getElementById('audioBlock'), audioId: document.getElementById('audioId'), audioNextButtonText: document.getElementById('audioNextButtonText'),
                passwordBlock: document.getElementById('passwordBlock'), passwordPromptText: document.getElementById('passwordPromptText'), correctPassword: document.getElementById('correctPassword'), nextIndexSuccess: document.getElementById('nextIndexSuccess'),
                passwordHelpMessage: document.getElementById('passwordHelpMessage'), // ÚJ MEZŐ
                choiceBlock: document.getElementById('choiceBlock'), choicesContainer: document.getElementById('choicesContainer'), addChoiceBtn: document.getElementById('addChoiceBtn'),
                previewContainer: document.getElementById('previewContainer'),
                resetButton: document.getElementById('resetButton'),
                loadConfigButton: document.getElementById('loadConfigButton'), 
                fileInput: document.getElementById('fileInput')
            };

            // Alapértelmezett konfiguráció
            const DEFAULT_CONFIG = {
                APP_TITLE: "Anna és Márk Kincskeresés (Alapértelmezett)",
                BACKGROUND_URL: "https://treasurehuntsites.github.io/annaesmark/Img/kr.jpg",
                BODY_BG_COLOR: "#1a1a1a", BODY_TEXT_COLOR: "#e0e0e0",
                MENU_LINKS: { MAP_LINK_URL: 'https://www.google.com/maps/d/u/0/viewer?mid=16ShsAj1LaFgeQYGVD8R2Y_ebs50usI8&ll=47.4748758%2C19.039845799999984&z=17' },
                GPS_COMPASS: { TARGET_LATITUDE: 47.47407, TARGET_LONGITUDE: 19.04001, SUCCESS_REDIRECT_URL: "busz.html", MAP_BUTTON_URL: 'https://www.google.com/maps/d/u/0/viewer?mid=1cmPNBkR0t3ozvDgY7056CZiFxf-8d-4&ll=47.47407829999998%2C19.040016799999986&z=17' },
                PASSWORD_PAGE: { PROMPT_TEXT: "Add meg a kódot:", CHECK_BUTTON_TEXT: "ELLENŐRZÉS", BACK_BUTTON_TEXT: "Vissza", ERROR_MESSAGE: 'Helytelen jelszó! Próbáld újra.', SUCCESS_MESSAGE: 'Kód elfogadva!' },
                AVATARS: {
                    DEFAULT_AVATAR_URL: "https://placehold.co/70x70/1A1A1A/FFFFFF?text=?",
                    AVATAR_MAP: { '§M': "https://treasurehuntsites.github.io/annaesmark/Img/mark.png", '§A': "https://treasurehuntsites.github.io/annaesmark/Img/anna.png", '§R': "https://placehold.co/70x70/1A1A1A/00FF00?text=R" },
                    HIDDEN_PREFIXES: ['§N', '§KOD', '§H', '§RESET']
                },
                storyPages: [
                    { type: 'text', content: '§A Márk, azt hiszem megfeletkeztünk valamiről.', customAvatarUrl: "", customBackgroundUrl: "", customGalleryUrl: "", galleryMode: "add_url" }, 
                    { type: 'text', content: '§M Igen? Miről?', customAvatarUrl: "", customBackgroundUrl: "", customGalleryUrl: "", galleryMode: "add_url" }, 
                    { type: 'audio', content: '§N Körner és Rosenberg üzenete: Kérjük, hallgasd meg az első audio üzenetet.', audioId: 1, backIndex: 1, nextButtonText: "Tovább a történetre", customAvatarUrl: "", customBackgroundUrl: "", customGalleryUrl: "", galleryMode: "add_url" }, 
                    { type: 'password', content: '§KOD Kérjük add meg a kódot.', correctPassword: '1940', nextIndexSuccess: -1, backIndex: 2, helpMessage: ['Keresd a megoldást a helyszínen.', '1940'], customAvatarUrl: "", customBackgroundUrl: "", customGalleryUrl: "", galleryMode: "add_url" }, 
                ],
                MEDIA: { AUDIO_1_URL: "https://treasurehuntsites.github.io/media/Ugynokok1.mp3", AUDIO_2_URL: "https://treasurehuntsites.github.io/media/Ugynokok2.mp3" },
            };
            
            // --- AUTOSAVE LOGIKA ---
            
            // Handler function for all field changes: saves data and updates preview
            function autoSaveAndPreviewHandler(event) {
                // Meggyőződünk róla, hogy a módosítás a megfelelő input mezőből jött
                if (event && event.target.tagName === 'INPUT' && event.target.type === 'file') return;
                
                // 1. Mentjük az aktuális oldal adatait az array-be
                // Ezt a hívást eltávolítjuk innen, mert a loadStoryPage(index) vagy a
                // DOMContentLoaded-ban beállított listenerek (storyPageIndex, pageType change)
                // már kezelik a mentést az oldalváltás előtt. Ez az autosave a globális mezőket menti.

                // 2. Mentjük a teljes configot a LocalStorage-ba (automatikusan, sikerüzenet nélkül)
                // saveSettings(false); // Ezt a globális mező változásokra hagyjuk meg.
                
                // 3. Frissítjük az előnézetet
                updatePreview();
            }

            // Function to add auto-save and preview update listener
            function addAutoSaveListener(element, eventType = 'input') {
                if (element) {
                    element.addEventListener(eventType, autoSaveAndPreviewHandler);
                }
            }
            
            // --- PREVIEW LOGIKA ---
            function updatePreview() {
                const content = fields.pageContent.value || '';
                const type = fields.pageType.value;
                const customAvatar = fields.customAvatarUrl.value;
                const customBg = fields.customBackgroundUrl.value;

                const prefix = content.split(' ')[0];
                let avatarUrl = fields.avatarDefaultUrl.value;
                let cleanText = content;

                let isAvatarVisible = true;

                if (customAvatar && customAvatar.trim() !== '') {
                    avatarUrl = customAvatar;
                    if (['§M', '§A', '§R', '§N'].includes(prefix)) {
                        cleanText = content.substring(prefix.length).trim();
                    }
                } else {
                    if(prefix === '§M') { avatarUrl = fields.avatarMUrl.value; cleanText = content.substring(3); }
                    else if(prefix === '§A') { avatarUrl = fields.avatarAUrl.value; cleanText = content.substring(3); }
                    else if(prefix === '§R') { avatarUrl = fields.avatarRUrl.value; cleanText = content.substring(3); }
                    else if(['§N', '§KOD', '§H', '§RESET'].includes(prefix)) { isAvatarVisible = false; cleanText = content.substring(prefix.length).trim(); }
                    else { isAvatarVisible = false; } // Ha nincs prefix
                }

                if (type === 'choice') { isAvatarVisible = false; }


                let buttonsHtml = '';
                if(type === 'choice') {
                    const rows = fields.choicesContainer.querySelectorAll('.choice-row');
                    const btns = Array.from(rows).map(row => {
                        const txt = row.querySelector('.choice-text').value || 'Gomb';
                        return `<button class="preview-btn">${txt}</button>`;
                    });
                    buttonsHtml = `<div class="flex justify-center flex-wrap gap-2">${btns.join('')}</div>`;
                } else if (type === 'audio') {
                    buttonsHtml = `
                        <div class="mb-2 text-cyan-400 text-sm">AUDIO PLAYER (Helyfoglaló)</div>
                        <button class="preview-btn w-full">${fields.audioNextButtonText.value || 'Tovább'}</button>
                    `;
                } else if (type === 'password') {
                     buttonsHtml = `
                        <div class="mb-2 flex gap-2 justify-center">
                            <input disabled placeholder="Kód" class="bg-gray-700 p-1 rounded text-center text-white w-24">
                        </div>
                        <button class="preview-btn bg-cyan-500 text-black w-full">ELLENŐRZÉS</button>
                     `;
                } else {
                    // Mivel a diszkrét Vissza gomb van a felületen, a fő gomb "Tovább"
                    buttonsHtml = `<div class="flex justify-between w-full"><button class="preview-btn opacity-50">Vissza</button><button class="preview-btn">Tovább</button></div>`;
                }

                // Háttér beállítása a preview boxhoz
                let bgStyle = '';
                if (customBg && customBg.trim() !== '') {
                    bgStyle = `background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('${customBg}');`;
                } else if (fields.backgroundUrl.value.trim() !== '') {
                    bgStyle = `background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('${fields.backgroundUrl.value}');`;
                }


                fields.previewContainer.innerHTML = `
                    <div class="game-preview-box" style="${bgStyle}">
                        <div class="absolute top-0 right-0 bg-purple-600 text-xs px-2 py-1 rounded-bl">ELŐNÉZET (Index: ${currentLoadedIndex})</div>
                        <div class="flex items-start" style="padding-top: ${isAvatarVisible ? '30px' : '0'};">
                            <img src="${avatarUrl}" class="preview-avatar" style="display: ${isAvatarVisible ? 'block' : 'none'};" onerror="this.src='https://placehold.co/60?text=?'">
                            <div class="flex-1">
                                <p class="text-lg leading-relaxed whitespace-pre-wrap">${cleanText}</p>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-700/50">
                            ${buttonsHtml}
                        </div>
                    </div>
                `;
            }

            // --- SEGÉDFÜGGVÉNYEK ---

            function populatePageIndexSelector(count, selectIndex = 0) {
                fields.storyPageIndex.innerHTML = '';
                fields.pageCount.textContent = count;
                for (let i = 0; i < count; i++) {
                    const page = currentStoryPages[i];
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `Oldal ${i} (${page.type})`;
                    fields.storyPageIndex.appendChild(option);
                }
                fields.storyPageIndex.value = selectIndex;
            }

            function toggleContentBlocks(pageType) {
                fields.textBlock.classList.add('hidden');
                fields.audioBlock.classList.add('hidden');
                fields.passwordBlock.classList.add('hidden');
                fields.choiceBlock.classList.add('hidden');
                
                if (pageType === 'text') {
                    fields.textBlock.classList.remove('hidden');
                } else if (pageType === 'audio') {
                    fields.textBlock.classList.remove('hidden');
                    fields.audioBlock.classList.remove('hidden');
                } else if (pageType === 'password') {
                    fields.textBlock.classList.remove('hidden');
                    fields.passwordBlock.classList.remove('hidden');
                } else if (pageType === 'choice') {
                    fields.textBlock.classList.remove('hidden');
                    fields.choiceBlock.classList.remove('hidden');
                }
            }

            function renderChoiceRow(text = '', index = '') {
                const row = document.createElement('div');
                row.className = 'choice-row flex gap-2 items-center bg-green-900/40 p-2 rounded';
                row.innerHTML = `
                    <input type="text" class="choice-text input-style w-2/3 p-2 rounded" placeholder="Gomb felirat (pl. Balra)" value="${text}">
                    <input type="number" class="choice-index input-style w-1/4 p-2 rounded" placeholder="Idx" value="${index}">
                    <button class="btn-delete-choice btn-danger p-2 rounded w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-trash"></i></button>
                `;
                
                row.querySelector('.btn-delete-choice').addEventListener('click', () => {
                    row.remove();
                    updateAddChoiceBtnState();
                    autoSaveAndPreviewHandler(); // AutoSave and Preview for deletion
                });

                // Cserélve autoSaveAndPreviewHandler-re
                row.querySelector('.choice-text').addEventListener('input', autoSaveAndPreviewHandler);
                row.querySelector('.choice-index').addEventListener('input', autoSaveAndPreviewHandler);
                
                fields.choicesContainer.appendChild(row);
                updateAddChoiceBtnState();
                updatePreview();
            }

            function updateAddChoiceBtnState() {
                const count = fields.choicesContainer.querySelectorAll('.choice-row').length;
                if (count >= 4) {
                    fields.addChoiceBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    fields.addChoiceBtn.disabled = true;
                    fields.addChoiceBtn.innerHTML = '<i class="fa-solid fa-ban mr-2"></i> Maximum 4 gomb elérve';
                } else {
                    fields.addChoiceBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    fields.addChoiceBtn.disabled = false;
                    fields.addChoiceBtn.innerHTML = '<i class="fa-solid fa-plus mr-2"></i> Új választási gomb hozzáadása';
                }
            }

            fields.addChoiceBtn.addEventListener('click', () => {
                renderChoiceRow();
            });

            // --- TÖRLÉS LOGIKA ---
            function deleteCurrentPage() {
                const index = parseInt(fields.storyPageIndex.value);
                if (isNaN(index)) return;

                if (!confirm(`Biztosan törölni szeretnéd a(z) ${index}. oldalt? A hivatkozások (Next Index) elcsúszhatnak!`)) {
                    return;
                }

                currentStoryPages.splice(index, 1);
                
                if (currentStoryPages.length === 0) {
                    currentStoryPages.push(JSON.parse(JSON.stringify(DEFAULT_CONFIG.storyPages[0])));
                }

                const newIndex = Math.max(0, index - 1);
                populatePageIndexSelector(currentStoryPages.length, newIndex);
                loadStoryPage(newIndex);
                saveSettings(true);
            }

            fields.deletePageButton.addEventListener('click', deleteCurrentPage);


            // --- Main Loader ---
            function loadStoryPage(index) {
                const targetIndex = parseInt(index);
                
                // ÚJ ELLENŐRZÉS: Csak akkor mentjük az előző oldalt, ha nem a kezdeti betöltéskor vagyunk az Index 0-n.
                const isFirstCallToPageZero = isInitialLoad && targetIndex === 0;

                if (!isFirstCallToPageZero) {
                    // Mentjük a KILÉPŐ (régi) oldalt, mielőtt betöltjük az ÚJAT
                    saveCurrentStoryPageContent(); 
                }
                
                currentLoadedIndex = targetIndex;
                
                const page = currentStoryPages[currentLoadedIndex];
                
                if (!page) { toggleContentBlocks('text'); fields.pageContent.value = 'Hiba: Ez az index nem létezik.'; return; }
                
                fields.pageType.value = page.type;
                toggleContentBlocks(page.type);

                fields.pageContent.value = page.content || '';
                fields.customAvatarUrl.value = page.customAvatarUrl || '';
                fields.customBackgroundUrl.value = page.customBackgroundUrl || '';
                fields.customGalleryUrl.value = page.customGalleryUrl || ''; 
                fields.galleryMode.value = page.galleryMode || 'add_url'; 
                

                // A nextIndex és backIndex beállítása: ha undefined, akkor ' ', különben az érték
                fields.nextIndex.value = page.nextIndex !== undefined ? page.nextIndex : '';
                fields.backIndex.value = page.backIndex !== undefined ? page.backIndex : '';

                if (page.type === 'audio') {
                    fields.audioId.value = page.audioId || 1;
                    fields.audioNextButtonText.value = page.nextButtonText || '';
                } 
                
                if (page.type === 'password') {
                    fields.correctPassword.value = page.correctPassword || '';
                    fields.nextIndexSuccess.value = page.nextIndexSuccess !== undefined ? page.nextIndexSuccess : '';

                    // ÚJ: Help message betöltése (array -> string)
                    if (page.helpMessage && Array.isArray(page.helpMessage)) {
                        fields.passwordHelpMessage.value = page.helpMessage.join('\n');
                    } else {
                        fields.passwordHelpMessage.value = '';
                    }

                }

                if (page.type === 'choice') {
                    fields.choicesContainer.innerHTML = '';
                    if (page.choices && Array.isArray(page.choices)) {
                        page.choices.forEach(c => renderChoiceRow(c.text, c.nextIndex));
                    } else {
                        // Alapértelmezett, üres gomb az új Choice oldalhoz
                        renderChoiceRow();
                    }
                }
                
                if (isInitialLoad) {
                    isInitialLoad = false;
                }
                
                updatePreview(); 
            }
            
            function saveCurrentStoryPageContent() {
                const index = currentLoadedIndex;
                if (isNaN(index) || !currentStoryPages[index]) return;
                
                const page = currentStoryPages[index];
                const pageType = fields.pageType.value;
                
                page.type = pageType;
                page.content = fields.pageContent.value;
                page.customAvatarUrl = fields.customAvatarUrl.value;
                page.customBackgroundUrl = fields.customBackgroundUrl.value;
                page.customGalleryUrl = fields.customGalleryUrl.value; 
                page.galleryMode = fields.galleryMode.value; 

                // Módosított mentés: ha a mező üres, undefined-ként menti.
                page.nextIndex = fields.nextIndex.value !== '' ? parseInt(fields.nextIndex.value) : undefined;
                page.backIndex = fields.backIndex.value !== '' ? parseInt(fields.backIndex.value) : undefined;
                
                if (pageType === 'audio') {
                    page.audioId = parseInt(fields.audioId.value);
                    page.nextButtonText = fields.audioNextButtonText.value || undefined;
                    delete page.helpMessage; 
                } else {
                    delete page.audioId;
                    delete page.nextButtonText;
                }

                if (pageType === 'password') {
                    page.correctPassword = fields.correctPassword.value;
                    page.nextIndexSuccess = fields.nextIndexSuccess.value !== '' ? parseInt(fields.nextIndexSuccess.value) : undefined;
                    
                    // ÚJ: Help message mentése (string -> array)
                    const rawHelpText = fields.passwordHelpMessage.value.split('\n').map(s => s.trim()).filter(s => s.length > 0);
                    if (rawHelpText.length > 0) {
                        page.helpMessage = rawHelpText;
                    } else {
                        delete page.helpMessage;
                    }
                } else {
                    delete page.correctPassword;
                    delete page.nextIndexSuccess;
                    delete page.helpMessage; 
                }

                if (pageType === 'choice') {
                    const rows = fields.choicesContainer.querySelectorAll('.choice-row');
                    page.choices = Array.from(rows).map(row => ({
                        text: row.querySelector('.choice-text').value,
                        nextIndex: parseInt(row.querySelector('.choice-index').value) || undefined
                    })).filter(c => c.text.trim() !== '');
                    delete page.helpMessage; 
                } else {
                    delete page.choices;
                }
                
                // FRISSÍTÉS JAVÍTÁSA: Csak a legördülő menü elem szövegét frissítjük a mentett oldaltípussal.
                const currentOption = fields.storyPageIndex.options[index];
                if (currentOption) {
                    currentOption.textContent = `Oldal ${index} (${pageType})`;
                }
            }
            
            function addNewPage() {
                saveCurrentStoryPageContent();
                
                const newIndex = currentStoryPages.length;
                const newPage = {
                    type: 'text',
                    content: `§N Új oldal hozzáadva (${newIndex}).`,
                    // nextIndex: undefined (alapértelmezett, nincs explicit beállítás)
                    customAvatarUrl: "", customBackgroundUrl: "", customGalleryUrl: "", galleryMode: "add_url"
                };
                
                currentStoryPages.push(newPage);
                populatePageIndexSelector(currentStoryPages.length, newIndex);
                loadStoryPage(newIndex);
                saveSettings(false); 

                MESSAGE_DISPLAY.textContent = `Új oldal hozzáadva: ${newIndex}`;
                MESSAGE_DISPLAY.style.color = '#00FFFF';
                setTimeout(() => MESSAGE_DISPLAY.textContent = '', 3000);
            }

            // ÚJ: Funkció az importált vagy tárolt beállítások űrlapra való alkalmazásához
            function applyConfigToForm(currentConfig) {
                // Biztosítja, hogy a storyPages friss példányok legyenek
                currentStoryPages = JSON.parse(JSON.stringify(currentConfig.storyPages || DEFAULT_CONFIG.storyPages));
                
                // Globális mezők
                fields.appTitle.value = currentConfig.APP_TITLE || DEFAULT_CONFIG.APP_TITLE;
                fields.backgroundUrl.value = currentConfig.BACKGROUND_URL || DEFAULT_CONFIG.BACKGROUND_URL;
                fields.bgColor.value = currentConfig.BODY_BG_COLOR || DEFAULT_CONFIG.BODY_BG_COLOR;
                fields.textColor.value = currentConfig.BODY_TEXT_COLOR || DEFAULT_CONFIG.BODY_TEXT_COLOR;
                
                // Avatarok
                fields.avatarMUrl.value = currentConfig.AVATARS.AVATAR_MAP['§M'] || DEFAULT_CONFIG.AVATARS.AVATAR_MAP['§M'];
                fields.avatarAUrl.value = currentConfig.AVATARS.AVATAR_MAP['§A'] || DEFAULT_CONFIG.AVATARS.AVATAR_MAP['§A'];
                fields.avatarRUrl.value = currentConfig.AVATARS.AVATAR_MAP['§R'] || DEFAULT_CONFIG.AVATARS.AVATAR_MAP['§R'];
                fields.avatarDefaultUrl.value = currentConfig.AVATARS.DEFAULT_AVATAR_URL || DEFAULT_CONFIG.AVATARS.DEFAULT_AVATAR_URL;
                
                // GPS/Menü
                fields.menuMapLink.value = currentConfig.MENU_LINKS.MAP_LINK_URL || DEFAULT_CONFIG.MENU_LINKS.MAP_LINK_URL;
                fields.targetLat.value = currentConfig.GPS_COMPASS.TARGET_LATITUDE || DEFAULT_CONFIG.GPS_COMPASS.TARGET_LATITUDE;
                fields.targetLon.value = currentConfig.GPS_COMPASS.TARGET_LONGITUDE || DEFAULT_CONFIG.GPS_COMPASS.TARGET_LONGITUDE;
                fields.successRedirectUrl.value = currentConfig.GPS_COMPASS.SUCCESS_REDIRECT_URL || DEFAULT_CONFIG.GPS_COMPASS.SUCCESS_REDIRECT_URL;
                fields.gpsMapLink.value = currentConfig.GPS_COMPASS.MAP_BUTTON_URL || DEFAULT_CONFIG.GPS_COMPASS.MAP_BUTTON_URL;

                // Média
                fields.audio1Url.value = currentConfig.MEDIA.AUDIO_1_URL || DEFAULT_CONFIG.MEDIA.AUDIO_1_URL;
                fields.audio2Url.value = currentConfig.MEDIA.AUDIO_2_URL || DEFAULT_CONFIG.MEDIA.AUDIO_2_URL;

                // Jelszó Globális
                fields.passwordPromptText.value = currentConfig.PASSWORD_PAGE.PROMPT_TEXT || DEFAULT_CONFIG.PASSWORD_PAGE.PROMPT_TEXT;

                // Történet oldalak inicializálása
                populatePageIndexSelector(currentStoryPages.length, 0);
                loadStoryPage(0);
            }

            // Cserélve loadSettings-re
            function loadSettingsFromStorage() {
                const savedData = localStorage.getItem(STORAGE_KEY);
                let currentConfig = savedData ? JSON.parse(savedData) : DEFAULT_CONFIG;
                
                // Reset flag before starting load process
                isInitialLoad = true;
                
                applyConfigToForm(currentConfig);
            }

            // ÚJ: Importálás logika
            function importConfig() {
                
                // A tényleges importálás a fileInput.onchange eseményben történik
                fields.fileInput.click();
            }
            
            // ÚJ: Fájlválasztás eseménykezelő
            fields.fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) {
                    MESSAGE_DISPLAY.textContent = 'Importálás megszakítva.';
                    MESSAGE_DISPLAY.style.color = 'yellow';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedConfig = JSON.parse(e.target.result);

                        // Alapvető érvényesítés
                        if (!importedConfig.storyPages || !Array.isArray(importedConfig.storyPages)) {
                            throw new Error("A fájl nem érvényes konfigurációs formátumú.");
                        }
                        
                        // Alkalmazza az importált konfigurációt az űrlapra
                        applyConfigToForm(importedConfig);
                        saveSettings(true); // Mentés LocalStorage-ba az import után

                        MESSAGE_DISPLAY.textContent = `Konfiguráció sikeresen importálva "${file.name}" fájlból. Az adatok beolvasva és elmentve a LocalStorage-ba.`;
                        MESSAGE_DISPLAY.style.color = '#00FF00';
                    } catch (error) {
                        MESSAGE_DISPLAY.textContent = `Importálási HIBA: ${error.message}`;
                        MESSAGE_DISPLAY.style.color = '#FF5555';
                        console.error("Import Error:", error);
                    }
                    // A fájl input értékének visszaállítása, hogy ugyanazt a fájlt újra lehessen választani
                    fields.fileInput.value = ''; 
                };
                reader.readAsText(file);
            });


            function saveSettings(showSuccess = true) {
                // Először elmentjük az aktuálisan szerkesztett oldalt (ha showSuccess=true)
                if (showSuccess) {
                    saveCurrentStoryPageContent();
                }

                const savedData = localStorage.getItem(STORAGE_KEY);
                let newConfig = savedData ? JSON.parse(savedData) : DEFAULT_CONFIG;
                
                newConfig.APP_TITLE = fields.appTitle.value;
                newConfig.BACKGROUND_URL = fields.backgroundUrl.value;
                newConfig.BODY_BG_COLOR = fields.bgColor.value;
                newConfig.BODY_TEXT_COLOR = fields.textColor.value;
                
                newConfig.AVATARS.DEFAULT_AVATAR_URL = fields.avatarDefaultUrl.value;
                newConfig.AVATARS.AVATAR_MAP['§M'] = fields.avatarMUrl.value;
                newConfig.AVATARS.AVATAR_MAP['§A'] = fields.avatarAUrl.value;
                newConfig.AVATARS.AVATAR_MAP['§R'] = fields.avatarRUrl.value;
                
                newConfig.MENU_LINKS.MAP_LINK_URL = fields.menuMapLink.value;
                // Biztonságos float konverzió
                newConfig.GPS_COMPASS.TARGET_LATITUDE = parseFloat(fields.targetLat.value) || DEFAULT_CONFIG.GPS_COMPASS.TARGET_LATITUDE;
                newConfig.GPS_COMPASS.TARGET_LONGITUDE = parseFloat(fields.targetLon.value) || DEFAULT_CONFIG.GPS_COMPASS.TARGET_LONGITUDE;
                newConfig.GPS_COMPASS.SUCCESS_REDIRECT_URL = fields.successRedirectUrl.value;
                newConfig.GPS_COMPASS.MAP_BUTTON_URL = fields.gpsMapLink.value;
                
                newConfig.PASSWORD_PAGE.PROMPT_TEXT = fields.passwordPromptText.value;
                newConfig.MEDIA.AUDIO_1_URL = fields.audio1Url.value;
                newConfig.MEDIA.AUDIO_2_URL = fields.audio2Url.value;
                
                // Mivel az autosave-et bevezettük, a storyPages-t már korábban frissítette a saveCurrentStoryPageContent
                newConfig.storyPages = currentStoryPages;

                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(newConfig));
                } catch (e) {
                    console.error("Hiba a LocalStorage mentése közben:", e);
                    MESSAGE_DISPLAY.textContent = `Mentési HIBA! A böngésző blokkolhatja a tárhelyet.`;
                    MESSAGE_DISPLAY.style.color = '#FF5555';
                    return;
                }


                if (showSuccess) {
                    MESSAGE_DISPLAY.textContent = 'Beállítások sikeresen elmentve!';
                    MESSAGE_DISPLAY.style.color = '#00FF00';
                    setTimeout(() => MESSAGE_DISPLAY.textContent = '', 4000);
                }
            }
            
            function resetSettings() {
                if (!confirm("BIZTOSAN TÖRÖLNI SZERETNÉD AZ ÖSSZES ELMENTETT KONFIGURÁCIÓT? Ez visszaállítja az alapértelmezett állapotot!")) {
                    return;
                }
                
                try {
                    localStorage.removeItem(STORAGE_KEY);
                    loadSettingsFromStorage();
                    MESSAGE_DISPLAY.textContent = 'Minden beállítás sikeresen törölve és alapértelmezettre visszaállítva!';
                    MESSAGE_DISPLAY.style.color = '#FF5733';
                    setTimeout(() => MESSAGE_DISPLAY.textContent = '', 5000);
                } catch (e) {
                    console.error("Hiba a LocalStorage törlése közben:", e);
                    MESSAGE_DISPLAY.textContent = `HIBA: Nem sikerült törölni a beállításokat.`;
                    MESSAGE_DISPLAY.style.color = '#FF5555';
                }
            }
            
            // --- LISTENERS SETUP ---
            function setupAutoSaveListeners() {
                // Kezeli az összes globális és oldal-specifikus mezőt (input/textarea)
                const inputFields = [
                    fields.appTitle, fields.backgroundUrl, fields.bgColor, fields.textColor,
                    fields.avatarMUrl, fields.avatarAUrl, fields.avatarRUrl, fields.avatarDefaultUrl,
                    fields.menuMapLink, fields.targetLat, fields.targetLon, fields.successRedirectUrl, fields.gpsMapLink,
                    fields.audio1Url, fields.audio2Url, fields.passwordPromptText,
                    
                    fields.pageContent, fields.customAvatarUrl, fields.customBackgroundUrl, fields.customGalleryUrl,
                    fields.nextIndex, fields.backIndex, fields.audioNextButtonText,
                    fields.correctPassword, fields.nextIndexSuccess, fields.passwordHelpMessage
                ];

                inputFields.forEach(field => addAutoSaveListener(field, 'input'));

                // Kezeli a select (legördülő) mezőket (change event)
                const selectFields = [
                    fields.galleryMode, fields.audioId
                ];
                selectFields.forEach(field => addAutoSaveListener(field, 'change'));
                
                // Speciális Listenerek frissítése
                // fields.pageType.addEventListener('change', autoSaveAndPreviewHandler); // Ezt a sort kivettem!
            }
            // --- LISTENERS SETUP VÉGE ---

            // --- KÖZVETLEN PREVIEW INDÍTÁS LOGIKÁJA ---
            // Cél: Menteni a beállításokat, és új lapon megnyitni a preview.html oldalt.
            goToGameButton.addEventListener('click', (event) => {
                event.preventDefault(); // Megakadályozzuk az alapértelmezett navigációt

                // 1. MENTÉS kényszerítése
                saveSettings(false); 

                // 2. Új ablak nyitása a "_blank" targettel (új lap).
                const previewWindow = window.open(goToGameButton.href, '_blank');
                
                if (previewWindow) {
                    MESSAGE_DISPLAY.textContent = 'Beállítások elmentve. A Játék előnézet új lapon nyílt meg.';
                    MESSAGE_DISPLAY.style.color = '#00FF00';
                    setTimeout(() => MESSAGE_DISPLAY.textContent = '', 4000);
                } else {
                     MESSAGE_DISPLAY.textContent = 'Beállítások elmentve, de a böngésző blokkolta a felugró ablakot.';
                     MESSAGE_DISPLAY.style.color = '#FF5555';
                }
            });


            document.addEventListener('DOMContentLoaded', () => {
                // A betöltés után beállítjuk az autosave listenereket
                setupAutoSaveListeners();
                
                loadSettingsFromStorage(); 
                
                // ELSŐ VÁLTOZTATÁS: Egy kattintásra váltás engedélyezése.
                fields.storyPageIndex.addEventListener('change', (e) => loadStoryPage(parseInt(e.target.value)));
                
                // VISSZAÁLLÍTVA: Így biztosan frissül a felület és mentődik az oldal, amikor oldaltípust váltunk.
                fields.pageType.addEventListener('change', (e) => {
                    // 1. Mentjük az aktuális oldal adatait, mielőtt átváltjuk a felületet (így a régi mezők értékei elmentődnek)
                    saveCurrentStoryPageContent();
                    
                    // 2. Frissítjük a látható blokkokat (pl. Text/Password/Choice)
                    toggleContentBlocks(e.target.value);

                    // 3. Mentjük a teljes configot (most már az új típussal a storyPages-ben)
                    saveSettings(false); 
                    
                    // 4. Frissítjük az előnézetet
                    updatePreview();
                });

                fields.addPageButton.addEventListener('click', addNewPage);
                document.getElementById('saveButton').addEventListener('click', () => saveSettings(true));
                
                // GOMBOK WIRING
                fields.resetButton.addEventListener('click', resetSettings);
                fields.loadConfigButton.addEventListener('click', importConfig); 
                
                // EXPORTÁLÁS GOMB LOGIKA: JSON fájl letöltése
                document.getElementById('downloadPageButton').addEventListener('click', () => {
                    // 1. Mentés kényszerítése az export előtt
                    saveSettings(false); 
                    
                    // 2. A teljes konfiguráció lekérése a LocalStorage-ból
                    const finalConfigJson = localStorage.getItem(STORAGE_KEY);
                    if (!finalConfigJson) {
                        MESSAGE_DISPLAY.textContent = 'HIBA: Nincs konfiguráció a mentéshez!';
                        MESSAGE_DISPLAY.style.color = 'red';
                        return;
                    }
                    
                    // 3. Fájl generálása és letöltése
                    const blob = new Blob([finalConfigJson], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'game_config.json'; // A játék oldala ezt a fájlt fogja keresni
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    MESSAGE_DISPLAY.textContent = 'game_config.json sikeresen letöltve! Töltsd fel a GitHub mappába.';
                    MESSAGE_DISPLAY.style.color = '#00FFFF';
                    setTimeout(() => MESSAGE_DISPLAY.textContent = '', 8000);
                });
            });
        })();
    </script>
</body>
</html>
