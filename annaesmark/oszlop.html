<!doctype html>
<html lang="hu">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=10.0">
    <title>Titkok kora - A Folytat√°s</title>
    
    <!-- GPS √©s Ikonok enged√©lyez√©se -->
    <meta http-equiv="Permissions-Policy" content="geolocation=*">
    <!-- Fontok √©s Ikonok -->
    <link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* --- Zoomol√°s √©s G√∂rget√©s Letilt√°sa (Modal nyit√°skor) */
        html {
            /* FIX: Ensure HTML fills viewport */
            height: 100%; 
            overflow-x: hidden;
            overflow-y: auto; 
            background-color: #1a1a1a !important; /* FIX: Er≈ës fekete h√°tt√©r */
        }

        /* Amikor egy modal nyitva van, a f≈ëoldal g√∂rget√©s√©t letiltjuk */
        body.modal-open {
            overflow: hidden;
            height: 100%;
            touch-action: none;
        }


        /* Alapvet≈ë reszet √©s s√∂t√©t h√°tt√©r */
        body {
            /* FIX: Ensure body fills viewport and background is definitive */
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Play', sans-serif;
            color: #e0e0e0; 
            background-color: #1a1a1a !important; /* FIX: Er≈ës fekete h√°tt√©r */
            display: flex;
            flex-direction: column;
            align-items: center;
            /* A g√∂rget√©s enged√©lyezve: */
            overflow-y: auto;
            min-height: 100vh;
            touch-action: auto; 
            text-align: center;
            padding-bottom: 60px; 
        }
        
        /* Teljes sz√©less√©g≈± K√âP (H√°tt√©r) */
        .full-width-image-container {
            width: 100%;
            height: 100vh; 
            overflow: hidden;
            position: absolute; 
            top: 0;
            left: 0;
            z-index: 0; 
            min-height: 100vh;
            background-color: #101010; 
        }

        .full-width-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover; 
            object-position: center top; 
            transition: opacity 0.5s; 
        }

        /* Tartalom doboz - FIX ALULRA Z√ÅRVA */
        .content-box {
            background-color: rgba(0, 0, 0, 0.85); 
            padding: 40px 20px 10px 20px; 
            margin: 0; 
            border-radius: 10px 10px 0 0; 
            max-width: 800px;
            width: calc(100% - 40px);
            box-shadow: 0 0 25px rgba(138, 43, 226, 0.7);
            border: 3px solid #8a2be2;
            box-sizing: border-box;
            position: fixed; 
            bottom: 50px; 
            left: 50%;
            transform: translateX(-50%); 
            z-index: 10;
            text-align: left;
            min-height: 250px; 
            display: flex; 
            flex-direction: column;
            justify-content: space-between; 
            opacity: 1; /* FIX: Alap√©rtelmezetten l√°that√≥! */
            transition: opacity 0.5s ease-in-out;
        }

        /* T√∂rt√©net sz√∂vege */
        #story-text-display {
            font-size: 1.2em;
            font-weight: 700;
            line-height: 1.6;
            margin-bottom: 20px;
            white-space: pre-wrap; 
            flex-grow: 1; 
        }
        
        /* Audio gombok... */
        .audio-container {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .audio-button {
            padding: 12px 20px; 
            text-decoration: none;
            color: #1a1a1a;
            background-color: #00FFFF; 
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.4);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .audio-button:hover {
            background-color: #00DDEE;
        }

        /* --- ALS√ì INTERAKCI√ìS S√ÅV (a t√∂rt√©net gombjai) --- */
        .bottom-bar {
            padding-top: 10px;
            border-top: 1px dashed #8a2be2;
            min-height: 48px;
            width: 100%;
        }

        .interaction-container {
            display: flex;
            justify-content: space-between; 
            align-items: center;
            width: 100%;
        }

        .page-button {
            padding: 12px 20px; 
            text-decoration: none;
            color: #ffffff;
            background-color: #8a2be2;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            text-transform: uppercase;
            box-shadow: 0 4px 10px rgba(138, 43, 226, 0.4);
            margin: 5px;
        }
        
        .page-button#next-page-button.full-width {
            width: 100%;
            flex-grow: 1;
            margin-left: 0;
            margin-right: 0;
        }
        
        .page-button:hover:not(:disabled) {
            background-color: #7b1cd1;
            transform: translateY(-1px);
        }

        .page-button:disabled {
            background-color: #555555;
            cursor: not-allowed;
            box-shadow: none;
            opacity: 0.6;
        }
        
        /* T√∂bb gomb kont√©ner */
        .multi-choice-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            padding: 0;
            margin: 0;
        }
        
        /* Diszkr√©t Vissza Gomb - CSAK CHOICE ESETEKBEN */
        .discreet-back-button {
            position: absolute;
            /* FIX: Lejjebb poz√≠cion√°lva, hogy l√°tsz√≥djon */
            top: 10px; 
            left: 10px;
            z-index: 30; 
            background-color: rgba(138, 43, 226, 0.5); 
            color: #ffffff;
            padding: 8px 12px;
            border-radius: 50%; 
            width: 40px;
            height: 40px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: none; 
            transition: background-color 0.2s;
            text-transform: none;
            margin: 0;
            border: none;
        }

        .discreet-back-button:hover:not(:disabled) {
            background-color: rgba(138, 43, 226, 0.8);
            transform: none; 
        }
        .discreet-back-button:disabled {
             background-color: rgba(90, 90, 90, 0.5);
             opacity: 0.5;
             cursor: not-allowed;
        }


        /* Jelsz√≥ kont√©ner */
        #password-container {
            display: none;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            text-align: center;
        }

        #password-container.visible {
            display: flex;
        }
        
        #password-input {
            padding: 12px;
            border: 2px solid #8a2be2;
            border-radius: 5px;
            background-color: #2c2c2c;
            color: #00ffff;
            font-size: 1.2em;
            text-align: center;
            font-family: 'Play', sans-serif;
            margin-bottom: 5px; 
        }

        /* A "Add meg a k√≥dot" sor flexbe igaz√≠tva a k√©rd≈ëjellel */
        #password-container p {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .password-interaction {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        #check-password-button, #back-button-password {
            padding: 12px 20px; 
            font-size: 1.1em; 
        }
        
        #back-button-password {
            color: #ffffff;
            background-color: #8a2be2; 
        }
        
        #check-password-button {
            color: #ffffff;
            background-color: #00ffff;
            box-shadow: 0 4px 10px rgba(0, 255, 255, 0.4); 
            flex-grow: 1; 
        }
        
        #check-password-button:hover {
            background-color: #00ddee;
            transform: translateY(-1px); 
        }

        #message {
            margin-top: 10px;
            font-weight: 700;
            color: #ff4500;
        }

        /* Avatar k√©p */
        .avatar-image {
            position: absolute;
            /* FIX: Lejjebb poz√≠cion√°lva, hogy l√°tsz√≥djon */
            top: -30px; 
            left: 10px; 
            width: 70px; 
            height: 70px; 
            border-radius: 50%; 
            object-fit: cover; 
            z-index: 20; 
            display: none; 
            box-shadow: 0 0 8px rgba(0, 255, 255, 0.5); 
            transition: opacity 0.3s ease-in-out; 
        }
        
        /* --- FIX ALS√ì MEN√úSOR --- */
        .fixed-menu-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50px;
            background-color: #1a1a1a;
            border-top: 2px solid #8a2be2;
            z-index: 50; 
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -4px 15px rgba(138, 43, 226, 0.5);
        }

        .menu-button {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px 10px;
            transition: color 0.3s;
        }

        .menu-button:hover {
            color: #00ffff;
        }

        /* --- GAL√âRIA MODAL ST√çLUSOK (megtartva) */
        #galleryModal {
            display: none; 
            position: fixed;
            z-index: 100; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow-y: scroll; 
            background-color: rgba(0, 0, 0, 0.95);
        }
        
        #gallery-container {
            display: grid;
            grid-template-columns: 1fr 1fr; 
            gap: 10px;
            padding: 15px;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            box-sizing: border-box;
            padding-top: 50px;
        }

        .gallery-thumbnail {
            width: 100%;
            height: 150px; 
            overflow: hidden;
            border: 2px solid #8a2be2;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(138, 43, 226, 0.4);
            transition: transform 0.2s;
            position: relative;
        }

        .gallery-thumbnail:hover {
            transform: scale(1.03);
        }

        .gallery-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover; 
            display: block;
        }
        
        /* Teljes k√©perny≈ës mod√°l kont√©ner a zoomolhat√≥ k√©pnek (megtartva) */
        #full-image-display {
            display: none;
            position: fixed;
            z-index: 101;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.98);
            overflow: hidden; 
        }
        
        .full-image-content {
            width: 100vw; 
            height: 100vh;
            display: flex;
            align-items: center; 
            justify-content: center; 
            overflow: hidden;
        }

        #fullImageDisplay {
            display: block;
            width: auto; 
            height: auto;
            max-width: 100%; 
            max-height: 100%;
            touch-action: auto; 
            cursor: zoom-in;
            margin: auto;
            /* Zoomhoz hozz√°adott √°tmenet */
            transition: transform 0.3s ease-in-out; 
        }

        .close-gallery {
            position: absolute;
            top: 15px;
            right: 33px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
            z-index: 110;
            text-shadow: 0 0 5px rgba(0, 0, 0, 1);
        }
        
        .close-gallery:hover,
        .close-gallery:focus {
            color: #00ffff;
        }
        
        /* S√∫g√≥ modal st√≠lusok (√öJRA BEVEZETVE) */
        #helpModal {
            display: none;
            position: fixed;
            z-index: 105;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 400px;
            background-color: #1a1a1a;
            border: 3px solid #00ffff;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
            padding: 20px;
            text-align: center;
        }
        
        .help-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        #help-text-display {
            font-size: 1.1em;
            font-weight: 700;
            color: #e0e0e0;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }


        .help-icon { 
              background: none;
              border: none;
              color: #00ffff;
              font-size: 1.2em;
              cursor: pointer;
              transition: color 0.3s;
        }
        .help-icon:hover {
            color: #ffffff;
        }

        /* GPS Modal (megtartva) */
        #distanceModal { 
            display: none; 
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            justify-content: center;
            align-items: center;
        }
        .distance-content { 
            background-color: rgba(0, 0, 0, 0.95);
            border: 3px solid #00ffff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
            padding: 30px;
            border-radius: 10px;
            max-width: 90%;
            text-align: center;
        }
        #distance-modal-display { 
            font-size: 3em;
            font-weight: 700;
            color: #00ffff;
            margin: 15px 0;
        }
        /* Elt√°vol√≠tottam a distance-status elemet, hogy ne jelenjen meg sz√∂veg */
        
        #distance-modal-map-button {
            display: inline-block;
            padding: 10px 20px;
            background-color: #8a2be2;
            color: #ffffff;
            text-decoration: none;
            border-radius: 5px;
            font-weight: 700;
        }
        
        /* K√âP ST√çLUS BE√ÅLL√çT√ÅSA A SZ√ñVEGDOBOZON BEL√úL */
        .note-image-container img {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body oncontextmenu="return false;"> 
    <div class="full-width-image-container">
        <!-- H√°tt√©rk√©p (Teljes URL haszn√°lat√°val) -->
        <img id="story-image" 
             src="https://treasurehuntsites.github.io/annaesmark/Img/oszlop.jpg" 
             alt="Titokzatos jelenet"
             onerror="this.src='https://placehold.co/1280x720/101010/8A2BE2?text=K√âP+HIBA+oszlop.jpg'"> <!-- Biztons√°gi placeholder -->
    </div>

    <div class="content-box" id="content-box">
        <!-- Avatar k√©p (Teljes URL haszn√°lat√°val) -->
        <img id="avatar-img" class="avatar-image" src="https://treasurehuntsites.github.io/annaesmark/Img/mark.png" alt="Szerepl≈ë avatar">
        
        <!-- Diszkr√©t vissza ny√≠l gomb (csak v√°laszt√°sn√°l l√°tszik) -->
        <button id="discreet-back-button" class="discreet-back-button page-button" disabled style="display: none;">
            <i class="fa-solid fa-arrow-left"></i>
        </button>
        
        <p id="story-text-display">Bet√∂lt√©s...</p>
        
        <div id="audio-container-1" class="audio-container" style="display:none;">
             <button id="play-audio-button-1" class="audio-button">‚ñ∂Ô∏è Lej√°tsz√°s (1)</button>
        </div>
        <div id="audio-container-2" class="audio-container" style="display:none;">
             <button id="play-audio-button-2" class="audio-button">‚ñ∂Ô∏è Lej√°tsz√°s (2)</button>
        </div>


        <div class="bottom-bar">
            <!-- Szekvenci√°lis interakci√≥k kont√©nere -->
            <div class="interaction-container" id="interaction-container">
                <button id="prev-page-button" class="page-button" disabled>
                    Vissza
                </button>
                
                <button id="next-page-button" class="page-button">
                    Tov√°bb
                </button>
            </div>
            
            <!-- K√©tv√°laszt√°s kont√©ner -->
            <div class="multi-choice-container" id="multi-choice-container" style="display:none;">
                <button id="choice-1-button" class="page-button" data-next-index="">
                    V√°laszt√°s 1
                </button>
                <button id="choice-2-button" class="page-button" data-next-index="">
                    V√°laszt√°s 2
                </button>
                <button id="choice-3-button" class="page-button" data-next-index="">
                    V√°laszt√°s 3
                </button>
                <button id="choice-4-button" class="page-button" data-next-index="" style="display: none;">
                    V√°laszt√°s 4
                </button>
            </div>


            <div id="password-container">
                <p>
                    <span id="password-prompt-span">Mi a k√≥d</span> <!-- FRISS√çTVE: Mi a k√≥d -->
                    <button id="help-button" class="help-icon" title="Seg√≠ts√©g">
                        <i class="fa-solid fa-circle-question"></i>
                    </button>
                </p>
                <input type="text" id="password-input" maxlength="8">
                
                <div class="password-interaction">
                    <button id="back-button-password" class="page-button">
                        Vissza
                    </button>
                    <button id="check-password-button" class="page-button">
                        ELLEN≈êRZ√âS
                    </button>
                </div>
                <!-- √öJ: Szoba link kont√©ner (elrejtve) -->
                <div id="room-link-container" style="display: none; margin-top: 10px; width: 100%;">
                    <button id="room-link-button" class="page-button full-width">
                        Szoba
                    </button>
                </div>
                <p id="message"></p>
            </div>
        </div>
    </div>
    
    <div class="fixed-menu-bar">
        <button id="map-button" class="menu-button" title="T√©rk√©p">
            <i class="fa-solid fa-map-location-dot"></i>
        </button>
        
        <button id="image-button" class="menu-button" title="K√©pgal√©ria">
            <i class="fa-solid fa-image"></i>
        </button>
    </div>
    
    <!-- MODAL elemek (megtartva) -->
    <div id="galleryModal">
      <!-- FIX: Bez√°r√°s JS-sel, nem history.back()-kel -->
      <span class="close-gallery" onclick="closeGalleryModal();">√ó</span>
      <div id="gallery-container">
      </div>
    </div>
    
    <div id="full-image-display">
        <div class="full-image-content">
            <img id="fullImageDisplay" src="" alt="Nagy√≠tott k√©p" />
        </div>
        <!-- FIX: Bez√°r√°s JS-sel, nem history.back()-kel -->
        <span class="close-gallery" style="z-index: 120;" onclick="closeFullImageModal();">√ó</span>
    </div>
    
    <!-- T√°vols√°g Modal (GPS MODAL) (megtartva) -->
    <div id="distanceModal"> 
        <div class="distance-content">
            <h1>C√âLPONT KERES√âSE</h1>
            
            <div id="distance-modal-display">
                -- M
            </div>
            
            <!-- Elt√°vol√≠tva a distance-status elem, hogy ne legyen sz√∂veg a t√°vols√°g alatt -->
            
            <!-- T√©rk√©p gomb (GPS modal t√©rk√©p linkje) -->
            <a href="#" target="_blank" id="distance-modal-map-button">
                üó∫Ô∏è T√©rk√©p
            </a>
        </div>
    </div>
    <!-- END T√°vols√°g Modal -->

    <!-- S√∫g√≥ Modal (√öJRA BEVEZETVE) -->
    <div id="helpModal">
        <div class="help-content">
            <p id="help-text-display"></p>
            <div style="display: flex; justify-content: space-between; gap: 10px;">
                <button id="help-prev-button" class="page-button" style="flex-grow: 1; background-color: #555555; color: #ffffff;">Vissza</button>
                <button id="help-close-button" class="page-button" style="flex-grow: 1; background-color: #8a2be2; color: #ffffff;">Bez√°r√°s</button>
                <button id="help-next-button" class="page-button" style="flex-grow: 1; background-color: #00ffff; color: #1a1a1a;">Tov√°bb</button>
            </div>
        </div>
    </div>

    
    <audio id="story-audio-1" src="https://raw.githubusercontent.com/treasurehuntsites/treasurehuntsites.github.io/main/media/Ugynokok1.mp3" preload="auto"></audio>
    <audio id="story-audio-2" src="https://raw.githubusercontent.com/treasurehuntsites/treasurehuntsites.github.io/main/media/Ugynokok2.mp3" preload="auto"></audio>

    <script>
        // A szkriptet egy IIFE-be (Immediately Invoked Function Expression) csomagoljuk
        (function() {
            // --- K√âP/T√ñRT√âNET ADATOK ---
            const GITHUB_BASE_URL = "https://treasurehuntsites.github.io/annaesmark/Img/";
            
            // Avat√°r URL-ek
            const MARK_AVATAR_URL = GITHUB_BASE_URL + "mark.png"; // FRISS√çTVE: mark.png
            const ANNA_AVATAR_URL = GITHUB_BASE_URL + "anna.png"; 
            // Megl√©v≈ë k√©pekhez placeholder, ha nincsenek felt√∂ltve
            const FULKE1_IMAGE_URL = GITHUB_BASE_URL + "Fulke1.jpg";
            const OSZLOP_IMAGE_URL = GITHUB_BASE_URL + "oszlop.jpg"; // Az √∫j k√©p nev√©t haszn√°ljuk
            
            // T√©rk√©plinkek
            const MENU_MAP_URL = 'https://www.google.com/maps/d/u/0/viewer?mid=16sa3cYL_ieEYMSaDIKcfMoa4IgTnFgM&ll=47.47464209999998%2C19.04027429999999&z=17'; 
            const GPS_MODAL_MAP_URL = 'https://www.google.com/maps/d/u/0/viewer?mid=16sa3cYL_ieEYMSaDIKcfMoa4IgTnFgM&ll=47.47464209999998%2C19.04027429999999&z=17'; 

            // C√âLPONT KOORDIN√ÅT√ÅK √âS T√ÅVOLS√ÅG K√úSZ√ñB (megtartva a GPS funkci√≥hoz)
            const TARGET_LAT = 47.46513; 
            const TARGET_LON = 19.03530; 
            const TARGET_RADIUS_M = 50; 
            
            // GAL√âRIA K√âPEK (Csak a felt√©telezett k√©pekkel)
            const ALL_GALLERY_ITEMS = [
                { id: 'oszlop', url: OSZLOP_IMAGE_URL, title: "Kosztol√°nyi t√©ri oszlop", unlocked: true },
                { id: 'fulke1', url: FULKE1_IMAGE_URL, title: "√Årny√©k Sz√∂vets√©g b√°zis", unlocked: false }, 
            ];
            
            // T√ñBBL√âPCS≈êS S√öG√ì √úZENETEK
            const HELP_MESSAGES_26690 = [
                "5 jegy≈± sz√°mk√≥d" 
            ];
            
            // T√ñRT√âNETR√âSZEK (Indexel√©s 1-t≈ël 23-ig, 4 √©s 5 null)
            const storyPages = [
                // Index 0: Ezt sosem haszn√°ljuk
                { type: 'text', content: 'Kezd≈ë oldal. Kattints a Tov√°bb gombra az indul√°shoz.', speaker: 'Narrator', image: OSZLOP_IMAGE_URL, nextIndex: 1 },

                // 1. Dialogue 1
                { type: 'text', content: 'Sz√©p munka volt Anna! Megszerezted a gr√°n√°tot is?', speaker: 'Mark', image: OSZLOP_IMAGE_URL, nextIndex: 2 }, 
                // 2. Dialogue 2
                { type: 'text', content: 'Igen, megvan! Meleg helyzet volt!', speaker: 'Anna', image: OSZLOP_IMAGE_URL, nextIndex: 3 },
                // 3. F≈ê D√ñNT√âS
                { type: 'choice', content: '√âs most hogyan tov√°bb?', speaker: 'Narrator', image: OSZLOP_IMAGE_URL, 
                    choices: [
                        { text: 'K√∂r√ºln√©ztek az oszlop k√∂rny√©k√©n', nextIndex: 6 } 
                    ],
                    backIndex: 2
                },
                // 4. (UNUSED/SKIP) - Null placeholder
                null,
                // 5. (UNUSED/SKIP) - Null placeholder
                null,

                // 6. COLUMN STORY B1
                { type: 'text', content: 'A rozoga oszlopon l√©v≈ë sz√°m, √©vtizedek √≥ta ott rozsd√°sodott a Kosztol√°nyi Dezs≈ë t√©r egyik f√©lrees≈ë sark√°ban.', speaker: 'Narrator', image: OSZLOP_IMAGE_URL, nextIndex: 7 },
                // 7. COLUMN STORY B2
                { type: 'text', content: 'L√°tsz√≥lag nem volt jelent≈ës√©ge, m√©gis, amikor Anna √©s M√°rk egy kellemes ≈ëszi d√©lut√°n a t√©ren s√©t√°lva megpillantott√°k, valami furcsa √©rz√©s fogta el ≈ëket.', speaker: 'Narrator', image: OSZLOP_IMAGE_URL, nextIndex: 8 },
                // 8. COLUMN STORY B3
                { type: 'text', content: 'A sz√°m szinte h√≠vogatta ≈ëket, hogy felfedj√©k a t√∂rt√©net√©t.', speaker: 'Narrator', image: OSZLOP_IMAGE_URL, nextIndex: 9 },
                // 9. COLUMN DIALOGUE M1
                { type: 'text', content: 'Mi√©rt van egy sz√°m egy oszlopon? R√°ad√°sul ilyen nagy? ‚Äì t√∂prengett M√°rk, mik√∂zben meg√©rintette az oszlop f√°j√°t.', speaker: 'Mark', image: OSZLOP_IMAGE_URL, nextIndex: 10 },
                // 10. COLUMN DIALOGUE A1
                { type: 'text', content: 'Lehet, hogy csak egy r√©gi azonos√≠t√≥, tal√°n a villamosvonalhoz tartozott‚Äù ‚Äì v√°laszolt Anna, aki t√∂rt√©n√©szk√©nt mindig szeretett felfedezni elfeledett r√©szleteket a v√°ros m√∫ltj√°b√≥l.', speaker: 'Anna', image: OSZLOP_IMAGE_URL, nextIndex: 11 },
                // 11. COLUMN DISCOVERY N1
                { type: 'text', content: 'Ahogy k√∂zelebbr≈ël megn√©zt√©k az oszlopot, Anna √©szrevett egy finom, alig l√°that√≥ karcol√°st a sz√°m alatt.', speaker: 'Narrator', image: OSZLOP_IMAGE_URL, nextIndex: 12 },
                // 12. COLUMN DISCOVERY N2
                { type: 'text', content: 'A fa m√©ly√©n egy ny√≠l form√°j√∫ jel l√°tszott, amely lefel√© mutatott.', speaker: 'Narrator', image: OSZLOP_IMAGE_URL, nextIndex: 13 }, 
                // 13. COLUMN DIALOGUE M2
                { type: 'text', content: 'Ez itt biztos nem v√©letlen ‚Äì mondta M√°rk, √©s a ny√≠l ir√°ny√°t k√∂vetve az oszlop t√∂v√©ben egy apr√≥ f√©mlapot tal√°ltak a f√∂ldbe √°gyazva.', speaker: 'Mark', image: OSZLOP_IMAGE_URL, nextIndex: 14 },
                // 14. COLUMN DISCOVERY N3
                { type: 'text', content: 'A f√©mlapra egyetlen sz√≥t v√©stek: ‚ÄûK√∂vess.‚Äù', speaker: 'Narrator', image: OSZLOP_IMAGE_URL, nextIndex: 15 },
                // 15. COLUMN DIALOGUE M3
                { type: 'text', content: '‚ÄûEz egy j√°t√©k?‚Äù ‚Äì k√©rdezte M√°rk, izgatotts√°g csillogott a szem√©ben.', speaker: 'Mark', image: OSZLOP_IMAGE_URL, nextIndex: 16 },
                // 16. COLUMN DIALOGUE A2
                { type: 'text', content: 'Vagy tal√°n valami t√∂bb. N√©zz√ºk meg, hov√° vezet ‚Äì felelte Anna.', speaker: 'Anna', image: OSZLOP_IMAGE_URL, nextIndex: 17 },
                // 17. COLUMN DISCOVERY N4
                { type: 'text', content: 'A f√©mlapon m√©g egy ny√≠l l√°tszott, amely az egyik k√∂zeli j√°rdaszeg√©ly fel√© mutatott.', speaker: 'Narrator', image: OSZLOP_IMAGE_URL, nextIndex: 18 },
                // 18. COLUMN N5
                { type: 'text', content: 'Anna √©s M√°rk elindultak, k√∂vetve a ny√≠lakat.', speaker: 'Narrator', image: OSZLOP_IMAGE_URL, nextIndex: 19 },
                // 19. COLUMN N6
                { type: 'text', content: 'A nyomok egy elhagyatott, omladoz√≥ √©p√ºlethez vezettek, amelyr≈ël Anna azonnal tudta, hogy egy r√©gi villamoskarbantart√≥ m≈±hely lehetett.', speaker: 'Narrator', image: OSZLOP_IMAGE_URL, nextIndex: 20 }, 
                // 20. COLUMN N7
                { type: 'text', content: 'Az √©p√ºlet ajtaj√°n egy rozsd√°s sz√°mz√°ras lakat l√≥gott.', speaker: 'Narrator', image: OSZLOP_IMAGE_URL, nextIndex: 21 },
                // 21. M√°rk jelsz√≥ felvezet√©s
                { type: 'text', content: 'Ez t√∫l egyszer≈± ‚Äì jegyezte meg M√°rk.', speaker: 'Mark', image: OSZLOP_IMAGE_URL, nextIndex: 22 },
                // 22. NEW PASSWORD GATE (GATE 2)
                { 
                    type: 'password', content: 'A k√≥d nem lehet m√°s, mint az oszlopn√°l tal√°lt sz√°m.', 
                    speaker: 'Narrator', image: OSZLOP_IMAGE_URL,
                    correctPassword: '26690', backIndex: 21, isCaseInsensitive: true,
                    helpMessages: HELP_MESSAGES_26690, 
                    nextIndexSuccess: 23 
                },
                // 23. GPS TRIGGER PAGE (A k√≥d elfogad√°sa ut√°n ide j√∂n, √©s azonnal aktiv√°lja a mod√°lt, a tartalom rejtve marad.)
                { 
                    type: 'text', 
                    content: '', // SZ√ñVEG T√ñR√ñLVE!
                    speaker: 'Narrator', 
                    image: OSZLOP_IMAGE_URL, 
                    nextButtonText: 'C√©lpont keres√©se (GPS)',
                    customAction: 'open_distance_modal', 
                    nextIndex: 23 
                }

            ];

            
            let currentPartIndex = 1; // FIX: Indul√°s az 1-es indexn√©l
            let currentHelpIndex = 0;
            let watchId = null; 
            
            // --- K√âP NAGY√çT√ÅS/KICINY√çT√âS √ÅLLAPOT ---
            let currentScale = 1.0; 
            const MAX_SCALE = 2.5; 
            const MIN_SCALE = 1.0; 
            
            // DOM elemek
            const contentBox = document.getElementById('content-box');
            const storyDisplay = document.getElementById('story-text-display');
            const nextButton = document.getElementById('next-page-button');
            const prevButton = document.getElementById('prev-page-button'); 
            const interactionContainer = document.getElementById('interaction-container'); 
            const multiChoiceContainer = document.getElementById('multi-choice-container'); 
            const choice1Button = document.getElementById('choice-1-button'); 
            const choice2Button = document.getElementById('choice-2-button'); 
            const choice3Button = document.getElementById('choice-3-button'); 
            const choice4Button = document.getElementById('choice-4-button'); 
            const discreetBackButton = document.getElementById('discreet-back-button'); 
            const passwordContainer = document.getElementById('password-container'); 
            const backButtonPassword = document.getElementById('back-button-password'); 
            const passwordInput = document.getElementById('password-input');
            const checkButton = document.getElementById('check-password-button');
            const messageDisplay = document.getElementById('message');
            const helpButton = document.getElementById('help-button'); 
            const passwordPromptSpan = document.getElementById('password-prompt-span'); 
            const storyImage = document.getElementById('story-image'); 
            const avatarImg = document.getElementById('avatar-img');
            const imageButton = document.getElementById('image-button');
            const mapButton = document.getElementById('map-button'); 
            const storyAudio1 = document.getElementById('story-audio-1');
            const playAudioButton1 = document.getElementById('play-audio-button-1');
            const audioContainer1 = document.getElementById('audio-container-1');
            const storyAudio2 = document.getElementById('story-audio-2');
            const playAudioButton2 = document.getElementById('play-audio-button-2');
            const audioContainer2 = document.getElementById('audio-container-2'); 
            const galleryModal = document.getElementById('galleryModal');
            const galleryContainer = document.getElementById('gallery-container');
            const fullImageDisplayModal = document.getElementById('full-image-display');
            const fullImageDisplay = document.getElementById('fullImageDisplay');
            const helpModal = document.getElementById('helpModal');
            const helpTextDisplay = document.getElementById('help-text-display');
            const helpNextButton = document.getElementById('help-next-button');
            const helpPrevButton = document.getElementById('help-prev-button');
            const helpCloseButton = document.getElementById('help-close-button');
            const roomLinkButton = document.getElementById('room-link-button'); 
            const roomLinkContainer = document.getElementById('room-link-container');
            const distanceModal = document.getElementById('distanceModal');
            const distanceDisplay = document.getElementById('distance-modal-display');
            // Elt√°vol√≠tottam a distanceStatus v√°ltoz√≥t

            // --- VAL√ìDI GPS FUNKCI√ìK (CSAK A TEMPLATE-HEZ KELL) ---

            function tavolsagotKiszamol(lat1, lon1, lat2, lon2) {
                const R = 6371e3; 
                const œÜ1 = lat1 * Math.PI / 180;
                const œÜ2 = lat2 * Math.PI / 180;
                const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
                const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

                const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                        Math.cos(œÜ1) * Math.cos(œÜ2) *
                        Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

                return R * c; 
            }

            function updateLocation(position) {
                const userLat = position.coords.latitude;
                const userLon = position.coords.longitude;
                const tavolsag = tavolsagotKiszamol(userLat, userLon, TARGET_LAT, TARGET_LON);
                
                distanceDisplay.textContent = `${Math.round(tavolsag)} M`;
                // Elt√°vol√≠tottam a distanceStatus.textContent friss√≠t√©seket

                if (tavolsag <= TARGET_RADIUS_M) {
                    // distanceStatus.textContent = "C√©lpont el√©rve! √Åtir√°ny√≠t√°s..."; // R√©gi k√≥d
                    
                    if (watchId) {
                        navigator.geolocation.clearWatch(watchId);
                        watchId = null;
                    }
                    
                    setTimeout(() => {
                         distanceModal.style.display = 'none';
                         currentPartIndex = 1; // √Åll√≠tsuk be a k√∂vetkez≈ë indexet, amit a GPS el√©r√©se ut√°n szeretn√©nk
                         saveProgress();
                         showStoryPart();
                    }, 1500);
                }
            }

            function locationError(error) {
                console.error(`Geolocation error: ${error.message}`);
                // distanceStatus.textContent = `Hiba: ${error.message}. K√©rj√ºk, enged√©lyezze a helymeghat√°roz√°st.`; // R√©gi k√≥d
                distanceDisplay.textContent = "-- M";
                if (watchId) {
                    navigator.geolocation.clearWatch(watchId);
                    watchId = null;
                }
            }

            function startCompassTracking() {
                if (navigator.geolocation) {
                    const options = {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    };
                    watchId = navigator.geolocation.watchPosition(updateLocation, locationError, options);
                } else {
                    // console.error("A helymeghat√°roz√°s nem t√°mogatott a b√∂ng√©sz≈ëj√©ben."); // R√©gi k√≥d
                }
            }

            function showDistanceModal() { 
                distanceModal.style.display = 'flex';
                // distanceStatus.textContent = "Helyzetmeghat√°roz√°s ind√≠t√°sa..."; // R√©gi k√≥d
                distanceDisplay.textContent = "-- M";
                
                distanceModalMapButton.href = GPS_MODAL_MAP_URL;

                if (!watchId) {
                    startCompassTracking();
                }
            }
            
            // --- J√ÅT√âK √ÅLLAPOT KEZEL√âS ---

            function saveProgress() {
                localStorage.setItem('gameProgress', currentPartIndex);
            }

            function loadProgress() {
                const savedIndex = localStorage.getItem('gameProgress');
                // Kezdj√ºk az 1-es indexn√©l, ha nincs ment√©s
                if (savedIndex !== null) {
                    currentPartIndex = Math.min(parseInt(savedIndex), storyPages.length - 1); 
                } else {
                    currentPartIndex = 1;
                }
            }
            
            function stopAllAudio() {
                storyAudio1.pause();
                storyAudio1.currentTime = 0;
                playAudioButton1.innerHTML = "‚ñ∂Ô∏è Lej√°tsz√°s (1)";
                storyAudio2.pause();
                storyAudio2.currentTime = 0;
                playAudioButton2.innerHTML = "‚ñ∂Ô∏è Lej√°tsz√°s (2)";
            }

            function toggleAudio(audioElement, buttonElement, buttonText) {
                if (audioElement.paused) {
                    stopAllAudio(); 
                    audioElement.play().catch(error => {
                        console.error('Autoplay failed, user interaction needed.', error);
                    });
                    buttonElement.innerHTML = `‚è∏Ô∏è Sz√ºnet (${buttonText})`;
                } else {
                    audioElement.pause();
                    buttonElement.innerHTML = `‚ñ∂Ô∏è Lej√°tsz√°s (${buttonText})`;
                }
            }
            
            // Mod√°l bez√°r√≥ f√ºggv√©nyek hozz√°ad√°sa
            window.closeGalleryModal = function() {
                galleryModal.style.display = 'none';
            }

            window.closeFullImageModal = function() {
                fullImageDisplayModal.style.display = 'none';
            }


            // GAL√âRIA FUNKCI√ìK
            function populateGallery() {
                galleryContainer.innerHTML = ''; 
                
                const visibleItems = ALL_GALLERY_ITEMS.filter(item => {
                    const isUnlocked = localStorage.getItem(`is${item.id.charAt(0).toUpperCase() + item.id.slice(1)}Unlocked`) === 'true';
                    return item.unlocked || item.unlockedByDefault; // Hozz√°adtuk az alap√©rtelmezett nyit√°st
                });

                visibleItems.forEach((image) => {
                    const thumbnailDiv = document.createElement('div');
                    thumbnailDiv.className = 'gallery-thumbnail';
                    const img = document.createElement('img');
                    img.src = image.url;
                    img.alt = image.title;
                    thumbnailDiv.onclick = () => openFullImage(image.url);
                    thumbnailDiv.appendChild(img);
                    
                    const title = document.createElement('div');
                    title.style.cssText = `
                        position: absolute; bottom: 0; left: 0; right: 0; 
                        background-color: rgba(0, 0, 0, 0.7); 
                        color: white; font-size: 0.9em; padding: 5px; 
                        text-align: center;
                    `;
                    title.textContent = image.title;
                    thumbnailDiv.appendChild(title);
                    galleryContainer.appendChild(thumbnailDiv);
                });
            }
            
            function setScaleTransform() {
                fullImageDisplay.style.transform = `scale(${currentScale})`;
                fullImageDisplay.style.cursor = currentScale > MIN_SCALE ? 'zoom-out' : 'zoom-in';
            }

            function toggleZoom() {
                if (currentScale > MIN_SCALE) {
                    currentScale = MIN_SCALE; // Zoom Out
                } else {
                    currentScale = MAX_SCALE; // Zoom In
                }
                setScaleTransform();
            }

            function openFullImage(imageUrl) {
                fullImageDisplay.src = imageUrl;
                
                // RESET ZOOM
                currentScale = MIN_SCALE; 
                setScaleTransform(); 
                
                fullImageDisplayModal.style.display = 'flex'; 
                galleryModal.style.display = 'none'; 
            }
            
            window.openFullImage = openFullImage; // Glob√°lis el√©rhet≈ës√©g
            
            function openGallery() {
                populateGallery(); 
                galleryModal.style.display = "block";
            }

            // S√∫g√≥ Modal Vez√©rl√©s
            function closeHelpModal() {
                helpModal.style.display = 'none';
            }

            function updateHelpModal() {
                const currentPage = storyPages[currentPartIndex];
                const currentHelpMessages = currentPage.helpMessages || [currentPage.helpMessage || "Nincs seg√≠ts√©g."];

                if (currentHelpIndex < currentHelpMessages.length) {
                    helpTextDisplay.textContent = currentHelpMessages[currentHelpIndex];
                    helpModal.style.display = 'block';

                    helpPrevButton.style.display = (currentHelpIndex > 0) ? 'block' : 'none';
                    
                    const isLastStep = currentHelpIndex === currentHelpMessages.length - 1;
                    
                    helpNextButton.style.display = isLastStep ? 'none' : 'block';
                    helpCloseButton.style.display = 'block'; 
                    
                    if (isLastStep) {
                        helpCloseButton.textContent = 'Bez√°r√°s';
                    } else {
                        helpCloseButton.textContent = 'Bez√°r√°s';
                    }
                    
                    if (currentHelpIndex === 0 && currentHelpMessages.length > 1) {
                        helpNextButton.style.display = 'block';
                    }
                    
                } else {
                    closeHelpModal();
                }
            }

            function nextHelpStep() {
                const currentPage = storyPages[currentPartIndex];
                const currentHelpMessages = currentPage.helpMessages || [currentPage.helpMessage || "Nincs seg√≠ts√©g."];

                if (currentHelpIndex < currentHelpMessages.length - 1) {
                    currentHelpIndex++;
                    updateHelpModal();
                } else {
                    closeHelpModal(); 
                }
            }
            
            function prevHelpStep() {
                if (currentHelpIndex > 0) {
                    currentHelpIndex--;
                    updateHelpModal();
                } 
            }


            // --- T√ñRT√âNET/INTERAKCI√ì FUNKCI√ìK ---

            function updateButtons() {
                stopAllAudio(); 
                multiChoiceContainer.style.display = 'none'; 
                passwordContainer.classList.remove('visible');
                discreetBackButton.style.display = 'none'; 
                roomLinkContainer.style.display = 'none';
                
                nextButton.classList.remove('full-width'); 
                interactionContainer.style.justifyContent = 'space-between';
                prevButton.style.display = 'block'; 
                prevButton.disabled = currentPartIndex === 1; // Kezd≈ë index 1

                if (currentPartIndex < storyPages.length && storyPages[currentPartIndex] !== null) {
                    const currentPage = storyPages[currentPartIndex];
                    
                    const isChoicePage = currentPage.type === 'choice';
                    const isPasswordPage = currentPage.type === 'password';
                    const isNoteImage = currentPage.type === 'note_image';

                    
                    if (isChoicePage) {
                        interactionContainer.style.display = 'none';
                        multiChoiceContainer.style.display = 'flex';
                        discreetBackButton.style.display = 'flex';
                        discreetBackButton.disabled = currentPartIndex === 1;

                        const choices = currentPage.choices || [];
                        const choiceButtons = [choice1Button, choice2Button, choice3Button, choice4Button]; 
                        
                        // FIX: Csak az 1. gombot haszn√°ljuk, ha egy v√°laszt√°s van (mint a 3. indexn√©l)
                        // A k√≥d csak egy gombot fog l√°tni a choices t√∂mben, a t√∂bbi rejtve marad a 'display: none' miatt, de biztons√°gb√≥l megn√©zz√ºk a length-et
                        
                        choiceButtons.forEach((button, index) => {
                            if (choices[index]) {
                                button.style.display = 'block';
                                button.textContent = choices[index].text;
                                button.dataset.nextIndex = choices[index].nextIndex;
                            } else {
                                button.style.display = 'none';
                            }
                        });

                    } else if (isPasswordPage) {
                        interactionContainer.style.display = 'none';
                        multiChoiceContainer.style.display = 'none';
                        passwordContainer.classList.add('visible');
                        
                        if (passwordPromptSpan) {
                            // Fix: A jelsz√≥ prompt sz√∂vege be√°ll√≠t√°sa a felhaszn√°l√≥ k√©r√©s√©nek megfelel≈ëen
                            passwordPromptSpan.textContent = "Mi a k√≥d";
                        }

                        passwordInput.type = currentPage.isCaseInsensitive ? 'text' : 'password';
                        backButtonPassword.style.display = currentPage.backIndex !== undefined ? 'block' : 'none';
                        
                        // Seg√≠ts√©g gomb megjelen√≠t√©se, ha van helpMessage VAGY helpMessages
                        const hasHelp = currentPage.helpMessage || (currentPage.helpMessages && currentPage.helpMessages.length > 0);
                        if (helpButton) {
                            helpButton.style.display = hasHelp ? 'block' : 'none';
                        }
                        
                    } else {
                        interactionContainer.style.display = 'flex';
                        
                        const customText = currentPage.nextButtonText;
                        const nextIndexDefined = currentPage.nextIndex !== undefined;
                        
                        nextButton.textContent = customText || 'Tov√°bb';
                        nextButton.dataset.forcedNextIndex = nextIndexDefined ? currentPage.nextIndex : '';

                        if (isNoteImage) {
                            if (currentPage.backIndex !== undefined) {
                                nextButton.classList.remove('full-width'); 
                                prevButton.style.display = 'block'; 
                                prevButton.disabled = false; 
                            } else {
                                nextButton.classList.add('full-width'); 
                                prevButton.style.display = 'none'; 
                            }
                        } else {
                            // C√©lpont keres√©se gomb, ha van customAction
                            if (currentPage.customAction === 'open_distance_modal') {
                                nextButton.textContent = 'C√©lpont keres√©se (GPS)';
                                nextButton.classList.add('full-width'); 
                                prevButton.style.display = 'none'; 
                            } else {
                                prevButton.style.display = 'block'; 
                                prevButton.disabled = currentPartIndex === 1; // Kezd≈ë index 1
                            }
                        }
                    }

                }
            }

            function updateAvatar(pageIndex) {
                const currentPage = storyPages[pageIndex];
                if (!currentPage) return;
                
                const speaker = currentPage.speaker;
                
                let avatarUrl = MARK_AVATAR_URL;
                let display = 'block';
                
                if (speaker === 'Mark' || speaker === 'M') { 
                    avatarUrl = MARK_AVATAR_URL;
                } else if (speaker === 'Anna' || speaker === 'A') { 
                    avatarUrl = ANNA_AVATAR_URL;
                } else { 
                    // Narr√°tor, vagy ismeretlen besz√©l≈ë: elrejtj√ºk az avat√°rt
                    display = 'none'; 
                }
                
                avatarImg.src = avatarUrl;
                avatarImg.style.display = display;
            }
            
            function resetLocalStorage() {
                localStorage.clear();
                ALL_GALLERY_ITEMS.forEach(item => {
                    localStorage.removeItem(`is${item.id.charAt(0).toUpperCase() + item.id.slice(1)}Unlocked`);
                });
                console.log("Local Storage resetelve.");
            }


            function showStoryPart() {
                messageDisplay.textContent = ''; 
                passwordInput.value = ''; 
                // contentBox.style.opacity = 0; // T√∂r√∂lve, CSS-ben alapb√≥l 1.0

                // FIX: A tartalom azonnali l√°that√≥s√°ga
                contentBox.style.opacity = 1; 

                // A setTimeout itt m√°r csak a k√∂vetkez≈ë l√©p√©sre v√°r, nem a tartalom megjelen√≠t√©s√©re
                setTimeout(() => { 
                    stopAllAudio(); 
                    audioContainer1.style.display = 'none';
                    audioContainer2.style.display = 'none';
                    storyDisplay.innerHTML = ''; // Alap√©rtelmezett, √ºres sz√∂veg
                    
                    passwordContainer.classList.remove('visible'); 

                    if (currentPartIndex >= storyPages.length || storyPages[currentPartIndex] === null) {
                        // V√âGE vagy hib√°s index: Ugr√°s a legels≈ë t√∂rt√©netpontra (Index 1)
                        currentPartIndex = 1; 
                    }
                    
                    const currentPage = storyPages[currentPartIndex];

                    if (currentPage) {
                        
                        if (currentPage.type !== 'password') {
                            currentHelpIndex = 0; 
                            closeHelpModal();
                        }
                        
                        if (currentPage.reset === true) {
                            resetLocalStorage();
                        }
                        
                        if (currentPage.removeImage) {
                            localStorage.removeItem(`is${currentPage.removeImage.charAt(0).toUpperCase() + currentPage.removeImage.slice(1)}Unlocked`);
                        }

                        if (currentPage.unlockImage) {
                            localStorage.setItem(`is${currentPage.unlockImage.charAt(0).toUpperCase() + currentPage.unlockImage.slice(1)}Unlocked`, 'true');
                        }
                        
                        updateAvatar(currentPartIndex); 
                        
                        if (currentPage.type === 'password' || currentPage.type === 'text' || currentPage.type === 'choice' || currentPage.type === 'note_image') {
                            if (currentPage.content.trim() !== '') {
                                storyDisplay.innerHTML = currentPage.content;
                            }
                        }
                        
                        if (currentPage.type === 'note_image' && currentPage.noteImageUrl) {
                            const imageHtml = `
                                <div class="note-image-container" style="text-align: center; margin-top: 15px;">
                                    <img src="${currentPage.noteImageUrl}" alt="K√≥dolt √ºzenet" 
                                        style="max-width: 100%; height: auto; border-radius: 5px; cursor: pointer;"
                                        onclick="openFullImage('${currentPage.noteImageUrl}')">
                                </div>`;
                            storyDisplay.innerHTML += imageHtml;
                        }
                        
                        // K√©pv√°lt√°s
                        let imageUrl;
                        if (currentPage.image === 'Fulke1.jpg') {
                             imageUrl = FULKE1_IMAGE_URL;
                        } else {
                             imageUrl = OSZLOP_IMAGE_URL; // Alap√©rtelmez√©s az oszlop.jpg
                        }

                        if (storyImage.src.indexOf(imageUrl) === -1) { 
                            storyImage.src = imageUrl; 
                        }
                        
                    }

                    // contentBox.style.opacity = 1; // T√∂r√∂lve
                    updateButtons();
                }, 100); 
            }
            
            // --- ESEM√âNYKEZEL≈êK ---
            
            fullImageDisplay.addEventListener('dblclick', (e) => {
                 e.preventDefault();
                 toggleZoom();
            });
            
            window.openFullImage = openFullImage; // Glob√°lis el√©rhet≈ës√©g

            nextButton.addEventListener('click', () => {
                const currentPage = storyPages[currentPartIndex];
                
                // Ha a GPS mod√°lt kell megnyitni, megnyitjuk √©s visszat√©r√ºnk.
                if (currentPage.customAction === 'open_distance_modal') {
                     showDistanceModal();
                     return;
                }

                if (currentPage.nextButtonExternalUrl) {
                    window.location.href = currentPage.nextButtonExternalUrl; 
                    return;
                }

                
                const forcedNextIndex = nextButton.dataset.forcedNextIndex;
                if (forcedNextIndex !== undefined && forcedNextIndex !== '') {
                    currentPartIndex = parseInt(forcedNextIndex);
                } else {
                    currentPartIndex++;
                }
                
                // Ugr√°s a k√∂vetkez≈ë √©rv√©nyes indexre, ha a k√∂vetkez≈ë null (pl. 4 vagy 5)
                while(currentPartIndex < storyPages.length && storyPages[currentPartIndex] === null) {
                    currentPartIndex++;
                }

                saveProgress();
                showStoryPart();
            });

            prevButton.addEventListener('click', () => {
                const currentPage = storyPages[currentPartIndex];
                
                let targetIndex = currentPage.backIndex !== undefined ? currentPage.backIndex : currentPartIndex - 1;

                if (targetIndex >= 1) {
                    currentPartIndex = targetIndex;
                } else {
                    currentPartIndex = 1;
                }

                saveProgress();
                showStoryPart();
            });

            backButtonPassword.addEventListener('click', () => {
                const currentPage = storyPages[currentPartIndex];
                if (currentPage.type === 'password' && currentPage.backIndex !== undefined) {
                    currentPartIndex = currentPage.backIndex;
                    saveProgress();
                    showStoryPart();
                }
            });

            checkButton.addEventListener('click', () => {
                const currentPage = storyPages[currentPartIndex];
                if (currentPage.type !== 'password') return;

                const enteredPassword = passwordInput.value.trim();
                const correctPassword = currentPage.correctPassword;
                const isCaseInsensitive = currentPage.isCaseInsensitive || false;
                
                let isCorrect = false;
                if (isCaseInsensitive) {
                    isCorrect = enteredPassword.toLowerCase() === correctPassword.toLowerCase();
                } else {
                    isCorrect = enteredPassword === correctPassword;
                }
                
                if (isCorrect) {
                    messageDisplay.textContent = 'K√≥d elfogadva!';
                    messageDisplay.style.color = '#00FF00';
                    
                    setTimeout(() => {
                        const nextIndex = currentPage.nextIndexSuccess;
                        if (nextIndex !== undefined) {
                            currentPartIndex = nextIndex; 
                            saveProgress();
                            
                            // FIX: Check if the success page (now index 23) has the GPS trigger action
                            const successPage = storyPages[currentPartIndex];
                            if (successPage && successPage.customAction === 'open_distance_modal') {
                                // Ha a k√∂vetkez≈ë oldal a GPS trigger, azonnal nyissuk meg a mod√°lt
                                showDistanceModal(); 
                            } else {
                                // K√ºl√∂nben mutassuk a k√∂vetkez≈ë oldalt norm√°lisan
                                showStoryPart(); 
                            }
                        }
                    }, 1000); // 1 m√°sodperc a "K√≥d elfogadva" √ºzenet megjelen√≠t√©s√©re
                    
                } else {
                    messageDisplay.textContent = 'Helytelen jelsz√≥! Pr√≥b√°ld √∫jra.';
                    messageDisplay.style.color = '#ff4500';
                    passwordInput.value = '';
                }
            });

            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    checkButton.click(); 
                }
            });
            
            imageButton.addEventListener('click', openGallery);
            mapButton.addEventListener('click', () => {
                 window.open(MENU_MAP_URL, '_blank');
            });
            
            // S√∫g√≥ gombok kezel√©se
            helpButton.addEventListener('click', (e) => {
                const currentPage = storyPages[currentPartIndex];
                if (currentPage.type === 'password') {
                    e.preventDefault();
                    currentHelpIndex = 0;
                    updateHelpModal();
                }
            });

            helpNextButton.addEventListener('click', nextHelpStep);
            helpPrevButton.addEventListener('click', prevHelpStep);
            helpCloseButton.addEventListener('click', closeHelpModal);
            
            
            [choice1Button, choice2Button, choice3Button, choice4Button].filter(Boolean).forEach((button, index) => {
                button.addEventListener('click', (e) => {
                    const currentPage = storyPages[currentPartIndex];
                    const chosenChoice = currentPage.choices ? currentPage.choices[index] : null;

                    if (chosenChoice && chosenChoice.externalUrl) {
                        window.open(chosenChoice.externalUrl, '_blank');
                    }

                    const chosenNextIndex = parseInt(e.currentTarget.dataset.nextIndex);
                    
                    currentPartIndex = chosenNextIndex;
                    
                    saveProgress();
                    showStoryPart();
                });
            });

            discreetBackButton.addEventListener('click', () => {
                const currentPage = storyPages[currentPartIndex];
                let targetIndex = currentPage.backIndex !== undefined ? currentPage.backIndex : currentPartIndex - 1;
                
                if (targetIndex >= 1) {
                     currentPartIndex = targetIndex;
                } else {
                    currentPartIndex = 1; // Legal√°bb a kezd≈ëoldalra ugr√°s
                }

                saveProgress();
                showStoryPart();
            });


            function initializeApp() {
                loadProgress(); 
                showStoryPart();
                distanceModal.style.display = 'none';
            }

            // FIX: Gyorsabb inicializ√°l√°s
            document.addEventListener('DOMContentLoaded', initializeApp);
        })(); 
    </script>
</body>
</html>
