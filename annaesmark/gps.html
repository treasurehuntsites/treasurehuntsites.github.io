<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS K√∂vet√©s Mozg√≥ C√©lponttal √©s K√∂r√∂kkel</title>
    <!-- Leaflet (t√©rk√©p) k√∂nyvt√°r CSS √©s JS bet√∂lt√©se -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAo9T0XLYJk976X4UaT68Q8z16jB22p2D30T4uY="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-2qE2C2b2r2A60k52J67B547w379xM9M3r50Lq7v8i7Q="
            crossorigin=""></script>

    <style>
        /* Alapvet≈ë Tailwind-szer≈± st√≠lusok √©s reszponzivit√°s */
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; background-color: #f0f4f8; text-align: center; }
        .container { 
            max-width: 90%; 
            margin: 20px auto; 
            padding: 20px; 
            background-color: #fff; 
            border-radius: 12px; 
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1); 
        }
        h1 { color: #1e3a8a; margin-top: 0; }
        p { color: #4b5563; }
        #map { 
            height: 500px; 
            width: 100%; 
            margin-top: 20px; 
            border: 1px solid #cce; 
            border-radius: 8px; 
        }
        .info-box {
            padding: 15px;
            border-radius: 8px;
            background-color: #e0f2f7;
            border-left: 5px solid #0ea5e9;
            margin-bottom: 15px;
            text-align: left;
        }
        .distance-info { font-size: 1.3em; font-weight: bold; color: #007bff; margin-top: 5px; }
        .distance-warning { color: #ef4444; font-weight: bold; animation: pulse 1s infinite; }
        .status-info { color: #059669; font-weight: 500; }

        /* Anim√°ci√≥ az √°tir√°ny√≠t√°si figyelmeztet√©shez */
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.02); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Egyedi ikonok Leaflet-hez (CSS alap√∫ k√∂r√∂k) */
        /* PIROS: Felhaszn√°l√≥ aktu√°lis poz√≠ci√≥ja */
        .leaflet-marker-icon.user-icon { background-color: #dc2626; border-radius: 50%; border: 3px solid white; width: 22px !important; height: 22px !important; margin-left: -11px !important; margin-top: -11px !important; }
        /* K√âK: K√∂zeled≈ë c√©lpont */
        .leaflet-marker-icon.target-icon { background-color: #2563eb; border-radius: 50%; border: 3px solid white; width: 22px !important; height: 22px !important; margin-left: -11px !important; margin-top: -11px !important; }
        /* Z√ñLD: Kezdeti poz√≠ci√≥ (fix pont) */
        .leaflet-marker-icon.start-point-icon div { background-color: #059669; border-radius: 50%; border: 3px solid white; width: 22px; height: 22px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>üß≠ GPS K√∂vet√©s & Mozg√≥ C√©lpont</h1>
        <p>A t√©rk√©p a kezdeti poz√≠ci√≥dt√≥l sz√°m√≠tott k√∂r√∂ket √©s a k√∂zeled≈ë c√©lpontot mutatja. Mozdulj el a pontt√≥l, hogy l√°sd a mozg√°st!</p>
        
        <div class="info-box">
            <div id="status-info" class="status-info">V√°rjuk a GPS poz√≠ci√≥t... (Enged√©lyezd a helymeghat√°roz√°st)</div>
            <div id="distance-info" class="distance-info"></div>
        </div>

        <div id="map"></div>
    </div>

    <script>
        // --- 1. Konfigur√°ci√≥ ---
        const REDIRECT_URL = "https://www.google.com";   // √Åtir√°ny√≠t√°si c√©l
        const START_DISTANCE_METERS = 50;               // C√©lpont kezdeti t√°vols√°ga (50m)
        const REDIRECT_RADIUS_METERS = 10;              // √Åtir√°ny√≠t√°si k√ºsz√∂b (10m)
        const TARGET_SPEED_KPH = 5;                     // C√©lpont sebess√©ge (5 km/h)
        // Sebess√©g m/s-ban: (5000 / 3600)
        const TARGET_SPEED_MPS = TARGET_SPEED_KPH * 1000 / 3600; 

        const CIRCLE_INTERVAL_METERS = 5;               // K√∂r√∂k k√∂z√∂tti t√°vols√°g (5m-k√©nt)
        const MAX_CIRCLE_RADIUS = 50;                   // Maxim√°lis k√∂r sugara
        
        // √Ållapotv√°ltoz√≥k
        let map;
        let userStartPos = null;    
        let userMarker;             
        let startPointMarker;       
        let targetPos = null;       
        let targetMarker;           
        let lastTargetUpdateTime = Date.now();
        let targetDirection;        
        let trackingStarted = false;
        let circles = [];           
        let watchId;                // GPS k√∂vet√©si azonos√≠t√≥

        // Egyedi ikonok defini√°l√°sa (L.divIcon a Leaflet-hez) - Ezeket csak a v√°ltoz√≥kat deklar√°ljuk itt
        let userIcon;
        let targetIcon;
        let startPointIcon;
        
        // --- 2. Geometriai f√ºggv√©nyek (GPS sz√°m√≠t√°sok) ---
        
        // Konvert√°l√°s radi√°nra √©s fokra
        function toRad(deg) { return deg * (Math.PI / 180); }
        function toDeg(rad) { return rad * (180 / Math.PI); }

        // Haversine t√°vols√°gsz√°m√≠t√°s (m√©terben)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // F√∂ld sugara m√©terben
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // T√°vols√°g m√©terben
        }

        // √öj poz√≠ci√≥ sz√°m√≠t√°sa t√°vols√°gra √©s ir√°nyra egy pontt√≥l
        function calculateNewPosition(lat, lon, distanceMeters, bearing) {
            const R = 6371e3; 
            const dist = distanceMeters / R; 
            const brng = toRad(bearing);

            const lat1 = toRad(lat);
            const lon1 = toRad(lon);

            let lat2 = Math.asin(Math.sin(lat1) * Math.cos(dist) +
                                 Math.cos(lat1) * Math.sin(dist) * Math.cos(brng));
            let lon2 = lon1 + Math.atan2(Math.sin(brng) * Math.sin(dist) * Math.cos(lat1),
                                          Math.cos(dist) - Math.sin(lat1) * Math.sin(lat2));

            return { lat: toDeg(lat2), lon: toDeg(lon2) };
        }

        // K√©t pont k√∂z√∂tti ir√°ny sz√°m√≠t√°sa (bearing fokban)
        function calculateBearing(lat1, lon1, lat2, lon2) {
            const y = Math.sin(toRad(lon2 - lon1)) * Math.cos(toRad(lat2));
            const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
                      Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(toRad(lon2 - lon1));
            return (toDeg(Math.atan2(y, x)) + 360) % 360; 
        }

        // --- 3. Vizu√°lis elemek rajzol√°sa ---

        // K√∂r√∂k rajzol√°sa a kezdeti poz√≠ci√≥ (userStartPos) k√∂r√ºl
        function drawCircles(centerLat, centerLon) {
            // T√∂r√∂lj√ºk a r√©gi k√∂r√∂ket
            circles.forEach(circle => map.removeLayer(circle));
            circles = [];

            for (let r = CIRCLE_INTERVAL_METERS; r <= MAX_CIRCLE_RADIUS; r += CIRCLE_INTERVAL_METERS) {
                const isRedirectZone = (r === REDIRECT_RADIUS_METERS);
                
                const circle = L.circle([centerLat, centerLon], {
                    color: isRedirectZone ? '#ef4444' : '#a855f7', // Piros a 10m-es z√≥n√°n√°l, Lila egy√©bk√©nt
                    fillColor: isRedirectZone ? '#fca5a5' : '#e9d5ff',
                    fillOpacity: isRedirectZone ? 0.2 : 0.1,
                    radius: r,
                    weight: isRedirectZone ? 3 : 1,
                    dashArray: isRedirectZone ? '5, 5' : null 
                }).addTo(map);
                
                // Felirat a k√∂rre (10m-es √©s 50m-es k√∂r√∂n)
                if (r % 10 === 0 || isRedirectZone) {
                     circle.bindTooltip(`${r} m`, { permanent: true, direction: "center", className: 'leaflet-tooltip-distance' });
                }
                circles.push(circle);
            }
        }

        // --- 4. C√©lpont Mozgat√°s Logik√°ja ---

        // C√©lpont kezdeti poz√≠ci√≥j√°nak be√°ll√≠t√°sa (50m-re a felhaszn√°l√≥t√≥l)
        function setupTarget(userLat, userLon) {
            // V√©letlen ir√°ny a kezd≈ëpontt√≥l
            const randomBearing = Math.random() * 360; 
            
            // C√©lpont kezd≈ë poz√≠ci√≥ja 50m-re a userStartPos-t√≥l
            targetPos = calculateNewPosition(userLat, userLon, START_DISTANCE_METERS, randomBearing);
            
            // Ir√°ny (bearing) a c√©lpontb√≥l a kezdeti poz√≠ci√≥ fel√©
            targetDirection = calculateBearing(targetPos.lat, targetPos.lon, userLat, userLon);
            
            lastTargetUpdateTime = Date.now();
        }

        // C√©lpont mozgat√°sa (a userStartPos fel√© 5 km/h sebess√©ggel)
        function moveTarget() {
            const now = Date.now();
            const deltaTimeMs = now - lastTargetUpdateTime;
            lastTargetUpdateTime = now;

            // Kisz√°m√≠tjuk, mennyi t√°vols√°got tett meg m/s sebess√©ggel az eltelt id≈ë alatt
            const distanceMoved = TARGET_SPEED_MPS * (deltaTimeMs / 1000); 

            // Meg√°ll√≠tjuk a c√©lpontot, ha m√°r el√©rte a kezdeti pontot
            let currentDistToStart = calculateDistance(targetPos.lat, targetPos.lon, userStartPos.lat, userStartPos.lon);
            if (currentDistToStart <= 0.1) { 
                targetPos.lat = userStartPos.lat;
                targetPos.lon = userStartPos.lon;
                return;
            }

            // Kisz√°m√≠tjuk a c√©lpont √∫j poz√≠ci√≥j√°t
            const newPos = calculateNewPosition(targetPos.lat, targetPos.lon, distanceMoved, targetDirection);
            targetPos.lat = newPos.lat;
            targetPos.lon = newPos.lon;
        }

        // --- 5. GPS poz√≠ci√≥ friss√≠t√©se √©s f≈ë logika ---
        function updatePosition(position) {
            const userLat = position.coords.latitude;
            const userLon = position.coords.longitude;
            const userCoords = [userLat, userLon];

            // Kezdeti be√°ll√≠t√°sok (csak egyszer fut le az els≈ë sikeres GPS lek√©r√©skor)
            if (!trackingStarted) {
                userStartPos = { lat: userLat, lon: userLon };
                setupTarget(userLat, userLon); 
                trackingStarted = true;
                
                // Ikonok l√©trehoz√°sa itt, miut√°n a Leaflet (L) biztosan bet√∂lt≈ëd√∂tt
                userIcon = L.divIcon({ className: 'user-icon', iconSize: [22, 22], iconAnchor: [11, 11] });
                targetIcon = L.divIcon({ className: 'target-icon', iconSize: [22, 22], iconAnchor: [11, 11] });
                startPointIcon = L.divIcon({ 
                    className: 'start-point-icon', 
                    html: '<div></div>',
                    iconSize: [28, 28],
                    iconAnchor: [14, 14]
                });

                // T√©rk√©p inicializ√°l√°sa
                map = L.map('map').setView(userCoords, 18); // Magas zoom a k√∂r√∂kh√∂z
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(map);

                // Kezd≈ëpont jel√∂l≈ë (fix, z√∂ld)
                startPointMarker = L.marker([userStartPos.lat, userStartPos.lon], { icon: startPointIcon, title: "Kezdeti Poz√≠ci√≥d" }).addTo(map)
                    .bindPopup("Ez a Kezdeti Poz√≠ci√≥d (FIX C√âLPONTJA a mozg√≥ pontnak)").openPopup();

                // Felhaszn√°l√≥ aktu√°lis poz√≠ci√≥j√°nak jel√∂l≈ëje (piros)
                userMarker = L.marker(userCoords, { icon: userIcon, title: "Jelenlegi Poz√≠ci√≥d" }).addTo(map)
                    .bindPopup("Jelenlegi Poz√≠ci√≥d").openPopup();
                
                // C√©lpont jel√∂l≈ë (k√©k)
                targetMarker = L.marker([targetPos.lat, targetPos.lon], { icon: targetIcon, title: "Mozg√≥ C√©lpont" }).addTo(map)
                    .bindPopup("Mozg√≥ C√©lpont (50m-r≈ël indul, 5 km/h sebess√©ggel a kezdeti pont fel√©)").openPopup();

                // K√∂r√∂k rajzol√°sa a kezdeti poz√≠ci√≥ k√∂r√ºl
                drawCircles(userStartPos.lat, userStartPos.lon);
            }

            // 1. C√©lpont mozgat√°sa
            moveTarget();

            // 2. T√°vols√°g sz√°m√≠t√°sa: C√©lpont aktu√°lis poz√≠ci√≥ja √âS a Te aktu√°lis poz√≠ci√≥d k√∂z√∂tt
            const distance = calculateDistance(userLat, userLon, targetPos.lat, targetPos.lon);
            const formattedDistance = distance.toFixed(1);

            // 3. T√©rk√©p √©s jel√∂l≈ëk friss√≠t√©se
            userMarker.setLatLng(userCoords);
            targetMarker.setLatLng([targetPos.lat, targetPos.lon]);
            map.setView(userCoords, map.getZoom(), {animate: true}); 

            document.getElementById('status-info').textContent = `GPS poz√≠ci√≥ utolj√°ra friss√≠tve: ${new Date().toLocaleTimeString()}`;
            document.getElementById('distance-info').innerHTML = 
                `T√°vols√°g a k√∂zeled≈ë c√©lpontt√≥l: **${formattedDistance} m**`;

            // 4. √Åtir√°ny√≠t√°si logika
            if (distance <= REDIRECT_RADIUS_METERS) {
                document.getElementById('distance-info').innerHTML = `<span class="distance-warning">10 m√©teres k√∂rzetbe √©rt a c√©lpont! √Åtir√°ny√≠t√°s a ${REDIRECT_URL} c√≠mre...</span>`;
                // window.location.href = REDIRECT_URL; // √âles √°tir√°ny√≠t√°s
                alert(`√ÅTIR√ÅNY√çT√ÅS! A c√©lpont t√°vols√°ga: ${distance.toFixed(1)} m. (A funkci√≥ fut.)`);
                navigator.geolocation.clearWatch(watchId); 
            }

            console.log(`Poz√≠ci√≥ friss√≠tve: ${userLat.toFixed(5)}, C√©lpont: ${targetPos.lat.toFixed(5)}. T√°vols√°g: ${formattedDistance} m`);
        }

        // --- 6. Hiba kezel√©se √©s Ind√≠t√°s ---
        function errorCallback(error) {
            let message = "Hiba a GPS-szel! K√©rlek enged√©lyezd a helymeghat√°roz√°st √©s pr√≥b√°lj √∫jra.";
            
            // Explicit napl√≥z√°s a hiba beazonos√≠t√°s√°hoz, m√©g ha az objektum √ºres is
            const consoleMsg = `GPS Error Code: ${error.code} | Message: ${error.message || 'Nincs √ºzenet.'}`;
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = "Enged√©ly megtagadva! (Hibak√≥d: 1). K√©rlek, ellen≈ërizd a b√∂ng√©sz≈ë √©s a telefon/t√°blag√©p helymeghat√°roz√°si be√°ll√≠t√°sait.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = "Poz√≠ci√≥ nem el√©rhet≈ë! (Hibak√≥d: 2). Gyenge GPS v√©tel (pl. belt√©r) vagy kikapcsolt helymeghat√°roz√°si szolg√°ltat√°s.";
                    break;
                case error.TIMEOUT:
                    message = "Poz√≠ci√≥ lek√©rdez√©s t√∫ll√©pte az id≈ëkeretet (30 mp). (Hibak√≥d: 3). K√©rlek, helyezkedj el jobb v√©tel≈± helyen (pl. szabadban).";
                    break;
            }
            document.getElementById('status-info').innerHTML = `<span class="distance-warning">${message}</span>`;
            console.error(consoleMsg, error); // Napl√≥zzuk a r√©szleteket
        }
        
        // F≈ë ind√≠t√°si logika
        window.onload = function() {
            if ("geolocation" in navigator) {
                // ID≈êKERET 30000-re (30 m√°sodperc)
                const options = { enableHighAccuracy: true, timeout: 30000, maximumAge: 0 }; 
                // Elind√≠tjuk a folyamatos k√∂vet√©st
                watchId = navigator.geolocation.watchPosition(updatePosition, errorCallback, options);
            } else {
                document.getElementById('status-info').innerHTML = `<span class="distance-warning">A b√∂ng√©sz≈ë nem t√°mogatja a helymeghat√°roz√°st.</span>`;
            }
        };

    </script>

</body>
</html>
