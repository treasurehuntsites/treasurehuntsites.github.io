<!doctype html>
<html lang="hu">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=10.0">
    <title id="app-title">J√°t√©k Konfigur√°ci√≥ √©s Futtat√≥ (V. 6)</title>
    
    <!-- Tailwind CSS a modern √©s reszponz√≠v st√≠lushoz -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* --- Admin UI St√≠lusok (K√âRT FORM√ÅTUM) --- */
        @import url('https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap');

        /* F≈ë Admin St√≠lusok */
        .admin-body { font-family: 'Inter', sans-serif; background-color: #1a1a1a; color: #e0e0e0; transition: background-color 0.3s, color 0.3s; }
        .card { background-color: #2c2c2c; border: 2px solid #8a2be2; box-shadow: 0 0 20px rgba(138, 43, 226, 0.4); }
        .input-style { background-color: #3f3f46; color: #00ffff; border: 1px solid #6b7280; }
        .btn-primary { background-color: #8a2be2; color: white; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #7b1cd1; }
        .btn-secondary { background-color: #00ffff; color: #1a1a1a; font-weight: bold; transition: background-color 0.2s; }
        .btn-secondary:hover { background-color: #00ddee; }
        .btn-add { background-color: #007bff; color: white; transition: background-color 0.2s; }
        .btn-add:hover { background-color: #0069d9; }
        .btn-danger { background-color: #dc3545; color: white; transition: background-color 0.2s; }
        .btn-danger:hover { background-color: #c82333; }
        .hidden { display: none !important; }
        
        /* Preview specifikus st√≠lusok */
        .game-preview-box {
            background-color: rgba(0, 0, 0, 0.85); border: 2px solid #8a2be2; border-radius: 10px;
            padding: 20px; margin-top: 20px; position: relative; color: #e0e0e0; font-family: 'Play', sans-serif;
            background-size: cover; background-position: center;
        }
        .preview-avatar { width: 60px; height: 60px; border-radius: 50%; border: 2px solid #00ffff; object-fit: cover; margin-right: 15px; }
        .preview-btn { background-color: #8a2be2; color: white; padding: 8px 16px; border-radius: 4px; font-weight: bold; text-transform: uppercase; font-size: 0.8rem; margin: 2px; }

        /* --- J√°t√©k UI St√≠lusok (KERES) --- */
        
        :root {
            --bg-color-game: #1a1a1a;
            --text-color-game: #e0e0e0;
        }

        .game-ui-container {
            position: relative; min-height: 100vh; display: flex; flex-direction: column; align-items: center;
            font-family: 'Play', sans-serif; margin: 0; padding: 0; overflow-y: auto; touch-action: auto; 
            text-align: center; padding-bottom: 60px; background-color: var(--bg-color-game);
            color: var(--text-color-game);
        }

        /* KRITIKUS: Kezdeti elrejt√©s mind az Admin m√≥dban, mind az export√°lt f√°jlban */
        .initial-hide { display: none; }

        .full-width-image-container {
            width: 100%; height: 100vh; overflow: hidden; position: absolute; top: 0; left: 0; z-index: 0; min-height: 100vh; background-color: #111111;
        }
        .full-width-image-container img { width: 100%; height: 100%; object-fit: cover; object-position: center top; display: block; }

        .content-box {
            background-color: rgba(0, 0, 0, 0.85); padding: 40px 20px 10px 20px; margin: 0; 
            border-radius: 10px 10px 0 0; max-width: 800px; width: calc(100% - 40px);
            box-shadow: 0 0 25px rgba(138, 43, 226, 0.7); border: 3px solid #8a2be2;
            box-sizing: border-box; position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%); 
            z-index: 10; text-align: left; min-height: 250px; display: flex; flex-direction: column; 
            justify-content: space-between; opacity: 1; transition: opacity 0.5s ease-in-out;
        }
        
        .content-hidden-ui { opacity: 0; }

        .discreet-back-button { position: absolute; top: 10px; left: 10px; background: transparent; border: none;
            color: rgba(255, 255, 255, 0.4); font-size: 1.3em; cursor: pointer; z-index: 25; padding: 5px;
        }

        #story-text-display { font-size: 1.2em; font-weight: 700; line-height: 1.6; margin-bottom: 20px; white-space: pre-wrap; flex-grow: 1; }
        
        .audio-container { text-align: center; margin-bottom: 15px; }
        .audio-button {
            padding: 12px 20px; text-decoration: none; color: #1a1a1a; background-color: #00FFFF; border: none; border-radius: 5px;
            font-size: 1.1em; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.4);
        }

        .bottom-bar { padding-top: 10px; border-top: 1px dashed #8a2be2; min-height: 48px; width: 100%; }
        .interaction-container { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .page-button-game-ui {
            padding: 12px 20px; color: #ffffff; background-color: #8a2be2; border: none; border-radius: 5px;
            font-size: 1.1em; font-weight: 700; cursor: pointer; text-transform: uppercase; margin: 5px;
            box-shadow: 0 4px 10px rgba(138, 43, 226, 0.4);
        }
        .page-button-game-ui:disabled { background-color: #555555; cursor: not-allowed; box-shadow: none; opacity: 0.6; }
        
        .multi-choice-container { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        .choice-button {
            background-color: #00FFFF; color: #1a1a1a; padding: 12px 15px; border-radius: 5px; 
            font-weight: bold; font-size: 1.1rem; border: none; width: 100%; cursor: pointer; 
            text-transform: uppercase; box-shadow: 0 2px 5px rgba(0, 255, 255, 0.3); transition: background-color 0.2s;
        }
        
        .avatar-image {
            position: absolute; top: -50px; left: -10px; width: 70px; height: 70px;
            border-radius: 50%; object-fit: cover; z-index: 20; display: block;
            box-shadow: 0 0 8px rgba(0, 255, 255, 0.5); transition: opacity 0.3s ease-in-out; 
        }
        
        .fixed-menu-bar-ui {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 50px;
            background-color: #1a1a1a; border-top: 2px solid #8a2be2; z-index: 50;
            display: flex; justify-content: space-around; align-items: center;
            box-shadow: 0 -4px 15px rgba(138, 43, 226, 0.5);
        }
        .menu-button-ui { background: none; border: none; color: #ffffff; font-size: 1.5em; cursor: pointer; padding: 5px 10px; }
        .menu-button-ui:hover { color: #00ffff; }

        #password-input-ui { padding: 12px; border: 2px solid #8a2be2; border-radius: 5px; background-color: #2c2c2c; color: #00ffff; font-size: 1.2em; text-align: center; font-family: 'Play', sans-serif; }
        .password-interaction { display: flex; justify-content: space-between; align-items: center; gap: 10px; width: 100%; }

        /* GAL√âRIA √âS GPS MOD√ÅLOK - (megtartva a st√≠lust) */
        #galleryModal-ui { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow-y: scroll; background-color: rgba(0, 0, 0, 0.95); }
        #distanceModal-ui { display: none; position: fixed; z-index: 250; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(2px); flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .distance-content { padding: 20px; max-width: 90%; background-color: rgba(0, 0, 0, 0.85); border-radius: 10px; box-shadow: 0 0 30px rgba(0, 255, 255, 0.8); border: 2px solid #00ffff; }

    </style>
</head>
<body class="admin-body">

    <!-- F≈ê KONT√âNER (Admin/Game v√°lt√°shoz) -->
    <div id="main-container" class="w-full h-full">

        <!-- ADMIN/KONFIGUR√ÅCI√ìS FEL√úLET -->
        <div id="admin-mode" class="max-w-4xl mx-auto space-y-8 p-4 md:p-8">
            <h1 class="text-4xl font-bold text-center text-white mb-6">R√©szletes J√°t√©k Konfigur√°ci√≥ (Admin V. 6)</h1>

            <!-- FORM START -->
            <form id="game-config-form">
                <!-- √ÅLTAL√ÅNOS BE√ÅLL√çT√ÅSOK -->
                <div class="card p-6 rounded-xl space-y-6">
                    <h2 class="text-2xl font-semibold text-white border-b border-gray-600 pb-2">√Åltal√°nos Be√°ll√≠t√°sok</h2>
                    
                    <div>
                        <label for="appTitle" class="block text-sm font-medium text-gray-300 mb-1">Weboldal C√≠me (Title)</label>
                        <input type="text" id="appTitle" name="appTitle" value="Anna √©s M√°rk Kincskeres√©s" class="input-style w-full p-3 rounded-lg focus:ring-purple-500 focus:border-purple-500" placeholder="Pl.: Anna √©s M√°rk Kincskeres√©s">
                    </div>

                    <div>
                        <label for="backgroundUrl" class="block text-sm font-medium text-gray-300 mb-1">Alap√©rtelmezett H√°tt√©rk√©p URL (Global)</label>
                        <input type="url" id="backgroundUrl" name="backgroundUrl" value="https://treasurehuntsites.github.io/annaesmark/Img/kr.jpg" class="input-style w-full p-3 rounded-lg focus:ring-purple-500 focus:border-purple-500" placeholder="https://...">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="bgColor" class="block text-sm font-medium text-gray-300 mb-1">H√°tt√©r Sz√≠ne (CSS)</label>
                            <input type="color" id="bgColor" name="bgColor" value="#1a1a1a" class="input-style w-full h-12 rounded-lg">
                        </div>
                        <div>
                            <label for="textColor" class="block text-sm font-medium text-gray-300 mb-1">Sz√∂veg Sz√≠ne (CSS)</label>
                            <input type="color" id="textColor" name="textColor" value="#e0e0e0" class="input-style w-full h-12 rounded-lg">
                        </div>
                    </div>
                </div>
                
                <!-- AVATAR BE√ÅLL√çT√ÅSOK -->
                <div class="card p-6 rounded-xl space-y-4">
                    <h2 class="text-2xl font-semibold text-white border-b border-gray-600 pb-2">Avatar K√©pek Be√°ll√≠t√°sa</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <label for="avatarMUrl" class="block text-sm font-medium text-gray-300 mb-1">M√°rk (¬ßM) Avatar URL</label>
                            <input type="url" id="avatarMUrl" name="avatarMUrl" value="https://treasurehuntsites.github.io/annaesmark/Img/mark.png" class="input-style w-full p-3 rounded-lg" placeholder="https://.../mark.png">
                        </div>
                        <div>
                            <label for="avatarAUrl" class="block text-sm font-medium text-gray-300 mb-1">Anna (¬ßA) Avatar URL</label>
                            <input type="url" id="avatarAUrl" name="avatarAUrl" value="https://treasurehuntsites.github.io/annaesmark/Img/anna.png" class="input-style w-full p-3 rounded-lg" placeholder="https://.../anna.png">
                        </div>
                        <div>
                            <label for="avatarRUrl" class="block text-sm font-medium text-gray-300 mb-1">Rend≈ër/Egy√©b (¬ßR) Avatar URL</label>
                            <input type="url" id="avatarRUrl" name="avatarRUrl" value="https://placehold.co/70x70/1A1A1A/00FF00?text=R" class="input-style w-full p-3 rounded-lg" placeholder="https://.../rendor.png">
                        </div>
                    </div>
                    <div>
                        <label for="avatarDefaultUrl" class="block text-sm font-medium text-gray-300 mb-1">Alap√©rtelmezett (Narr√°tor) Avatar URL</label>
                        <input type="url" id="avatarDefaultUrl" name="avatarDefaultUrl" value="https://placehold.co/70x70/1A1A1A/FFFFFF?text=?" class="input-style w-full p-3 rounded-lg" placeholder="https://placehold.co/70x70/1A1A1A/FFFFFF?text=?">
                    </div>
                </div>
                
                <!-- MEN√ú/GPS BE√ÅLL√çT√ÅSOK -->
                <div class="card p-6 rounded-xl space-y-6">
                    <h2 class="text-2xl font-semibold text-white border-b border-gray-600 pb-2">Men√º √©s GPS Be√°ll√≠t√°sok</h2>
                    
                    <div>
                        <label for="menuMapLink" class="block text-sm font-medium text-gray-300 mb-1">Men√º T√©rk√©p Linkje (F≈ë T√©rk√©p)</label>
                        <input type="url" id="menuMapLink" name="menuMapLink" value="https://maps.google.com" class="input-style w-full p-3 rounded-lg focus:ring-cyan-500 focus:border-cyan-500" placeholder="https://maps.google.com/...">
                    </div>

                    <h3 class="text-xl font-medium text-gray-200 mt-6">C√©lpont Keres√©se (GPS)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="targetLat" class="block text-sm font-medium text-gray-300 mb-1">C√©lpont Sz√©less√©g (Lat)</label>
                            <input type="text" id="targetLat" name="targetLat" value="47.47407" class="input-style w-full p-3 rounded-lg" placeholder="47.47407">
                        </div>
                        <div>
                            <label for="targetLon" class="block text-sm font-medium text-gray-300 mb-1">C√©lpont Hossz√∫s√°g (Lon)</label>
                            <input type="text" id="targetLon" name="targetLon" value="19.04001" class="input-style w-full p-3 rounded-lg" placeholder="19.04001">
                        </div>
                        <div>
                            <label for="successRedirectUrl" class="block text-sm font-medium text-gray-300 mb-1">Siker √Åtir√°ny√≠t√°s URL</label>
                            <input type="text" id="successRedirectUrl" name="successRedirectUrl" value="busz.html" class="input-style w-full p-3 rounded-lg" placeholder="busz.html">
                        </div>
                    </div>
                    
                    <div>
                        <label for="gpsMapLink" class="block text-sm font-medium text-gray-300 mb-1">V√©gpont Keres√©se T√©rk√©p Link (GPS Modal)</label>
                        <input type="url" id="gpsMapLink" name="gpsMapLink" value="https://maps.google.com" class="input-style w-full p-3 rounded-lg focus:ring-cyan-500 focus:border-cyan-500" placeholder="https://maps.google.com/...">
                    </div>
                </div>
                
                <!-- T√ñRT√âNET SZERKESZT√âSE OLDALANK√âNT -->
                <div class="card p-6 rounded-xl space-y-6">
                    <h2 class="text-2xl font-semibold text-white border-b border-gray-600 pb-2">T√∂rt√©net Sz√∂veg Szerkeszt√©se</h2>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="storyPageIndex" class="block text-sm font-medium text-gray-300 mb-1">Oldal kiv√°laszt√°sa (Index)</label>
                            <div class="flex gap-2">
                                <select id="storyPageIndex" class="input-style w-full p-3 rounded-lg text-base flex-grow"></select>
                                <button type="button" id="deletePageButton" class="btn-danger p-3 rounded-lg w-12 flex items-center justify-center" title="Aktu√°lis oldal t√∂rl√©se">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">√ñsszesen: <span id="pageCount">?</span> oldal.</p>
                        </div>
                        <div>
                            <label for="pageType" class="block text-sm font-medium text-gray-300 mb-1">Oldal t√≠pusa</label>
                            <select id="pageType" class="input-style w-full p-3 rounded-lg text-base">
                                <option value="text">Sz√∂veg / P√°rbesz√©d</option>
                                <option value="audio">Audio Lej√°tsz√°s (Gomb)</option>
                                <option value="password">Jelsz√≥ K√©r√©se</option>
                                <option value="choice">El√°gaz√°s (V√°laszt√°s)</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- √ÅLTAL√ÅNOS TARTALOM BLOKK -->
                    <div id="textBlock">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="customAvatarUrl" class="block text-sm font-medium text-green-400 mb-1">Egyedi Avatar URL (Ehhez az oldalhoz)</label>
                                <input type="url" id="customAvatarUrl" class="input-style w-full p-3 rounded-lg" placeholder="https://... (√úres = alap√©rtelmezett)">
                            </div>
                            <div>
                                <label for="customBackgroundUrl" class="block text-sm font-medium text-yellow-400 mb-1">Egyedi H√°tt√©r URL (Ehhez az oldalhoz)</label>
                                <input type="url" id="customBackgroundUrl" class="input-style w-full p-3 rounded-lg" placeholder="https://... (√úres = el≈ëz≈ë h√°tt√©r marad)">
                            </div>
                        </div>
                        
                        <!-- √öJ GAL√âRIA MEZ≈êK -->
                        <div class="mb-4 bg-gray-700/30 p-4 rounded-lg border border-pink-500/30">
                            <label class="block text-sm font-medium text-pink-400 mb-2">Gal√©ria Kezel√©se</label>
                            <div class="flex gap-2">
                                <div class="w-2/3">
                                    <textarea id="customGalleryUrl" rows="3" class="input-style w-full p-3 rounded-lg" placeholder="https://... (URL-ek, soronk√©nt egy)"></textarea>
                                </div>
                                <div class="w-1/3">
                                    <select id="galleryMode" class="input-style w-full p-3 rounded-lg font-bold">
                                        <option value="add_url">K√©p hozz√°ad√°sa (akkumul√°l)</option>
                                        <option value="remove_url">K√©p elt√°vol√≠t√°sa</option>
                                        <option value="clear">Gal√©ria √ºr√≠t√©se</option>
                                    </select>
                                </div>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">Add meg a k√©p URL(ek)et, soronk√©nt egyet. A hozz√°ad√°s/elt√°vol√≠t√°s a list√°ban szerepl≈ë √∂sszes URL-re vonatkozik.</p>
                        </div>

                        <div>
                            <label for="pageContent" class="block text-sm font-medium text-gray-300 mb-1">Oldal Sz√∂vege (Pl. ¬ßM Szia, M√°rk vagyok.)</label>
                            <textarea id="pageContent" rows="5" class="input-style w-full p-3 rounded-lg" placeholder="Pl.: ¬ßA Megvizsg√°ljuk a helysz√≠nt. A sz√∂veg elej√©n l√©v≈ë ¬ßX jel√∂li a besz√©l≈ët."></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div>
                                <label for="nextIndex" class="block text-sm font-medium text-gray-300 mb-1">Ugr√°s Index (Next Index)</label>
                                <input type="number" id="nextIndex" class="input-style w-full p-3 rounded-lg" placeholder="Automatikus ha √ºres">
                            </div>
                            <div>
                                <label for="backIndex" class="block text-sm font-medium text-gray-300 mb-1">Vissza Index (Back Index)</label>
                                <input type="number" id="backIndex" class="input-style w-full p-3 rounded-lg" placeholder="Vissza ugr√°s indexe">
                            </div>
                        </div>
                    </div>

                    <!-- AUDIO SPECIFIKUS BLOKK -->
                    <div id="audioBlock" class="border border-cyan-500 p-4 rounded-lg bg-cyan-900/30 hidden space-y-4">
                        <p class="text-sm font-bold text-cyan-300">AUDIO BE√ÅLL√çT√ÅSOK</p>
                        <div>
                            <label for="audioId" class="block text-sm font-medium text-gray-300 mb-1">Audio F√°jl kiv√°laszt√°sa</label>
                            <select id="audioId" class="input-style w-full p-3 rounded-lg text-base">
                                <option value="1">Audio 1</option>
                                <option value="2">Audio 2</option>
                            </select>
                        </div>
                        <div>
                            <label for="audioNextButtonText" class="block text-sm font-medium text-gray-300 mb-1">Tov√°bb Gomb Sz√∂vege</label>
                            <input type="text" id="audioNextButtonText" class="input-style w-full p-3 rounded-lg" placeholder="Pl.: Megvizsg√°lom a f√ºlk√©t">
                        </div>
                    </div>

                    <!-- JELSZ√ì SPECIFIKUS BLOKK -->
                    <div id="passwordBlock" class="border border-red-500 p-4 rounded-lg bg-red-900/30 hidden space-y-4">
                        <p class="text-sm font-bold text-red-300">JELSZ√ì K√âR√âS BE√ÅLL√çT√ÅSAI</p>
                        <div>
                            <label for="correctPassword" class="block text-sm font-medium text-gray-300 mb-1">Helyes K√≥d / Jelsz√≥</label>
                            <input type="text" id="correctPassword" class="input-style w-full p-3 rounded-lg" placeholder="1940">
                        </div>
                        <div>
                            <label for="nextIndexSuccess" class="block text-sm font-medium text-gray-300 mb-1">Siker Ugr√°s Indexe (haszn√°lj -1-et a GPS-hez)</label>
                            <input type="number" id="nextIndexSuccess" class="input-style w-full p-3 rounded-lg" placeholder="-1 (GPS) vagy Index (pl. 20)">
                        </div>
                        <div class="mt-4">
                            <label for="passwordPromptText" class="block text-sm font-medium text-gray-300 mb-1">K√≥dk√©r≈ë Prompt Sz√∂veg (Glob√°lis)</label>
                            <input type="text" id="passwordPromptText" name="passwordPromptText" value="Add meg a k√≥dot:" class="input-style w-full p-3 rounded-lg" placeholder="Add meg a k√≥dot:">
                        </div>
                    </div>

                    <!-- EL√ÅGAZ√ÅS (CHOICE) SPECIFIKUS BLOKK -->
                    <div id="choiceBlock" class="border border-green-500 p-4 rounded-lg bg-green-900/30 hidden space-y-4">
                        <p class="text-sm font-bold text-green-300 uppercase">El√°gaz√°s Be√°ll√≠t√°sok (Max 4 gomb)</p>
                        <div id="choicesContainer" class="space-y-3">
                            <!-- Itt jelennek meg dinamikusan a v√°laszt√°si sorok -->
                        </div>
                        <button type="button" id="addChoiceBtn" class="btn-secondary w-full p-3 rounded-lg text-sm uppercase font-bold">
                            <i class="fa-solid fa-plus mr-2"></i> √öj v√°laszt√°si gomb hozz√°ad√°sa
                        </button>
                        <p class="text-xs text-gray-400">Add meg a gomb felirat√°t √©s hogy hanyadik oldalra ugorjon (Index).</p>
                    </div>
                    
                    <!-- M√âDIA URL-ek -->
                    <h2 class="text-2xl font-semibold text-white border-b border-gray-600 pb-2 mt-6">Audio M√©dia URL-ek</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="audio1Url" class="block text-sm font-medium text-gray-300 mb-1">Audio 1 URL</label>
                            <input type="url" id="audio1Url" name="audio1Url" value="https://treasurehuntsites.github.io/media/Ugynokok1.mp3" class="input-style w-full p-3 rounded-lg" placeholder="https://.../Ugynokok1.mp3">
                        </div>
                        <div>
                            <label for="audio2Url" class="block text-sm font-medium text-gray-300 mb-1">Audio 2 URL</label>
                            <input type="url" id="audio2Url" name="audio2Url" value="https://treasurehuntsites.github.io/media/Ugynokok2.mp3" class="input-style w-full p-3 rounded-lg" placeholder="https://.../Ugynokok2.mp3">
                        </div>
                    </div>

                    <button type="button" id="addPageButton" class="btn-add w-full p-4 rounded-xl text-lg font-bold uppercase mt-6">
                        <i class="fa-solid fa-plus mr-2"></i> √öj oldal hozz√°ad√°sa a t√∂rt√©nethez
                    </button>
                    
                    <!-- EL≈êN√âZET (PREVIEW) KONT√âNER -->
                    <div id="previewContainer"></div>
                </div>

                <!-- KRITIKUS REJTETT MEZ≈ê AZ EXPORT√ÅLT JSON TARTALOM T√ÅROL√ÅS√ÅHOZ -->
                <textarea id="fullStoryJSON" name="fullStoryJSON" class="hidden"></textarea>
            </form>
            <!-- FORM END -->
            
            <div class="flex flex-col sm:flex-row justify-between gap-4 pt-4">
                <button id="saveButton" type="button" class="btn-primary w-full sm:w-1/3 p-4 rounded-xl text-lg font-bold uppercase">
                    <i class="fa-solid fa-floppy-disk mr-2"></i> Be√°ll√≠t√°sok Ment√©se
                </button>
                <button id="goToGameButton" type="button" class="btn-secondary w-full sm:w-1/3 p-4 rounded-xl text-lg font-bold uppercase text-center flex items-center justify-center">
                    <i class="fa-solid fa-play mr-2"></i> J√°t√©k El≈ën√©zet
                </button>
                <button id="downloadPageButton" type="button" class="bg-pink-600 hover:bg-pink-700 text-white w-full sm:w-1/3 p-4 rounded-xl text-lg font-bold uppercase text-center flex items-center justify-center transition-colors">
                    <i class="fa-solid fa-download mr-2"></i> Export√°l√°s
                </button>
            </div>

            <p id="message" class="text-center mt-4 text-xl font-bold"></p>
        </div>
        
        <!-- J√ÅT√âK FUTTAT√ì FEL√úLET (KERES) -->
        <div id="game-mode" class="initial-hide game-ui-container">
            <!-- VISSZA A ADMINHOZ GOMB (Csak a Preview-ban l√°tszik) -->
            <button onclick="setMode('admin')" class="page-button-game-ui bg-red-600 hover:bg-red-700 fixed top-4 left-4 z-50 p-2 rounded text-sm admin-only-btn">
                <i class="fa-solid fa-gear"></i> Admin
            </button>

            <div class="full-width-image-container">
                <img id="story-image" src="" alt="H√°tt√©r" onerror="this.onerror=null; this.style.opacity='0';">
            </div>

            <div class="content-box content-hidden-ui" id="content-box">
                <!-- Diszkr√©t Vissza Gomb -->
                <button id="discreet-back-button" class="discreet-back-button page-button-game-ui" title="Vissza" disabled style="display: none;">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>

                <img id="avatar-img" class="avatar-image" src="" alt="Avatar" style="display: none;">
                
                <p id="story-text-display" class="text-white text-lg font-bold min-h-[80px]">Bet√∂lt√©s...</p>
                
                <!-- Audio -->
                <div id="audio-container-1" class="audio-container" style="display:none;">
                    <button id="play-audio-button-1" class="audio-button">‚ñ∂Ô∏è Lej√°tsz√°s (1)</button>
                </div>
                <div id="audio-container-2" class="audio-container" style="display:none;">
                    <button id="play-audio-button-2" class="audio-button">‚ñ∂Ô∏è Lej√°tsz√°s (2)</button>
                </div>
                
                <div class="bottom-bar">
                    <div class="interaction-container" id="interaction-container">
                        <button id="prev-page-button" class="page-button-game-ui bg-gray-600 hover:bg-gray-700" disabled>Vissza</button>
                        <button id="next-page-button" class="page-button-game-ui bg-purple-600 hover:bg-purple-700">Tov√°bb</button>
                    </div>
                    
                    <div class="multi-choice-container" id="multi-choice-container" style="display:none;"></div>

                    <div id="password-container" class="flex flex-col gap-3 items-center mt-2" style="display:none;">
                        <p class="text-yellow-400 font-semibold">
                            <span id="password-prompt-text">Add meg a k√≥dot:</span>
                            <button id="help-button" class="menu-button-ui text-white/50 hover:text-cyan-400" style="font-size:1em;padding:0;"><i class="fa-solid fa-circle-question"></i></button>
                        </p>
                        <input type="text" id="password-input" maxlength="12" class="input-style text-center w-full p-2">
                        <div class="password-interaction">
                            <button id="back-button-password" class="page-button-game-ui bg-gray-600">Vissza</button>
                            <button id="check-password-button" class="page-button-game-ui bg-blue-500">ELLEN≈êRZ√âS</button>
                        </div>
                        <p id="message-game" class="font-bold"></p>
                    </div>
                </div>
            </div>
            
            <div class="fixed-menu-bar-ui">
                <button id="map-button" class="menu-button-ui" title="T√©rk√©p"><i class="fa-solid fa-map-location-dot"></i></button>
                <button id="image-button" class="menu-button-ui" title="Gal√©ria / K√©p"><i class="fa-solid fa-image"></i></button>
            </div>
            
            <!-- Mod√°lok (MEGTARTVA A KOR√ÅBBI UI ST√çLUST) -->
            <div id="galleryModal-ui" class="fixed inset-0 z-50 bg-black/95 flex justify-center items-center overflow-auto">
                <span onclick="closeGallery()" class="text-white text-4xl absolute top-4 right-6 cursor-pointer hover:text-cyan-400">√ó</span>
                <div id="gallery-container" class="grid grid-cols-2 gap-4 p-8 max-w-2xl w-full pt-16">
                    <p class="col-span-2 text-center text-gray-500">Jelenleg nincs k√©p a gal√©ri√°ban.</p>
                </div>
            </div>
            
            <div id="distanceModal-ui" class="fixed inset-0 z-50 bg-black/90 flex flex-col justify-center items-center text-white">
                <div class="distance-content">
                    <h1 class="text-2xl font-bold text-cyan-400 mb-4">C√âLPONT KERES√âSE</h1>
                    <div id="distance-modal-display" class="text-5xl font-extrabold text-green-500 my-6">-- M</div>
                    <p id="distance-status" class="text-lg">Helyzetmeghat√°roz√°s...</p>
                    <a href="#" target="_blank" id="distance-modal-map-button" class="page-button-game-ui bg-cyan-500 mt-4">üó∫Ô∏è T√©rk√©p</a>
                </div>
            </div>

            <div id="help-modal-ui" class="hidden fixed inset-0 z-50 bg-black/90 flex flex-col justify-center items-center text-white">
                <div class="distance-content bg-gray-900 border-purple-500">
                    <h2 class="text-xl font-bold text-purple-400 mb-4">Seg√≠ts√©g</h2>
                    <p id="help-text-display" class="mb-4"></p>
                    <div class="flex gap-2 justify-center" style="margin-top:10px;">
                        <button id="help-close-button" class="page-button-game-ui bg-gray-500">Bez√°r√°s</button>
                        <button id="help-next-button" class="page-button-game-ui bg-purple-500" style="display:none;">Tov√°bb</button>
                    </div>
                </div>
            </div>
            
            <audio id="story-audio-1" src="" preload="auto"></audio>
            <audio id="story-audio-2" src="" preload="auto"></audio>
        </div>
    </div>

    <!-- KRITIKUS J√ÅT√âK LOGIKA -->
    <script>
        // --- J√ÅT√âK KONFIGUR√ÅCI√ìS √ÅLLAND√ìK ---
        const REVISION_COUNT = 6; 
        let currentPartIndex = 0; 
        const STORAGE_KEY = 'DYNAMIC_CONFIG';
        const MESSAGE_DISPLAY = document.getElementById('message');

        let currentStoryPages = [];
        let currentLoadedIndex = 0; 

        // --- ADMIN OLDALI DOM ELEMEK (csak a bet√∂lt√©shez) ---
        const fields = {
            appTitle: document.getElementById('appTitle'), backgroundUrl: document.getElementById('backgroundUrl'), bgColor: document.getElementById('bgColor'), textColor: document.getElementById('textColor'),
            avatarMUrl: document.getElementById('avatarMUrl'), avatarAUrl: document.getElementById('avatarAUrl'), avatarRUrl: document.getElementById('avatarRUrl'), avatarDefaultUrl: document.getElementById('avatarDefaultUrl'),
            menuMapLink: document.getElementById('menuMapLink'), targetLat: document.getElementById('targetLat'), targetLon: document.getElementById('targetLon'), successRedirectUrl: document.getElementById('successRedirectUrl'), gpsMapLink: document.getElementById('gpsMapLink'),
            audio1Url: document.getElementById('audio1Url'), audio2Url: document.getElementById('audio2Url'),
            storyPageIndex: document.getElementById('storyPageIndex'), pageCount: document.getElementById('pageCount'), pageType: document.getElementById('pageType'), addPageButton: document.getElementById('addPageButton'),
            deletePageButton: document.getElementById('deletePageButton'),
            textBlock: document.getElementById('textBlock'), pageContent: document.getElementById('pageContent'), customAvatarUrl: document.getElementById('customAvatarUrl'),
            customBackgroundUrl: document.getElementById('customBackgroundUrl'), customGalleryUrl: document.getElementById('customGalleryUrl'), galleryMode: document.getElementById('galleryMode'), 
            nextIndex: document.getElementById('nextIndex'), backIndex: document.getElementById('backIndex'),
            audioBlock: document.getElementById('audioBlock'), audioId: document.getElementById('audioId'), audioNextButtonText: document.getElementById('audioNextButtonText'),
            passwordBlock: document.getElementById('passwordBlock'), passwordPromptText: document.getElementById('passwordPromptText'), correctPassword: document.getElementById('correctPassword'), nextIndexSuccess: document.getElementById('nextIndexSuccess'),
            choiceBlock: document.getElementById('choiceBlock'), choicesContainer: document.getElementById('choicesContainer'), addChoiceBtn: document.getElementById('addChoiceBtn'),
            previewContainer: document.getElementById('previewContainer'),
            fullStoryJSON: document.getElementById('fullStoryJSON')
        };
        
        // Alap√©rtelmezett konfigur√°ci√≥
        const DEFAULT_CONFIG = {
            APP_TITLE: "Anna √©s M√°rk Kincskeres√©s (Alap√©rtelmezett)",
            BACKGROUND_URL: "https://treasurehuntsites.github.io/annaesmark/Img/kr.jpg",
            BODY_BG_COLOR: "#1a1a1a", BODY_TEXT_COLOR: "#e0e0e0",
            MENU_LINKS: { MAP_LINK_URL: 'https://maps.google.com' },
            GPS_COMPASS: { TARGET_LATITUDE: 47.47407, TARGET_LONGITUDE: 19.04001, SUCCESS_REDIRECT_URL: "busz.html", MAP_BUTTON_URL: 'https://maps.google.com', SUCCESS_RADIUS_M: 25 },
            PASSWORD_PAGE: { PROMPT_TEXT: "Add meg a k√≥dot:", ERROR_MESSAGE: 'Helytelen jelsz√≥! Pr√≥b√°ld √∫jra.', SUCCESS_MESSAGE: 'K√≥d elfogadva!' },
            AVATARS: {
                DEFAULT_AVATAR_URL: "https://placehold.co/70x70/1A1A1A/FFFFFF?text=?",
                AVATAR_MAP: { '¬ßM': "https://treasurehuntsites.github.io/annaesmark/Img/mark.png", '¬ßA': "https://treasurehuntsites.github.io/annaesmark/Img/anna.png", '¬ßR': "https://placehold.co/70x70/1A1A1A/00FF00?text=R" },
                HIDDEN_PREFIXES: ['¬ßN', '¬ßKOD', '¬ßH', '¬ßRESET']
            },
            MEDIA: { AUDIO_1_URL: "https://treasurehuntsites.github.io/media/Ugynokok1.mp3", AUDIO_2_URL: "https://treasurehuntsites.github.io/media/Ugynokok2.mp3" },
            storyPages: [
                { type: 'text', content: '¬ßA M√°rk, azt hiszem megfeletkezt√ºnk valamir≈ël.', nextIndex: 1, customAvatarUrl: "", customBackgroundUrl: "", customGalleryUrl: "", galleryMode: "add_url" }, 
                { type: 'text', content: '¬ßM Igen? Mir≈ël?', nextIndex: 2, backIndex: 0, customAvatarUrl: "", customBackgroundUrl: "", customGalleryUrl: "", galleryMode: "add_url" }, 
                { type: 'choice', content: '¬ßN Mit v√°lasztasz?', backIndex: 1, customAvatarUrl: "", customBackgroundUrl: "", customGalleryUrl: "", galleryMode: "add_url", choices: [{ "text": "Jelsz√≥ megad√°sa", "nextIndex": 3 }, { "text": "K√©p a gal√©ri√°ba", "nextIndex": 4 }] },
                { type: 'password', content: '¬ßKOD K√©rj√ºk add meg a k√≥dot (1940).', correctPassword: '1940', nextIndexSuccess: -1, backIndex: 2, helpMessage: ['Keresd a megold√°st a helysz√≠nen.', '1940'], customAvatarUrl: "", customBackgroundUrl: "", customGalleryUrl: "", galleryMode: "add_url" }, 
                { type: 'text', content: "¬ßR K√©p hozz√°adva a gal√©ri√°hoz! L√©pj vissza, √©s pr√≥b√°ld meg a jelsz√≥t!", nextIndex: 2, backIndex: 2, customAvatarUrl: "", customBackgroundUrl: "https://placehold.co/150x150/0000FF/FFFFFF?text=GALERIA_KEP", customGalleryUrl: "https://placehold.co/150x150/0000FF/FFFFFF?text=GALERIA_KEP", galleryMode: "add_url" },
            ],
        };

        function getAvatarMapConfig() {
            return { '¬ßM': fields.avatarMUrl.value, '¬ßA': fields.avatarAUrl.value, '¬ßR': fields.avatarRUrl.value };
        }

        /**
         * Konfigur√°ci√≥ beolvas√°sa a DOM-b√≥l.
         */
        function getCurrentConfigFromDOM() {
            const form = document.getElementById('game-config-form');
            if (!form) return null;

            const getVal = (name, parser = (v) => v) => {
                const el = form.elements[name];
                return el ? parser(el.value) : undefined;
            };

            const config = {
                APP_TITLE: getVal('appTitle'), BACKGROUND_URL: getVal('backgroundUrl'),
                BODY_BG_COLOR: getVal('bgColor'), BODY_TEXT_COLOR: getVal('textColor'),
                GPS_COMPASS: {
                    TARGET_LATITUDE: getVal('targetLat', parseFloat), TARGET_LONGITUDE: getVal('targetLon', parseFloat),
                    SUCCESS_REDIRECT_URL: getVal('successRedirectUrl'), MAP_BUTTON_URL: getVal('gpsMapLink'),
                    SUCCESS_RADIUS_M: 25 
                },
                MEDIA: { AUDIO_1_URL: getVal('audio1Url'), AUDIO_2_URL: getVal('audio2Url') },
                PASSWORD_PAGE: { 
                    PROMPT_TEXT: getVal('passwordPromptText'), ERROR_MESSAGE: DEFAULT_CONFIG.PASSWORD_PAGE.ERROR_MESSAGE, 
                    SUCCESS_MESSAGE: DEFAULT_CONFIG.PASSWORD_PAGE.SUCCESS_MESSAGE 
                },
                AVATARS: {
                    DEFAULT_AVATAR_URL: getVal('avatarDefaultUrl'),
                    AVATAR_MAP: { '¬ßM': getVal('avatarMUrl'), '¬ßA': getVal('avatarAUrl'), '¬ßR': getVal('avatarRUrl') },
                    HIDDEN_PREFIXES: DEFAULT_CONFIG.AVATARS.HIDDEN_PREFIXES
                },
                storyPages: [],
                currentState: { storyIndex: currentPartIndex }
            };

            // KRITIKUS: StoryPages beolvas√°sa a rejtett mez≈ëb≈ël
            try {
                const fullStoryJSONEl = form.elements['fullStoryJSON'];
                let storyJsonString = fullStoryJSONEl.value; 

                // Ha a rejtett mez≈ë √ºres (Admin/Preview m√≥dban lehet), a RAM-ban l√©v≈ët haszn√°ljuk.
                if (storyJsonString.trim() === '') {
                    storyJsonString = JSON.stringify(currentStoryPages);
                }
                
                config.storyPages = JSON.parse(storyJsonString);
                
            } catch(e) {
                console.error("T√∂rt√©net JSON hiba a bet√∂lt√©skor:", e.message);
                // Visszaadjuk a null-t a hibajelz√©shez, hogy a setMode kezelni tudja.
                return null; 
            }
            
            return config;
        }

        function getGameElements() {
             return {
                storyDisplay: document.getElementById('story-text-display'), storyImage: document.getElementById('story-image'),
                avatarImg: document.getElementById('avatar-img'), contentBox: document.getElementById('content-box'),
                nextBtn: document.getElementById('next-page-button'), prevBtn: document.getElementById('prev-page-button'),
                discreetBackBtn: document.getElementById('discreet-back-button'),
                interactionCont: document.getElementById('interaction-container'), passCont: document.getElementById('password-container'),
                multiChoiceCont: document.getElementById('multi-choice-container'),
                passInput: document.getElementById('password-input'), checkBtn: document.getElementById('check-password-button'),
                msgDisplay: document.getElementById('message-game'), distModal: document.getElementById('distanceModal-ui'),
                distDisplay: document.getElementById('distance-modal-display'), distStatus: document.getElementById('distance-status'),
                helpModal: document.getElementById('help-modal-ui'), helpText: document.getElementById('help-text-display'),
                galleryModal: document.getElementById('galleryModal-ui'), galleryContainer: document.getElementById('gallery-container'),
                audio1: document.getElementById('story-audio-1'), audio2: document.getElementById('story-audio-2')
            };
        }
        
        // ... A t√∂bbi J√°t√©k Logika (initializeGame, showStory, stb.) megegyezik a V. 5-tel ...

        function initializeGame(config) {
            const els = getGameElements();
            const { storyPages, AVATARS } = config;

            // F≈ë be√°ll√≠t√°sok
            document.documentElement.style.setProperty('--bg-color-game', config.BODY_BG_COLOR);
            document.documentElement.style.setProperty('--text-color-game', config.BODY_TEXT_COLOR);
            document.title = config.APP_TITLE;
            
            if (els.audio1) els.audio1.src = config.MEDIA.AUDIO_1_URL;
            if (els.audio2) els.audio2.src = config.MEDIA.AUDIO_2_URL;

            // J√°t√©k ind√≠t√°sa
            showStory(els, storyPages, AVATARS, config);
            setupGameHandlers(els, config);
            
            // SIKERES IND√çT√ÅS: Felfedj√ºk az oldalt
            const gameContainer = document.getElementById('game-mode');
            if (gameContainer) {
                gameContainer.classList.remove('initial-hide');
                document.body.classList.remove('admin-body'); // Admin UI CSS t√∂rl√©se a body-r√≥l
            }
        }

        function showStory(els, storyPages, AVATARS, config) {
            const page = storyPages[currentPartIndex];
            
            if (els.contentBox) els.contentBox.classList.add('content-hidden-ui');
            
            setTimeout(() => {
                if (!page || !els.storyDisplay) {
                    if(els.storyDisplay) els.storyDisplay.innerHTML = `[V. ${REVISION_COUNT}] Hiba: Oldal tartalom hi√°nyzik a(z) ${currentPartIndex}. indexen.`;
                    return;
                }
                
                let text = page.content || ''; const prefix = text.split(' ')[0]; let avatarUrl = AVATARS.DEFAULT_AVATAR_URL; let isAvatarVisible = true;
                
                if (page.customAvatarUrl && page.customAvatarUrl.trim() !== '') { avatarUrl = page.customAvatarUrl; } else if (AVATARS.AVATAR_MAP[prefix]) { avatarUrl = AVATARS.AVATAR_MAP[prefix]; text = text.substring(prefix.length).trim(); } else if (AVATARS.HIDDEN_PREFIXES.includes(prefix)) { isAvatarVisible = false; text = text.substring(prefix.length).trim(); } else { isAvatarVisible = false; }
                if (page.type === 'choice') { isAvatarVisible = false; }
                
                if (els.avatarImg) els.avatarImg.src = avatarUrl;
                if (els.avatarImg) els.avatarImg.style.display = isAvatarVisible ? 'block' : 'none';
                if (els.contentBox) els.contentBox.style.paddingTop = isAvatarVisible ? '40px' : '10px';
                if (els.storyDisplay) els.storyDisplay.innerHTML = text;

                let activeBg = config.BACKGROUND_URL;
                for(let i = 0; i <= currentPartIndex; i++) {
                    if (storyPages[i] && storyPages[i].customBackgroundUrl && storyPages[i].customBackgroundUrl.trim() !== '') { activeBg = storyPages[i].customBackgroundUrl; }
                }
                if (els.storyImage) els.storyImage.src = activeBg;

                if (els.interactionCont) els.interactionCont.style.display = 'flex';
                if (els.passCont) els.passCont.style.display = 'none';
                if (els.multiChoiceCont) els.multiChoiceCont.style.display = 'none';
                if (els.multiChoiceCont) els.multiChoiceCont.innerHTML = '';
                
                if (page.type === 'password') { if (els.interactionCont) els.interactionCont.style.display = 'none'; if (els.passCont) els.passCont.style.display = 'flex'; } 
                else if (page.type === 'choice') { 
                    if (els.interactionCont) els.interactionCont.style.display = 'none'; if (els.multiChoiceCont) els.multiChoiceCont.style.display = 'flex';
                    if (page.choices && page.choices.length > 0) {
                        page.choices.forEach(choice => {
                            const btn = document.createElement('button'); btn.className = 'choice-button'; btn.textContent = choice.text;
                            btn.onclick = () => { currentPartIndex = choice.nextIndex !== undefined ? choice.nextIndex : currentPartIndex + 1; showStory(els, storyPages, AVATARS, config); };
                            if (els.multiChoiceCont) els.multiChoiceCont.appendChild(btn);
                        });
                    }
                }
                else if (page.type === 'audio') {
                    const audioCont = document.getElementById('audio-container-' + (page.audioId || 1));
                    if (audioCont) audioCont.style.display = 'block';
                    if (els.nextBtn) els.nextBtn.textContent = page.nextButtonText || 'Tov√°bb';
                } 
                
                const isLastPage = currentPartIndex === storyPages.length - 1;
                if (els.nextBtn) els.nextBtn.textContent = isLastPage ? "C√©lpont Keres√©se" : 'Tov√°bb';
                if (els.prevBtn) els.prevBtn.disabled = currentPartIndex === 0; 
                if (els.discreetBackBtn) els.discreetBackBtn.style.display = (currentPartIndex === 0 || page.type === 'password' || page.type === 'audio') ? 'none' : 'block';

                if (els.contentBox) els.contentBox.classList.remove('content-hidden-ui');

            }, 100);
        }

        function setupGameHandlers(els, config) {
            // Tov√°bb, Vissza, Jelsz√≥, Men√º √©s Audio gombok logik√°ja megegyezik a V. 5-tel.
            const goBack = () => {
                const page = config.storyPages[currentPartIndex];
                currentPartIndex = page.backIndex !== undefined ? page.backIndex : Math.max(0, currentPartIndex - 1);
                showStory(els, config.storyPages, config.AVATARS, config);
            };

            if (els.nextBtn) els.nextBtn.onclick = () => {
                if (currentPartIndex === config.storyPages.length - 1) { startGPS(els, config.GPS_COMPASS); return; }
                const page = config.storyPages[currentPartIndex];
                currentPartIndex = page.nextIndex !== undefined ? page.nextIndex : currentPartIndex + 1;
                showStory(els, config.storyPages, config.AVATARS, config);
            };
            if (els.prevBtn) els.prevBtn.onclick = goBack;
            if (els.discreetBackBtn) els.discreetBackBtn.onclick = goBack;
            const passBackBtn = document.getElementById('back-button-password');
            if (passBackBtn) passBackBtn.onclick = goBack;

            if (els.checkBtn) els.checkBtn.onclick = () => {
                const page = config.storyPages[currentPartIndex];
                const inputVal = els.passInput ? els.passInput.value.trim() : '';
                if (els.msgDisplay) els.msgDisplay.textContent = '';
                if (inputVal === page.correctPassword) {
                    if (els.msgDisplay) { els.msgDisplay.textContent = config.PASSWORD_PAGE.SUCCESS_MESSAGE || "K√≥d elfogadva!"; els.msgDisplay.style.color = '#00ff00'; }
                    setTimeout(() => {
                        if (page.nextIndexSuccess === -1) startGPS(els, config.GPS_COMPASS);
                        else { currentPartIndex = page.nextIndexSuccess !== undefined ? page.nextIndexSuccess : currentPartIndex + 1; showStory(els, config.storyPages, config.AVATARS, config); }
                    }, 1000);
                } else {
                    if (els.msgDisplay) { els.msgDisplay.textContent = config.PASSWORD_PAGE.ERROR_MESSAGE || "Hib√°s k√≥d!"; els.msgDisplay.style.color = 'red'; }
                }
            };
            
            const mapBtn = document.getElementById('map-button'); if (mapBtn) mapBtn.onclick = () => { window.open(config.MENU_LINKS.MAP_LINK_URL, '_blank'); };
            const imageBtn = document.getElementById('image-button'); if (imageBtn) imageBtn.onclick = () => openGallery(els);
            const audioBtn1 = document.getElementById('play-audio-button-1'); if (audioBtn1) audioBtn1.onclick = () => toggleAudio('1');
            const audioBtn2 = document.getElementById('play-audio-button-2'); if (audioBtn2) audioBtn2.onclick = () => toggleAudio('2');
            const helpBtn = document.getElementById('help-button');
            if (helpBtn) { helpBtn.onclick = () => { const page = config.storyPages[currentPartIndex]; if(page.helpMessage && els.helpModal && els.helpText) { currentHelpIndex = 0; const msgs = Array.isArray(page.helpMessage) ? page.helpMessage : [page.helpMessage]; els.helpText.textContent = msgs[0]; els.helpModal.style.display = 'flex'; const helpNextBtn = document.getElementById('help-next-button'); if (helpNextBtn) helpNextBtn.style.display = msgs.length > 1 ? 'inline-block' : 'none'; } }; }
            const helpCloseBtn = document.getElementById('help-close-button'); if (helpCloseBtn) helpCloseBtn.onclick = () => { if (els.helpModal) els.helpModal.style.display = 'none'; };
            const helpNextBtn = document.getElementById('help-next-button');
            if (helpNextBtn) { helpNextBtn.onclick = () => { const page = config.storyPages[currentPartIndex]; const msgs = Array.isArray(page.helpMessage) ? page.helpMessage : [page.helpMessage]; currentHelpIndex++; if(currentHelpIndex < msgs.length) { if (els.helpText) els.helpText.textContent = msgs[currentHelpIndex]; const nextBtn = document.getElementById('help-next-button'); if(currentHelpIndex === msgs.length - 1) { if (nextBtn) nextBtn.style.display = 'none'; } } }; }
            const closeGalleryBtn = document.querySelector('#galleryModal-ui .close-gallery'); if (closeGalleryBtn) closeGalleryBtn.onclick = () => closeGallery();
        }

        function startGPS(els, GPS_COMPASS) {
            if (els.contentBox) els.contentBox.classList.add('content-hidden-ui'); 
            if (els.distModal) els.distModal.style.display = 'flex';
            if (els.distStatus) els.distStatus.textContent = "Helyzetmeghat√°roz√°s ind√≠t√°sa...";
            if (els.distMapBtn) els.distMapBtn.href = GPS_COMPASS.MAP_BUTTON_URL;
        }
        function openGallery(els) {
            if (els.galleryModal) els.galleryModal.style.display = 'block';
        }
        function closeGallery() {
            const galleryModal = document.getElementById('galleryModal-ui');
            if (galleryModal) galleryModal.style.display = 'none';
        }


        // --- ADMIN / M√ìD V√ÅLT√ì LOGIKA (CRITICAL FIX) ---

        function setMode(mode) {
            const adminModeEl = document.getElementById('admin-mode');
            const gameModeEl = document.getElementById('game-mode');
            const bodyEl = document.body;
            
            if (mode === 'admin') {
                // Admin m√≥dban a body megkapja az Admin st√≠lusokat
                if (bodyEl) bodyEl.classList.add('admin-body');
                adminModeEl.classList.remove('hidden');
                gameModeEl.classList.add('initial-hide'); // Rejt√©s
            } else if (mode === 'game') {
                saveSettings(false); // CRITICAL: Mentj√ºk az adatokat a rejtett mez≈ëbe a J√°t√©k ind√≠t√°sa el≈ëtt
                
                const config = getCurrentConfigFromDOM();
                if (!config) {
                    alert("Hiba: Az adatok olvas√°sa meghi√∫sult! K√©rem ellen≈ërizze a JSON mez≈ëket.");
                    return; 
                }
                
                // J√°t√©k m√≥dban elt√°vol√≠tjuk az Admin st√≠lust a body-r√≥l
                if (bodyEl) bodyEl.classList.remove('admin-body');
                adminModeEl.classList.add('hidden');
                gameModeEl.classList.remove('initial-hide'); // CRITICAL: Megjelen√≠t√©s

                // El≈ën√©zet eset√©n a J√°t√©k M√≥d kont√©ner megjelenik √©s elindul az inicializ√°l√°s
                setTimeout(() => {
                    initializeGame(config);
                    // Az Admin gombot megjelen√≠tj√ºk, hogy vissza lehessen menni a Preview-ban.
                    const adminButtonInGameMode = gameModeEl.querySelector('.admin-only-btn');
                    if(adminButtonInGameMode) adminButtonInGameMode.style.display = 'block'; 
                }, 200); 
            }
        }
        
        // --- ADMIN OLDALI MENT√âS LOGIKA (Friss√≠tve) ---

        function saveSettings(showSuccess = true) {
            saveCurrentStoryPageContent(); 
            // ... (t√∂bbi config ment√©se LocalStorage-ba) ...
            const newConfig = {
                APP_TITLE: fields.appTitle.value, BACKGROUND_URL: fields.backgroundUrl.value, BODY_BG_COLOR: fields.bgColor.value, BODY_TEXT_COLOR: fields.textColor.value,
                AVATARS: { DEFAULT_AVATAR_URL: fields.avatarDefaultUrl.value, AVATAR_MAP: getAvatarMapConfig(), HIDDEN_PREFIXES: DEFAULT_CONFIG.AVATARS.HIDDEN_PREFIXES },
                MENU_LINKS: { MAP_LINK_URL: fields.menuMapLink.value },
                GPS_COMPASS: { TARGET_LATITUDE: parseFloat(fields.targetLat.value) || DEFAULT_CONFIG.GPS_COMPASS.TARGET_LATITUDE, TARGET_LONGITUDE: parseFloat(fields.targetLon.value) || DEFAULT_CONFIG.GPS_COMPASS.TARGET_LONGITUDE, SUCCESS_REDIRECT_URL: fields.successRedirectUrl.value, MAP_BUTTON_URL: fields.gpsMapLink.value, SUCCESS_RADIUS_M: 25 },
                PASSWORD_PAGE: { PROMPT_TEXT: fields.passwordPromptText.value, ERROR_MESSAGE: DEFAULT_CONFIG.PASSWORD_PAGE.ERROR_MESSAGE, SUCCESS_MESSAGE: DEFAULT_CONFIG.PASSWORD_PAGE.SUCCESS_MESSAGE },
                MEDIA: { AUDIO_1_URL: fields.audio1Url.value, AUDIO_2_URL: fields.audio2Url.value },
                storyPages: currentStoryPages,
                currentState: { storyIndex: currentPartIndex }
            };

            // KRITIKUS: Friss√≠tj√ºk a rejtett mez≈ët a legfrissebb JSON-nel a ment√©skor
            if (fields.fullStoryJSON) {
                fields.fullStoryJSON.value = JSON.stringify(currentStoryPages);
            }
            try { localStorage.setItem(STORAGE_KEY, JSON.stringify(newConfig)); } catch (e) { MESSAGE_DISPLAY.textContent = `Ment√©si HIBA!`; MESSAGE_DISPLAY.style.color = '#FF5555'; return; }
            if (showSuccess) { MESSAGE_DISPLAY.textContent = 'Be√°ll√≠t√°sok sikeresen elmentve!'; MESSAGE_DISPLAY.style.color = '#00FF00'; setTimeout(() => MESSAGE_DISPLAY.textContent = '', 4000); }
        }

        // --- EXPORT√ÅL√ÅS LOGIKA (Static Value Setting) ---
        function exportPage() {
            saveSettings(false); // Mentj√ºk az aktu√°lis √°llapotot (√©s a rejtett mez≈ët)
            
            const originalHTML = document.documentElement.outerHTML;
            const parser = new DOMParser();
            const tempDoc = parser.parseFromString(originalHTML, 'text/html');
            const adminModeEl = tempDoc.getElementById('admin-mode');
            const gameModeEl = tempDoc.getElementById('game-mode');
            const form = tempDoc.getElementById('game-config-form');

            if (!adminModeEl || !gameModeEl || !form) { alert("Kritikus hiba: Hi√°nyz√≥ DOM elemek az export√°l√°shoz."); return; }

            // 1. Statikus √©rt√©kek be√°ll√≠t√°sa
            const elements = form.querySelectorAll('input, textarea, select');
            elements.forEach(el => {
                if (el.value) { el.setAttribute('value', el.value); } 
                if (el.tagName === 'TEXTAREA') { el.textContent = el.value; }
            });

            // 2. M√≥dos√≠t√°sok a let√∂lt√∂tt f√°jl automatikus ind√≠t√°s√°hoz
            adminModeEl.classList.add('hidden');
            gameModeEl.classList.remove('initial-hide'); // CRITICAL: Megjelen√≠t√©s a let√∂lt√∂tt f√°jlban
            
            // 3. Admin vez√©rl≈ëk elt√°vol√≠t√°sa a let√∂lt√∂tt f√°jlb√≥l
            const adminButtonInGameMode = gameModeEl.querySelector('.admin-only-btn');
            if(adminButtonInGameMode) adminButtonInGameMode.remove();

            // 4. J√°t√©k ind√≠t√°s√°t be√°ll√≠t√≥ szkript injekt√°l√°sa (a v√©gleges be√°ll√≠t√°sok bet√∂lt√©s√©re)
            const finalScript = tempDoc.createElement('script');
            finalScript.textContent = `
                document.addEventListener('DOMContentLoaded', () => {
                    const admin = document.getElementById('admin-mode');
                    if (admin) admin.remove();
                    
                    const config = getCurrentConfigFromDOM();
                    if (config) {
                        localStorage.removeItem('${STORAGE_KEY}'); // T√∂r√∂lj√ºk a LocalStorage-t a let√∂lt√∂tt f√°jlban
                        document.title = config.APP_TITLE;
                        
                        // CRITICAL: A body-r√≥l levessz√ºk az admin st√≠lusokat, hogy a j√°t√©k CSS √©rv√©nyes√ºlj√∂n
                        document.body.classList.remove('admin-body');
                        
                        setTimeout(() => initializeGame(config), 200); 
                    } else {
                        document.body.innerHTML = '<div style="color:red;padding:20px;text-align:center;">Hiba: A konfigur√°ci√≥ nem t√∂lthet≈ë be a statikus f√°jlb√≥l.</div>';
                    }
                });
            `;
            tempDoc.body.appendChild(finalScript);

            // 5. V√©gleges tartalom √©s let√∂lt√©s
            const finalHTML = tempDoc.documentElement.outerHTML;
            const blob = new Blob([finalHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = 'jatek_futtato.html'; 
            
            try {
                setTimeout(() => {
                    link.click();
                    URL.revokeObjectURL(url);
                }, 50); 
                document.body.appendChild(link);
                document.body.removeChild(link);
            } catch (e) {
                 alert("A let√∂lt√©s automatikus ind√≠t√°sa meghi√∫sult. K√©rem pr√≥b√°lja meg √∫jra.");
                 URL.revokeObjectURL(url);
            }
        }
        
        // --- Admin K√©zi Vez√©rl√©s √©s Bek√∂t√©sek (a t√∂bbi Admin logika megmarad) ---
        
        function saveCurrentStoryPageContent() {
            const index = currentLoadedIndex;
            if (isNaN(index) || !currentStoryPages[index]) return;
            const page = currentStoryPages[index]; const pageType = fields.pageType.value;
            page.type = pageType; page.content = fields.pageContent.value; page.customAvatarUrl = fields.customAvatarUrl.value; page.customBackgroundUrl = fields.customBackgroundUrl.value; page.customGalleryUrl = fields.customGalleryUrl.value; page.galleryMode = fields.galleryMode.value;
            page.nextIndex = fields.nextIndex.value !== '' ? parseInt(fields.nextIndex.value) : undefined; page.backIndex = fields.backIndex.value !== '' ? parseInt(fields.backIndex.value) : undefined;
            if (pageType === 'audio') { page.audioId = parseInt(fields.audioId.value); page.nextButtonText = fields.audioNextButtonText.value || undefined; } else { delete page.audioId; delete page.nextButtonText; }
            if (pageType === 'password') { page.correctPassword = fields.correctPassword.value; page.nextIndexSuccess = fields.nextIndexSuccess.value !== '' ? parseInt(fields.nextIndexSuccess.value) : undefined; if (page.correctPassword && !page.helpMessage) { page.helpMessage = ['Keresd a megold√°st a helysz√≠nen.', page.correctPassword]; } } else { delete page.correctPassword; delete page.nextIndexSuccess; delete page.helpMessage; }
            if (pageType === 'choice') { const rows = fields.choicesContainer.querySelectorAll('.choice-row'); page.choices = Array.from(rows).map(row => ({ text: row.querySelector('.choice-text').value, nextIndex: parseInt(row.querySelector('.choice-index').value) || undefined })).filter(c => c.text.trim() !== ''); } else { delete page.choices; }
            populatePageIndexSelector(currentStoryPages.length, index);
        }

        function loadStoryPage(index) {
            saveCurrentStoryPageContent();
            currentLoadedIndex = parseInt(index);
            const page = currentStoryPages[currentLoadedIndex];
            if (!page) { toggleContentBlocks('text'); fields.pageContent.value = 'Hiba: Ez az index nem l√©tezik.'; return; }
            fields.pageType.value = page.type; toggleContentBlocks(page.type);
            fields.pageContent.value = page.content || ''; fields.customAvatarUrl.value = page.customAvatarUrl || ''; fields.customBackgroundUrl.value = page.customBackgroundUrl || ''; fields.customGalleryUrl.value = page.customGalleryUrl || ''; fields.galleryMode.value = page.galleryMode || 'add_url';
            fields.nextIndex.value = page.nextIndex !== undefined ? page.nextIndex : ''; fields.backIndex.value = page.backIndex !== undefined ? page.backIndex : '';
            if (page.type === 'audio') { fields.audioId.value = page.audioId || 1; fields.audioNextButtonText.value = page.nextButtonText || ''; } 
            if (page.type === 'password') { fields.correctPassword.value = page.correctPassword || ''; fields.nextIndexSuccess.value = page.nextIndexSuccess !== undefined ? page.nextIndexSuccess : ''; }
            if (page.type === 'choice') { fields.choicesContainer.innerHTML = ''; if (page.choices && Array.isArray(page.choices)) { page.choices.forEach(c => renderChoiceRow(c.text, c.nextIndex)); } else { renderChoiceRow(); } }
            updatePreview(); 
        }

        function populatePageIndexSelector(count, selectIndex = 0) {
            fields.storyPageIndex.innerHTML = ''; fields.pageCount.textContent = count;
            for (let i = 0; i < count; i++) {
                const page = currentStoryPages[i]; const option = document.createElement('option');
                option.value = i; option.textContent = `Oldal ${i} (${page.type})`; fields.storyPageIndex.appendChild(option);
            }
            fields.storyPageIndex.value = selectIndex;
        }

        function toggleContentBlocks(pageType) {
            fields.textBlock.classList.add('hidden'); fields.audioBlock.classList.add('hidden'); fields.passwordBlock.classList.add('hidden'); fields.choiceBlock.classList.add('hidden');
            if (pageType === 'text') { fields.textBlock.classList.remove('hidden'); } else if (pageType === 'audio') { fields.textBlock.classList.remove('hidden'); fields.audioBlock.classList.remove('hidden'); } else if (pageType === 'password') { fields.textBlock.classList.remove('hidden'); fields.passwordBlock.classList.remove('hidden'); } else if (pageType === 'choice') { fields.textBlock.classList.remove('hidden'); fields.choiceBlock.classList.remove('hidden'); }
        }
        
        function updatePreview() {
            const config = { BACKGROUND_URL: fields.backgroundUrl.value, AVATARS: { DEFAULT_AVATAR_URL: fields.avatarDefaultUrl.value, AVATAR_MAP: getAvatarMapConfig(), HIDDEN_PREFIXES: DEFAULT_CONFIG.AVATARS.HIDDEN_PREFIXES } };
            const page = currentStoryPages[currentLoadedIndex];
            if (!page) return;
            
            let text = page.content || ''; const prefix = text.split(' ')[0]; let avatarUrl = config.AVATARS.DEFAULT_AVATAR_URL; let isAvatarVisible = true;
            if (page.customAvatarUrl && page.customAvatarUrl.trim() !== '') { avatarUrl = page.customAvatarUrl; } else if (config.AVATARS.AVATAR_MAP[prefix]) { avatarUrl = config.AVATARS.AVATAR_MAP[prefix]; text = text.substring(prefix.length).trim(); } else if (config.AVATARS.HIDDEN_PREFIXES.includes(prefix)) { isAvatarVisible = false; text = text.substring(prefix.length).trim(); } else { isAvatarVisible = false; }
            if (page.type === 'choice') { isAvatarVisible = false; }

            let buttonsHtml = '';
            if(page.type === 'choice') {
                const rows = fields.choicesContainer.querySelectorAll('.choice-row');
                const btns = Array.from(rows).map(row => { const txt = row.querySelector('.choice-text').value || 'Gomb'; return `<button class="preview-btn">${txt}</button>`; });
                buttonsHtml = `<div class="flex justify-center flex-wrap gap-2">${btns.join('')}</div>`;
            } else { buttonsHtml = `<div class="flex justify-between w-full"><button class="preview-btn opacity-50">Vissza</button><button class="preview-btn">${page.type === 'password' ? 'ELLEN≈êRZ√âS' : 'Tov√°bb'}</button></div>`; }

            let bgStyle = '';
            const activeBgUrl = page.customBackgroundUrl || config.BACKGROUND_URL;
            if (activeBgUrl) { bgStyle = `background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('${activeBgUrl}');`; }
            
            fields.previewContainer.innerHTML = `<div class="game-preview-box" style="${bgStyle}"><div class="absolute top-0 right-0 bg-purple-600 text-xs px-2 py-1 rounded-bl">EL≈êN√âZET (Index: ${currentLoadedIndex})</div><div class="flex items-start" style="padding-top: ${isAvatarVisible ? '30px' : '0'};"><img src="${avatarUrl}" class="preview-avatar" style="display: ${isAvatarVisible ? 'block' : 'none'};" onerror="this.src='https://placehold.co/60?text=?'"><div class="flex-1"><p class="text-lg leading-relaxed whitespace-pre-wrap">${text}</p></div></div><div class="mt-4 pt-4 border-t border-gray-700/50">${buttonsHtml}</div></div>`;
        }

        function renderChoiceRow(text = '', index = '') {
            const row = document.createElement('div'); row.className = 'choice-row flex gap-2 items-center bg-green-900/40 p-2 rounded';
            row.innerHTML = `<input type="text" class="choice-text input-style w-2/3 p-2 rounded" placeholder="Gomb felirat (pl. Balra)" value="${text}"><input type="number" class="choice-index input-style w-1/4 p-2 rounded" placeholder="Idx" value="${index}"><button type="button" class="btn-delete-choice btn-danger p-2 rounded w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-trash"></i></button>`;
            row.querySelector('.btn-delete-choice').addEventListener('click', () => { row.remove(); updateAddChoiceBtnState(); updatePreview(); });
            row.querySelector('.choice-text').addEventListener('input', updatePreview); row.querySelector('.choice-index').addEventListener('input', updatePreview);
            fields.choicesContainer.appendChild(row); updateAddChoiceBtnState(); updatePreview(); return row;
        }

        function updateAddChoiceBtnState() {
            const count = fields.choicesContainer.querySelectorAll('.choice-row').length;
            if (count >= 4) { fields.addChoiceBtn.classList.add('opacity-50', 'cursor-not-allowed'); fields.addChoiceBtn.disabled = true; fields.addChoiceBtn.innerHTML = '<i class="fa-solid fa-ban mr-2"></i> Maximum 4 gomb el√©rve'; } else { fields.addChoiceBtn.classList.remove('opacity-50', 'cursor-not-allowed'); fields.addChoiceBtn.disabled = false; fields.addChoiceBtn.innerHTML = '<i class="fa-solid fa-plus mr-2"></i> √öj v√°laszt√°si gomb hozz√°ad√°sa'; }
        }
        
        function addNewPage() {
            saveCurrentStoryPageContent();
            const newIndex = currentStoryPages.length;
            const newPage = JSON.parse(JSON.stringify(DEFAULT_CONFIG.storyPages[0])); 
            newPage.content = `¬ßN √öj oldal hozz√°adva (${newIndex}).`; newPage.nextIndex = newIndex + 1;
            currentStoryPages.push(newPage);
            populatePageIndexSelector(currentStoryPages.length, newIndex);
            loadStoryPage(newIndex);
            saveSettings(false); 
            MESSAGE_DISPLAY.textContent = `√öj oldal hozz√°adva: ${newIndex}`; MESSAGE_DISPLAY.style.color = '#00FFFF'; setTimeout(() => MESSAGE_DISPLAY.textContent = '', 3000);
        }

        function deleteCurrentPage() {
            const index = parseInt(fields.storyPageIndex.value);
            if (isNaN(index)) return;
            if (!confirm(`Biztosan t√∂r√∂lni szeretn√©d a(z) ${index}. oldalt? A hivatkoz√°sok (Next Index) elcs√∫szhatnak!`)) { return; }
            currentStoryPages.splice(index, 1);
            if (currentStoryPages.length === 0) { currentStoryPages.push(JSON.parse(JSON.stringify(DEFAULT_CONFIG.storyPages[0]))); }
            const newIndex = Math.max(0, index - 1);
            populatePageIndexSelector(currentStoryPages.length, newIndex);
            loadStoryPage(newIndex);
            saveSettings(true);
        }

        function loadSettings() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            let currentConfig = savedData ? JSON.parse(savedData) : DEFAULT_CONFIG;
            currentStoryPages = JSON.parse(JSON.stringify(currentConfig.storyPages || DEFAULT_CONFIG.storyPages));
            if(fields.appTitle) fields.appTitle.value = currentConfig.APP_TITLE || DEFAULT_CONFIG.APP_TITLE; if(fields.backgroundUrl) fields.backgroundUrl.value = currentConfig.BACKGROUND_URL || DEFAULT_CONFIG.BACKGROUND_URL; if(fields.bgColor) fields.bgColor.value = currentConfig.BODY_BG_COLOR || DEFAULT_CONFIG.BODY_BG_COLOR; if(fields.textColor) fields.textColor.value = currentConfig.BODY_TEXT_COLOR || DEFAULT_CONFIG.BODY_TEXT_COLOR;
            if(fields.avatarMUrl) fields.avatarMUrl.value = currentConfig.AVATARS.AVATAR_MAP['¬ßM'] || DEFAULT_CONFIG.AVATARS.AVATAR_MAP['¬ßM']; if(fields.avatarAUrl) fields.avatarAUrl.value = currentConfig.AVATARS.AVATAR_MAP['¬ßA'] || DEFAULT_CONFIG.AVATARS.AVATAR_MAP['¬ßA']; if(fields.avatarRUrl) fields.avatarRUrl.value = currentConfig.AVATARS.AVATAR_MAP['¬ßR'] || DEFAULT_CONFIG.AVATARS.AVATAR_MAP['¬ßR']; if(fields.avatarDefaultUrl) fields.avatarDefaultUrl.value = currentConfig.AVATARS.DEFAULT_AVATAR_URL || DEFAULT_CONFIG.AVATARS.DEFAULT_AVATAR_URL;
            if(fields.menuMapLink) fields.menuMapLink.value = currentConfig.MENU_LINKS.MAP_LINK_URL || DEFAULT_CONFIG.MENU_LINKS.MAP_LINK_URL; if(fields.targetLat) fields.targetLat.value = currentConfig.GPS_COMPASS.TARGET_LATITUDE || DEFAULT_CONFIG.GPS_COMPASS.TARGET_LATITUDE; if(fields.targetLon) fields.targetLon.value = currentConfig.GPS_COMPASS.TARGET_LONGITUDE || DEFAULT_CONFIG.GPS_COMPASS.TARGET_LONGITUDE; if(fields.successRedirectUrl) fields.successRedirectUrl.value = currentConfig.GPS_COMPASS.SUCCESS_REDIRECT_URL || DEFAULT_CONFIG.GPS_COMPASS.SUCCESS_REDIRECT_URL; if(fields.gpsMapLink) fields.gpsMapLink.value = currentConfig.GPS_COMPASS.MAP_BUTTON_URL || DEFAULT_CONFIG.GPS_COMPASS.MAP_BUTTON_URL;
            if(fields.audio1Url) fields.audio1Url.value = currentConfig.MEDIA.AUDIO_1_URL || DEFAULT_CONFIG.MEDIA.AUDIO_1_URL; if(fields.audio2Url) fields.audio2Url.value = currentConfig.MEDIA.AUDIO_2_URL || DEFAULT_CONFIG.MEDIA.AUDIO_2_URL;
            if(fields.passwordPromptText) fields.passwordPromptText.value = currentConfig.PASSWORD_PAGE.PROMPT_TEXT || DEFAULT_CONFIG.PASSWORD_PAGE.PROMPT_TEXT;
            populatePageIndexSelector(currentStoryPages.length, 0); loadStoryPage(0);
        }

        // --- IND√çT√ÅS √âS M√ìD √âSZLEL√âS ---

        function initialSetup() {
            const adminFieldListeners = [
                fields.storyPageIndex, fields.pageType, fields.pageContent, fields.customAvatarUrl, fields.customBackgroundUrl, 
                fields.customGalleryUrl, fields.galleryMode, fields.nextIndex, fields.backIndex, fields.audioId, 
                fields.audioNextButtonText, fields.correctPassword, fields.nextIndexSuccess, 
                fields.appTitle, fields.backgroundUrl, fields.bgColor, fields.textColor, fields.avatarMUrl, 
                fields.avatarAUrl, fields.avatarRUrl, fields.avatarDefaultUrl, fields.menuMapLink, fields.targetLat, 
                fields.targetLon, fields.successRedirectUrl, fields.gpsMapLink, fields.audio1Url, fields.audio2Url,
                fields.passwordPromptText
            ];
            
            adminFieldListeners.forEach(field => { if (field) field.addEventListener('input', () => { saveCurrentStoryPageContent(); updatePreview(); }); });

            if (fields.addChoiceBtn) fields.addChoiceBtn.addEventListener('click', () => renderChoiceRow());
            if (document.getElementById('addPageButton')) document.getElementById('addPageButton').addEventListener('click', () => addNewPage());
            if (document.getElementById('saveButton')) document.getElementById('saveButton').addEventListener('click', () => saveSettings(true));
            if (document.getElementById('goToGameButton')) document.getElementById('goToGameButton').addEventListener('click', () => setMode('game'));
            if (document.getElementById('downloadPageButton')) document.getElementById('downloadPageButton').addEventListener('click', exportPage);
            if (fields.deletePageButton) fields.deletePageButton.addEventListener('click', () => deleteCurrentPage());

            loadSettings();

            const adminModeEl = document.getElementById('admin-mode');
            const gameModeEl = document.getElementById('game-mode');
            
            // Az Admin gomb elt√°vol√≠t√°sa a J√°t√©k m√≥db√≥l a let√∂lt√∂tt f√°jlban (ha m√°r az export√°lt f√°jlban fut)
            const adminButtonInGameMode = gameModeEl.querySelector('.admin-only-btn');
            if (adminModeEl.classList.contains('hidden')) {
                // Ez az export√°lt f√°jl!
                adminModeEl.remove();
                if(adminButtonInGameMode) adminButtonInGameMode.remove(); // Elt√°vol√≠tjuk a gombot
                
                const config = getCurrentConfigFromDOM();
                if (config) {
                    // CRITICAL: A body-r√≥l levessz√ºk az admin st√≠lusokat
                    document.body.classList.remove('admin-body');
                    gameModeEl.classList.remove('initial-hide');
                    setTimeout(() => initializeGame(config), 200); 
                } else {
                    document.body.innerHTML = '<div style="color:red;padding:20px;text-align:center;">Hiba: A konfigur√°ci√≥ nem t√∂lthet≈ë be a statikus f√°jlb√≥l.</div>';
                }
            } else {
                setMode('admin'); // Preview m√≥dban Adminnal indul
                if(adminButtonInGameMode) adminButtonInGameMode.style.display = 'block'; // Admin gomb l√°that√≥ a preview-ban
            }
        }
        
        document.addEventListener('DOMContentLoaded', initialSetup);
    </script>
</body>
</html>

