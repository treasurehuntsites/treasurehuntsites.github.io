
<!doctype html>
<html lang="hu">
<head>
@@ -274,13 +273,14 @@
border-radius: 5px; font-size: 1.2em; font-weight: bold;
text-decoration: none; transition: all 0.2s;
}
        #distance-modal-map-button:hover { background-color: #00ffff; color: #1a1a1a; }
        .distance-modal-map-button:hover { background-color: #00ffff; color: #1a1a1a; }

</style>
</head>
<body oncontextmenu="return false;"> 
<div class="full-width-image-container">
        <img id="story-image" src="" alt="Háttér" onerror="this.onerror=null; this.style.opacity='0';">
        <!-- Diagnosztika: Hiba esetén ide írja a hibaüzenetet -->
        <img id="story-image" src="" alt="Háttér" onerror="console.error('[DBG] Kép betöltési hiba a címen:', this.src); this.onerror=null; this.style.opacity='0';">
</div>

<div class="content-box content-hidden" id="content-box"> <!-- Hozzáadva a content-hidden osztályt a kezdeti elrejtéshez -->
@@ -289,7 +289,7 @@
<i class="fa-solid fa-arrow-left"></i>
</button>

        <img id="avatar-img" class="avatar-image" src="" alt="Avatar">
        <img id="avatar-img" class="avatar-image" src="" alt="Avatar" onerror="this.onerror=null; this.style.opacity='0';">

<p id="story-text-display"></p>

@@ -372,8 +372,597 @@ <h1 id="gps-title" class="modal-title">CÉLPONT KERESÉSE</h1>
<script>
// Placeholder a konfigurációhoz.
window.GAME_CONFIG_INJECTED = {};
        //
        // --- JÁTÉK KONFIGURÁCIÓ INJEKTÁLVA: 2025-12-02T21:01:42.050Z ---
        window.GAME_CONFIG_INJECTED = {"APP_TITLE":"Anna és Márk Kincskeresés (Alapértelmezett)","BACKGROUND_URL":"https://content.actionbound.com/user/5d77f26bdf17445d808bcb28/image/1741000044.png","BODY_BG_COLOR":"#1a1a1a","BODY_TEXT_COLOR":"#e0e0e0","MENU_LINKS":{"MAP_LINK_URL":"https://www.google.com/maps/d/u/0/viewer?mid=16ShsAj1LaFgeQYGVD8R2Y_ebs50usI8&ll=47.4748758%2C19.039845799999984&z=17"},"GPS_COMPASS":{"TARGET_LATITUDE":47.47407,"TARGET_LONGITUDE":19.04001,"SUCCESS_REDIRECT_URL":"busz.html","MAP_BUTTON_URL":"https://www.google.com/maps/d/u/0/viewer?mid=1cmPNBkR0t3ozvDgY7056CZiFxf-8d-4&ll=47.47407829999998%2C19.040016799999986&z=17"},"PASSWORD_PAGE":{"PROMPT_TEXT":"Add meg a kódot:","CHECK_BUTTON_TEXT":"ELLENŐRZÉS","BACK_BUTTON_TEXT":"Vissza","ERROR_MESSAGE":"Helytelen jelszó! Próbáld újra.","SUCCESS_MESSAGE":"Kód elfogadva!"},"AVATARS":{"DEFAULT_AVATAR_URL":"https://placehold.co/70x70/1A1A1A/FFFFFF?text=?","AVATAR_MAP":{"§M":"https://treasurehuntsites.github.io/annaesmark/Img/mark.png","§A":"https://treasurehuntsites.github.io/annaesmark/Img/anna.png","§R":"https://placehold.co/70x70/1A1A1A/00FF00?text=R"},"HIDDEN_PREFIXES":["§N","§KOD","§H","§RESET"]},"MEDIA":{"AUDIO_1_URL":"https://treasurehuntsites.github.io/media/Ugynokok1.mp3","AUDIO_2_URL":"https://treasurehuntsites.github.io/media/Ugynokok2.mp3"},"storyPages":[{"type":"text","content":"aaff","customAvatarUrl":"","customBackgroundUrl":"https://content.actionbound.com/user/5d77f26bdf17445d808bcb28/image/1741000044.png","customGalleryUrl":"","galleryMode":"add_url"},{"type":"text","content":"§M Igen? Miről?","nextIndex":2,"customAvatarUrl":"","customBackgroundUrl":"","customGalleryUrl":"","galleryMode":"add_url"},{"type":"text","content":"§N B","nextIndex":3,"backIndex":1,"customAvatarUrl":"","customBackgroundUrl":"","customGalleryUrl":"","galleryMode":"add_url"},{"type":"text","content":"§KOD Kérjük add meg a kódot.","backIndex":2,"customAvatarUrl":"","customBackgroundUrl":"","customGalleryUrl":"","galleryMode":"add_url"},{"type":"text","content":"§N Új oldal hozzáadva (4).","nextIndex":5,"customAvatarUrl":"","customBackgroundUrl":"","customGalleryUrl":"","galleryMode":"add_url"},{"type":"text","content":"§N Új oldal hozzáadva (5).","nextIndex":6,"customAvatarUrl":"","customBackgroundUrl":"","customGalleryUrl":"","galleryMode":"add_url"},{"type":"text","content":"§N Új oldal hozzáadva (6).","nextIndex":7,"customAvatarUrl":"","customBackgroundUrl":"","customGalleryUrl":"","galleryMode":"add_url"},{"type":"text","content":"§N Új oldal hozzáadva (7).","nextIndex":8,"customAvatarUrl":"","customBackgroundUrl":"","customGalleryUrl":"","galleryMode":"add_url"},{"type":"text","content":"§N Új oldal hozzáadva (8).","nextIndex":9,"customAvatarUrl":"","customBackgroundUrl":"","customGalleryUrl":"","galleryMode":"add_url"},{"type":"password","content":"§N Új oldal hozzáadva (9).","nextIndex":10,"customAvatarUrl":"","customBackgroundUrl":"","customGalleryUrl":"","galleryMode":"add_url","correctPassword":"0000","nextIndexSuccess":-1,"helpMessage":["Keresd a megoldást a helyszínen.","1940"]}]};
    
    
        //$$CONFIG_PLACEHOLDER$$
    </script>

    <script>
        // Ez a placeholder volt: const INJECTED_CONFIG_JSON = '!!!INJECTED_CONFIG_JSON_HERE!!!';
        
        function getDefaultConfig() {
            return {
                APP_TITLE: "Anna és Márk",
                BACKGROUND_URL: "https://treasurehuntsites.github.io/annaesmark/Img/kr.jpg", 
                BODY_BG_COLOR: "#1a1a1a", BODY_TEXT_COLOR: "#e0e0e0", 
                AVATARS: {
                    DEFAULT_AVATAR_URL: "https://placehold.co/70x70/1A1A1A/FFFFFF?text=?",
                    AVATAR_MAP: { '§M': "https://treasurehuntsites.github.io/annaesmark/Img/mark.png", '§A': "https://treasurehuntsites.github.io/annaesmark/Img/anna.png", '§R': "https://placehold.co/70x70/1A1A1A/00FF00?text=R" },
                    HIDDEN_PREFIXES: ['§N', '§KOD', '§H', '§RESET'] 
                },
                MENU_LINKS: { MAP_LINK_URL: 'https://maps.google.com' },
                PASSWORD_PAGE: { PROMPT_TEXT: "Kód:", CHECK_BUTTON_TEXT: "Ellenőrzés", BACK_BUTTON_TEXT: "Vissza" },
                GPS_COMPASS: { TARGET_LATITUDE: 47.47407, TARGET_LONGITUDE: 19.04001, SUCCESS_RADIUS_M: 25, SUCCESS_REDIRECT_URL: "busz.html", MAP_BUTTON_URL: 'https://maps.google.com' },
                MEDIA: { AUDIO_1_URL: "", AUDIO_2_URL: "" },
                storyPages: [
                    { type: 'text', content: '§A Szia! Üdvözöllek a játékban.', nextIndex: 1 }, 
                ]
            };
        }

        (function() {
            // A BÖNGÉSZŐ BIZTONSÁGI KORLÁTOZÁSÁNAK ELLENŐRZÉSE
            if (window.location.protocol === 'file:') {
                const errorOverlay = document.createElement('div');
                errorOverlay.style.cssText = "position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(138, 43, 226, 0.95); color: white; z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; font-family: sans-serif; text-align: center;";
                errorOverlay.innerHTML = `
                    <h1 style="font-size: 2em; margin-bottom: 20px;">⚠️ LÉNYEGES FIGYELMEZTETÉS ⚠️</h1>
                    <p style="font-size: 1.2em; max-width: 600px; line-height: 1.5;">Ez a fájl (game.html) helyi megnyitáskor (file://) <b>NEM TUDJA BETÖLTENI</b> a külső képeket és hangokat a böngésző biztonsági korlátozásai miatt.</p>
                    <p style="font-size: 1.5em; margin-top: 30px; font-weight: bold; color: #00ffff;">MEGOLDÁS: Kérjük, töltse fel egy webszerverre (pl. GitHub Pages) és onnan nyissa meg a játékot!</p>
                    <button onclick="this.parentNode.remove()" style="margin-top: 40px; padding: 10px 30px; background-color: #00ffff; color: #1a1a1a; border: none; border-radius: 5px; cursor: pointer;">Értem, mégis megnyitom</button>
                `;
                document.body.appendChild(errorOverlay);
                document.body.style.visibility = 'visible';
                document.body.style.opacity = 1;
                return; // Megállítja a játék inicializálását
            }

            // A tartalom doboz alapértelmezett elrejtése
            const contentBox = document.getElementById('content-box');

            try {
                console.log("[DBG] Játék indítása...");
                // --- BIZTONSÁGOS INDÍTÁS ---
                let CONFIG = getDefaultConfig();
                
                // --- KONFIGURÁCIÓ BETÖLTÉSE ---
                // 1. Exportált (beágyazott) konfiguráció ellenőrzése (window.GAME_CONFIG_INJECTED használatával)
                if (window.GAME_CONFIG_INJECTED && Object.keys(window.GAME_CONFIG_INJECTED).length > 0) {
                     const parsedConfig = window.GAME_CONFIG_INJECTED;
                     CONFIG = { ...CONFIG, ...parsedConfig };
                     // Alobjektumok mélyebb összevonása
                     if(parsedConfig.AVATARS) CONFIG.AVATARS = { ...CONFIG.AVATARS, ...parsedConfig.AVATARS };
                     if(parsedConfig.GPS_COMPASS) CONFIG.GPS_COMPASS = { ...CONFIG.GPS_COMPASS, ...parsedConfig.GPS_COMPASS };
                     if(parsedConfig.MEDIA) CONFIG.MEDIA = { ...CONFIG.MEDIA, ...parsedConfig.MEDIA };
                     console.log("[DBG] Játék betöltve exportált (beágyazott) konfigurációval.");
                } else {
                    // 2. Helyi (Canvas/LocalStorage) konfiguráció betöltése (ha nem exportált, hanem csak Preview)
                    try {
                        const savedConfig = localStorage.getItem('DYNAMIC_CONFIG');
                        if (savedConfig) { 
                            const parsed = JSON.parse(savedConfig);
                            CONFIG = { ...CONFIG, ...parsed };
                            CONFIG.AVATARS = { ...CONFIG.AVATARS, ...parsed.AVATARS };
                            CONFIG.GPS_COMPASS = { ...CONFIG.GPS_COMPASS, ...parsed.GPS_COMPASS };
                            CONFIG.MEDIA = { ...CONFIG.MEDIA, ...parsed.MEDIA };
                            console.log("[DBG] Játék betöltve LocalStorage konfigurációval (Preview mód).");
                        }
                    } catch(e) { console.warn("[DBG] LocalStorage config hiba (lehet hogy tiltva van):", e.message); } 
                }

                let currentPartIndex = 0;
                let watchId = null;
                let currentHelpIndex = 0;
                let currentScale = 1.0; 
                const MAX_SCALE = 2.5; 
                const MIN_SCALE = 1.0;

                const { storyPages, AVATARS, GPS_COMPASS } = CONFIG;

                // Ellenőrzés: Van-e egyáltalán oldal?
                if (!storyPages || storyPages.length === 0) {
                    throw new Error("Nincsenek történet oldalak (storyPages) a konfigurációban!");
                }

                // DOM Elemek
                const els = {
                    storyDisplay: document.getElementById('story-text-display'), storyImage: document.getElementById('story-image'),
                    avatarImg: document.getElementById('avatar-img'), contentBox: document.getElementById('content-box'),
                    nextBtn: document.getElementById('next-page-button'), prevBtn: document.getElementById('prev-page-button'),
                    discreetBackBtn: document.getElementById('discreet-back-button'),
                    interactionCont: document.getElementById('interaction-container'), passCont: document.getElementById('password-container'),
                    multiChoiceCont: document.getElementById('multi-choice-container'),
                    passInput: document.getElementById('password-input'), checkBtn: document.getElementById('check-password-button'),
                    msgDisplay: document.getElementById('message'), distModal: document.getElementById('distanceModal'),
                    distDisplay: document.getElementById('distance-modal-display'), distStatus: document.getElementById('distance-status'),
                    helpModal: document.getElementById('help-modal'), helpText: document.getElementById('help-text-display'),
                    galleryModal: document.getElementById('galleryModal'), galleryContainer: document.getElementById('gallery-container'),
                    fullImageModal: document.getElementById('full-image-display'), fullImage: document.getElementById('fullImageDisplay')
                };

                // Init Stílusok (Hibatűrő módosítás)
                const appTitleEl = document.getElementById('app-title');
                if(CONFIG.APP_TITLE && appTitleEl) appTitleEl.textContent = CONFIG.APP_TITLE;

                document.documentElement.style.setProperty('--bg-color', CONFIG.BODY_BG_COLOR);
                document.documentElement.style.setProperty('--text-color', CONFIG.BODY_TEXT_COLOR);
                
                if (els.storyImage) {
                    els.storyImage.src = CONFIG.BACKGROUND_URL;
                    console.log(`[DBG] Globális háttér URL beállítva: ${CONFIG.BACKGROUND_URL}`);
                }
                
                const audio1 = document.getElementById('story-audio-1');
                if (audio1) audio1.src = CONFIG.MEDIA.AUDIO_1_URL;
                const audio2 = document.getElementById('story-audio-2');
                if (audio2) audio2.src = CONFIG.MEDIA.AUDIO_2_URL;
                
                const distMapBtn = document.getElementById('distance-modal-map-button');
                if (distMapBtn) distMapBtn.href = GPS_COMPASS.MAP_BUTTON_URL;
                
                const mapBtn = document.getElementById('map-button');
                if (mapBtn) mapBtn.onclick = () => window.open(CONFIG.MENU_LINKS.MAP_LINK_URL, '_blank');
                
                const passPromptTextEl = document.getElementById('password-prompt-text');
                if (passPromptTextEl) passPromptTextEl.textContent = CONFIG.PASSWORD_PAGE.PROMPT_TEXT || "Kód:";
                // (Init Stílusok vége)

                function loadProgress() {
                    try {
                        // Exportált fájl esetén nem töltjük be a LocalStorage-ból
                        if (window.GAME_CONFIG_INJECTED && Object.keys(window.GAME_CONFIG_INJECTED).length > 0) return; 

                        const saved = localStorage.getItem('gameProgress');
                        if (saved !== null) {
                            currentPartIndex = Math.min(parseInt(saved), storyPages.length - 1);
                        }
                    } catch(e) { console.warn("[DBG] Progress load failed:", e); }
                }
                function saveProgress() { 
                    try { 
                        if (window.GAME_CONFIG_INJECTED && Object.keys(window.GAME_CONFIG_INJECTED).length > 0) return;
                        localStorage.setItem('gameProgress', currentPartIndex); 
                    } catch(e) {} 
                }

                function stopAllAudio() {
                    ['1','2'].forEach(id => {
                        const aud = document.getElementById('story-audio-'+id);
                        const btn = document.getElementById('play-audio-button-'+id);
                        if (aud) aud.pause(); 
                        if (aud) aud.currentTime = 0;
                        if (btn) btn.innerHTML = `▶️ Lejátszás (${id})`;
                        const container = document.getElementById('audio-container-'+id);
                        if (container) container.style.display = 'none';
                    });
                }
                
                function toggleAudio(id) {
                    const aud = document.getElementById('story-audio-'+id);
                    const btn = document.getElementById('play-audio-button-'+id);
                    if (!aud || !btn) return;

                    if(aud.paused) { 
                        stopAllAudio(); 
                        document.getElementById('audio-container-'+id).style.display = 'block'; 
                        aud.play(); btn.innerHTML = `⏸️ Szünet (${id})`; 
                    } else { 
                        aud.pause(); btn.innerHTML = `▶️️ Lejátszás (${id})`; 
                    }
                }
                
                function updateUI() {
                    stopAllAudio();
                    const page = storyPages[currentPartIndex];
                    if (!page) return;

                    let activeBg = CONFIG.BACKGROUND_URL;
                    
                    // Keresés az oldalspecifikus háttérre
                    for(let i = 0; i <= currentPartIndex; i++) {
                        if (storyPages[i] && storyPages[i].customBackgroundUrl && storyPages[i].customBackgroundUrl.trim() !== '') {
                            activeBg = storyPages[i].customBackgroundUrl;
                        }
                    }
                    if (els.storyImage) {
                        els.storyImage.src = activeBg;
                        console.log(`[DBG] Jelenlegi háttér URL: ${activeBg}`);
                    }


                    const prefix = page.content.split(' ')[0];
                    let avatarUrl = AVATARS.DEFAULT_AVATAR_URL;
                    let opacity = 1;
                    let text = page.content;

                    if (page.customAvatarUrl && page.customAvatarUrl.trim() !== '') {
                        avatarUrl = page.customAvatarUrl;
                        if (AVATARS.AVATAR_MAP[prefix] || AVATARS.HIDDEN_PREFIXES.includes(prefix)) {
                            text = text.substring(prefix.length).trim();
                        }
                    } else {
                        if (AVATARS.AVATAR_MAP[prefix]) { 
                            avatarUrl = AVATARS.AVATAR_MAP[prefix]; 
                            text = text.substring(prefix.length).trim(); 
                        } else if (AVATARS.HIDDEN_PREFIXES.includes(prefix)) { 
                            opacity = 0; 
                            text = text.substring(prefix.length).trim();
                        }
                    }

                    if (!page.customAvatarUrl && AVATARS.HIDDEN_PREFIXES.includes(prefix)) {
                        opacity = 0;
                    }
                    
                    // --- MÓDOSÍTOTT LOGIKA: Narrátor és Choice oldalakon rejtett avatar ---
                    // Meghatározza, hogy az avatár láthatónak kell-e lennie (opacity > 0)
                    let isAvatarVisible = opacity !== 0;

                    // További szabályok az elrejtésre: Narrátor prefix vagy 'choice' típusú oldal
                    if (AVATARS.HIDDEN_PREFIXES.includes(prefix) || page.type === 'choice') {
                        opacity = 0;
                        isAvatarVisible = false;
                    }

                    if (els.avatarImg) els.avatarImg.src = avatarUrl;
                    if (els.avatarImg) els.avatarImg.style.opacity = opacity;
                    
                    // KRITIKUS FIX: Eltávolítja az avatárt a layout-ból, amikor rejtve van.
                    if (els.avatarImg) els.avatarImg.style.display = isAvatarVisible ? 'block' : 'none';

                    // Megjelenítési beállítás: ha nincs avatár, csökkentjük a felső párnázást
                    if (contentBox) contentBox.style.paddingTop = isAvatarVisible ? '40px' : '10px';
                    // ------------------------------------------------------------------

                    if (els.storyDisplay) els.storyDisplay.innerHTML = text;

                    if (els.interactionCont) els.interactionCont.style.display = 'flex';
                    if (els.passCont) els.passCont.classList.remove('visible');
                    if (els.multiChoiceCont) els.multiChoiceCont.style.display = 'none';
                    if (els.msgDisplay) els.msgDisplay.textContent = '';
                    if (els.passInput) els.passInput.value = '';

                    if (page.type === 'password') {
                        if (els.interactionCont) els.interactionCont.style.display = 'none';
                        if (els.passCont) els.passCont.classList.add('visible');
                        const helpBtn = document.getElementById('help-button');
                        if (helpBtn) helpBtn.style.display = page.helpMessage ? 'inline-block' : 'none';
                    } 
                    else if (page.type === 'choice') {
                        if (els.interactionCont) els.interactionCont.style.display = 'none';
                        if (els.multiChoiceCont) els.multiChoiceCont.style.display = 'flex';
                        if (els.multiChoiceCont) els.multiChoiceCont.innerHTML = '';
                        
                        if (page.choices && page.choices.length > 0) {
                            page.choices.forEach(choice => {
                                const btn = document.createElement('button');
                                btn.className = 'choice-button';
                                btn.textContent = choice.text;
                                btn.onclick = () => {
                                    currentPartIndex = choice.nextIndex !== undefined ? choice.nextIndex : currentPartIndex + 1;
                                    saveProgress();
                                    showStory();
                                };
                                if (els.multiChoiceCont) els.multiChoiceCont.appendChild(btn);
                            });
                        }
                    }
                    else if (page.type === 'audio') {
                        const audioCont = document.getElementById('audio-container-' + (page.audioId || 1));
                        if (audioCont) audioCont.style.display = 'block';
                        if (els.nextBtn) els.nextBtn.textContent = page.nextButtonText || 'Tovább';
                    } 
                    else {
                        if (els.nextBtn) els.nextBtn.textContent = 'Tovább';
                    }

                    if (currentPartIndex === storyPages.length - 1 && page.type !== 'password' && page.type !== 'choice') {
                        if (els.nextBtn) els.nextBtn.textContent = "Célpont Keresése";
                    }
                    
                    const isFirstPage = currentPartIndex === 0;
                    
                    // --- DISZKRÉT VISSZA GOMB LOGIKA FRISSÍTÉSE ---
                    // Csak 'choice' oldalakon látható, ha nem az első oldal.
                    // Típusok, ahol rejtve marad: 'text', 'password', 'audio'.
                    let shouldDiscreetBackBeHidden = isFirstPage || 
                                                     page.type === 'text' || 
                                                     page.type === 'password' || 
                                                     page.type === 'audio';
                    
                    if (els.prevBtn) els.prevBtn.disabled = isFirstPage; // A fő Vissza gomb marad az alsó sávban
                    if (els.discreetBackBtn) els.discreetBackBtn.disabled = shouldDiscreetBackBeHidden; // A diszkrét gomb vezérlése
                }

                function showStory() {
                    console.log(`[DBG] Oldal váltása: Index ${currentPartIndex}`);
                    // Átmeneti rejtés az oldalváltáskor
                    if (els.contentBox) els.contentBox.classList.add('content-hidden');
                    setTimeout(() => {
                        updateUI();
                        // Megjelenítés az oldal betöltése után
                        if (els.contentBox) els.contentBox.classList.remove('content-hidden');
                    }, 100);
                }

                function getVisibleGalleryImages() {
                    let images = [];
                    for(let i = 0; i <= currentPartIndex; i++) {
                        const p = storyPages[i];
                        
                        // 1. Galéria ürítése
                        if (p.galleryMode === 'clear') {
                            images = []; 
                        } 
                        
                        // Új logikai blokk a több URL kezelésére
                        if (p.customGalleryUrl && p.customGalleryUrl.trim() !== '') {
                            // URL-ek szétválasztása (soronként vagy vesszővel), üres sorok kihagyása
                            const urls = p.customGalleryUrl.split(/[\n,]/).map(url => url.trim()).filter(url => url.length > 0);

                            urls.forEach(url => {
                                const existingIndex = images.indexOf(url);

                                // 2. Kép hozzáadása (akkumulál)
                                if (p.galleryMode === 'add_url' || !p.galleryMode) {
                                    if (existingIndex === -1) {
                                        images.push(url);
                                    }
                                } 
                                // 3. Kép eltávolítása
                                else if (p.galleryMode === 'remove_url') {
                                    if (existingIndex !== -1) {
                                        images.splice(existingIndex, 1);
                                    }
                                }
                            });
                        }
                    }
                    return images;
                }

                function populateGallery() {
                    if (!els.galleryContainer) return;

                    els.galleryContainer.innerHTML = '';
                    const images = getVisibleGalleryImages();
                    if (images.length === 0) {
                        els.galleryContainer.innerHTML = '<p style="grid-column: 1/-1; color:gray;">Jelenleg nincs aktív kép.</p>';
                        return;
                    }
                    images.forEach((url, index) => {
                        const thumbnailDiv = document.createElement('div');
                        thumbnailDiv.className = 'gallery-thumbnail';
                        const img = document.createElement('img');
                        img.src = url;
                        img.alt = "Galéria Kép " + (index + 1);
                        // Hozzáadott hibafigyelő a galéria képekhez
                        img.onerror = function() { console.error(`[DBG] Galéria kép betöltési hiba a címen: ${url}`); this.onerror=null; this.style.opacity='0.2'; };
                        thumbnailDiv.onclick = () => openFullImage(url);
                        thumbnailDiv.appendChild(img);
                        els.galleryContainer.appendChild(thumbnailDiv);
                    });
                }

                function setScaleTransform() {
                    if (els.fullImage) {
                        els.fullImage.style.transform = `scale(${currentScale})`;
                        els.fullImage.style.cursor = currentScale > MIN_SCALE ? 'zoom-out' : 'zoom-in';
                    }
                }

                function toggleZoom() {
                    currentScale = (currentScale > MIN_SCALE) ? MIN_SCALE : MAX_SCALE;
                    setScaleTransform();
                }

                function openFullImage(url) {
                    if (els.fullImage) els.fullImage.src = url;
                    currentScale = MIN_SCALE;
                    setScaleTransform();
                    if (els.fullImageModal) els.fullImageModal.style.display = 'flex';
                    if (els.galleryModal) els.galleryModal.style.display = 'none';
                }

                function closeFullImage() {
                    if (els.fullImageModal) els.fullImageModal.style.display = 'none';
                }

                function openGallery() {
                    populateGallery();
                    if (els.galleryModal) els.galleryModal.style.display = 'block';
                }

                function closeGallery() {
                    if (els.galleryModal) els.galleryModal.style.display = 'none';
                    closeFullImage();
                }

                let lastTap = 0;
                if (els.fullImage) {
                    els.fullImage.addEventListener('click', (e) => {
                        const now = new Date().getTime();
                        const timesince = now - lastTap;
                        if (timesince < 300 && timesince > 0) {
                            e.preventDefault();
                            toggleZoom();
                        } 
                        lastTap = now;
                    });
                    els.fullImage.addEventListener('dblclick', (e) => {
                        e.preventDefault();
                        toggleZoom();
                    });
                }

                if (els.nextBtn) {
                    els.nextBtn.onclick = () => {
                        if (currentPartIndex === storyPages.length - 1) {
                            startGPS();
                            return;
                        }
                        const page = storyPages[currentPartIndex];
                        currentPartIndex = page.nextIndex !== undefined ? page.nextIndex : currentPartIndex + 1;
                        saveProgress();
                        showStory();
                    };
                }

                if (els.prevBtn) {
                    els.prevBtn.onclick = () => {
                        const page = storyPages[currentPartIndex];
                        currentPartIndex = page.backIndex !== undefined ? page.backIndex : Math.max(0, currentPartIndex - 1);
                        saveProgress();
                        showStory();
                    };
                }
                
                if (els.discreetBackBtn) els.discreetBackBtn.onclick = els.prevBtn.onclick;
                const passBackBtn = document.getElementById('back-button-password');
                if (passBackBtn) passBackBtn.onclick = els.prevBtn.onclick;

                if (els.checkBtn) {
                    els.checkBtn.onclick = () => {
                        const page = storyPages[currentPartIndex];
                        if (!els.passInput || !els.msgDisplay) return;

                        if (els.passInput.value.trim() === page.correctPassword) {
                            els.msgDisplay.textContent = CONFIG.PASSWORD_PAGE.SUCCESS_MESSAGE || "Helyes!";
                            els.msgDisplay.style.color = '#00ff00';
                            setTimeout(() => {
                                if (page.nextIndexSuccess === -1) startGPS();
                                else {
                                    currentPartIndex = page.nextIndexSuccess !== undefined ? page.nextIndexSuccess : currentPartIndex + 1;
                                    saveProgress();
                                    showStory();
                                }
                            }, 1000);
                        } else {
                            els.msgDisplay.textContent = CONFIG.PASSWORD_PAGE.ERROR_MESSAGE || "Hibás kód!";
                            els.msgDisplay.style.color = 'red';
                        }
                    };
                }

                const audioBtn1 = document.getElementById('play-audio-button-1');
                if (audioBtn1) audioBtn1.onclick = () => toggleAudio('1');
                const audioBtn2 = document.getElementById('play-audio-button-2');
                if (audio2) audio2.onclick = () => toggleAudio('2');

                function startGPS() {
                    if (els.contentBox) els.contentBox.classList.add('content-hidden'); // Áttűnés a tartalom dobozról
                    if (els.distModal) els.distModal.style.display = 'flex';
                    
                    const targetLat = parseFloat(GPS_COMPASS.TARGET_LATITUDE);
                    const targetLon = parseFloat(GPS_COMPASS.TARGET_LONGITUDE);
                    
                    if (!els.distStatus) return;

                    if (!navigator.geolocation) {
                        els.distStatus.textContent = "A böngésző nem támogatja a helymeghatározást.";
                        return;
                    }

                    navigator.geolocation.watchPosition(pos => {
                        const lat = pos.coords.latitude;
                        const lon = pos.coords.longitude;
                        const R = 6371e3;
                        const dLat = (targetLat - lat) * Math.PI/180;
                        const dLon = (targetLon - lon) * Math.PI/180;
                        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat*Math.PI/180) * Math.cos(targetLat*Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
                        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                        const dist = R * c;

                        if (els.distDisplay) els.distDisplay.textContent = Math.round(dist) + " M";
                        els.distStatus.textContent = `Pontosság: ${Math.round(pos.coords.accuracy)}m`;

                        if (dist < GPS_COMPASS.SUCCESS_RADIUS_M) {
                            els.distStatus.textContent = "MEGÉRKEZTÉL!";
                            els.distStatus.style.color = "#00ff00";
                            setTimeout(() => window.location.href = GPS_COMPASS.SUCCESS_REDIRECT_URL, 3000);
                        }
                    }, err => {
                        els.distStatus.textContent = "GPS Hiba: " + err.message;
                        els.distStatus.style.color = "red";
                    }, { enableHighAccuracy: true });
                }

                const imageBtn = document.getElementById('image-button');
                if (imageBtn) imageBtn.onclick = openGallery;

                const closeGalleryBtn = document.querySelector('#galleryModal .close-gallery');
                if (closeGalleryBtn) closeGalleryBtn.onclick = closeGallery;

                const closeFullImageBtn = document.querySelector('#full-image-display .close-gallery');
                if (closeFullImageBtn) closeFullImageBtn.onclick = closeFullImage;

                const helpBtn = document.getElementById('help-button');
                if (helpBtn) {
                    helpBtn.onclick = () => {
                        const page = storyPages[currentPartIndex];
                        if(page.helpMessage && els.helpModal && els.helpText) {
                            currentHelpIndex = 0;
                            const msgs = Array.isArray(page.helpMessage) ? page.helpMessage : [page.helpMessage];
                            els.helpText.textContent = msgs[0];
                            els.helpModal.style.display = 'flex';
                            const helpNextBtn = document.getElementById('help-next-button');
                            if (helpNextBtn) helpNextBtn.style.display = msgs.length > 1 ? 'inline-block' : 'none';
                        }
                    };
                }

                const helpCloseBtn = document.getElementById('help-close-button');
                if (helpCloseBtn) helpCloseBtn.onclick = () => { if (els.helpModal) els.helpModal.style.display = 'none'; };

                const helpNextBtn = document.getElementById('help-next-button');
                if (helpNextBtn) {
                    helpNextBtn.onclick = () => {
                        const page = storyPages[currentPartIndex];
                        const msgs = Array.isArray(page.helpMessage) ? page.helpMessage : [page.helpMessage];
                        currentHelpIndex++;
                        if(currentHelpIndex < msgs.length) {
                            if (els.helpText) els.helpText.textContent = msgs[currentHelpIndex];
                            if(currentHelpIndex === msgs.length - 1) {
                                if (helpNextBtn) helpNextBtn.style.display = 'none';
                            }
                        }
                    };
                }


                loadProgress();
                showStory(); // showStory hívása, ami meghívja az updateUI-t
                
                // A tartalom doboz lassú megjelenítése (initial fade-in)
                if (els.contentBox) els.contentBox.classList.remove('content-hidden');

                // SIKERES INDÍTÁS: Felfedjük az oldalt (body tag-en keresztül)
                document.body.style.visibility = 'visible';
                document.body.style.opacity = 1;

            } catch (err) {
                // KRITIKUS HIBAKEZELÉS: Ha bármi elszáll, kiírjuk a képernyőre
                console.error("Critical Start Error:", err);
                
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = "color:#ff5555; padding:30px; text-align:center; font-family:sans-serif; background:rgba(0,0,0,0.8); border: 2px solid red; margin: 10vh auto; max-width: 90%; border-radius: 10px;";
                errorDiv.innerHTML = `
                    <h1 style="font-size:2em; margin-bottom:10px;">❌ KRITIKUS HIBA AZ INDÍTÁSNÁL ❌</h1>
                    <p style="font-size:1.2em; color:#ddd;">A játék nem tudta betölteni a beállításokat. Ennek oka valószínűleg: <br> <b>${err.message}</b></p>
                    <p style="font-size:1.2em; color:#00ffff; font-weight: bold; margin-top: 10px;">MEGOLDÁS: Töltsd fel egy webszerverre (pl. GitHub Pages) és onnan nyisd meg!</p>
                    <pre style="background:#333; padding:15px; border-radius:5px; margin:20px auto; max-width:100%; overflow:auto; text-align:left; color:#fff; font-size: 0.8em;">Stack: ${err.stack || 'Nincs stack trace.'}</pre>
                `;

                // Csak akkor állítjuk be a hibaképernyőt, ha a body létezik
                if (document.body) {
                    document.body.style.backgroundColor = '#111'; // biztos fekete
                    document.body.innerHTML = ''; // Először töröljük a tartalom dobozt (de a menüsort hagyjuk)
                    document.body.appendChild(errorDiv);

                    // Mivel itt dobódik a hiba, a body láthatóvá tétele is itt kell
                    document.body.style.visibility = 'visible';
                    document.body.style.opacity = 1;
                }
            }
        })();
    </script>
</body>
</html>
