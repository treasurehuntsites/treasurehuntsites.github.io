<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interakt√≠v T√∂rt√©net Szerkeszt≈ë</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --primary-color: #8a2be2; /* BlueViolet */
            --secondary-color: #00ffff; /* Cyan */
        }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: sans-serif; }
        .container { max-width: 900px; margin: auto; padding: 20px; }
        .input-group { margin-bottom: 15px; }
        input[type="text"], textarea, input[type="number"] {
            background-color: #333; border: 1px solid var(--primary-color); color: var(--text-color); padding: 10px; border-radius: 5px; width: 100%;
        }
        .section-header { background-color: #333; color: var(--secondary-color); padding: 10px; border-radius: 5px; margin-top: 20px; font-weight: bold; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .section-content { border: 1px solid #444; padding: 15px; border-radius: 0 0 5px 5px; margin-bottom: 20px; }
        .story-page { border: 2px solid var(--primary-color); padding: 15px; margin-bottom: 15px; border-radius: 8px; background-color: #2c2c2c; position: relative; }
        .btn { padding: 10px 15px; border-radius: 5px; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: #7b1cd1; }
        .btn-secondary { background-color: var(--secondary-color); color: var(--bg-color); }
        .btn-secondary:hover { background-color: #00ddee; }
        .btn-danger { background-color: #cc0000; color: white; }
        .btn-danger:hover { background-color: #aa0000; }
        .collapsed .section-content { display: none; }
        .choice-item { background-color: #444; padding: 10px; border-radius: 5px; margin-top: 10px; }
        .file-protocol-warning { background-color: #ffcc00; color: #333; padding: 10px; border-radius: 5px; margin-bottom: 20px; font-weight: bold; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <div class="container">
        <h1 class="text-3xl font-bold text-center text-white mb-6">üîë Interakt√≠v T√∂rt√©net Adminisztr√°ci√≥ üîë</h1>
        
        <div id="protocol-warning" class="file-protocol-warning" style="display: none;">
            ‚ö†Ô∏è **FIGYELEM!** A helyi f√°jl megnyit√°sa eset√©n a ment√©s/bet√∂lt√©s (LocalStorage) nem mindig m≈±k√∂dik megb√≠zhat√≥an! K√©rj√ºk, szerkeszd ezt a f√°jlt GitHub Pages vagy m√°s webszerver seg√≠ts√©g√©vel!
        </div>

        <div class="flex justify-between items-center mb-6 p-4 bg-gray-800 rounded-lg shadow-lg">
            <div id="save-status" class="font-bold text-lg"></div>
            <div class="space-x-4">
                <button id="save-config" class="btn btn-secondary">
                    <i class="fa-solid fa-floppy-disk"></i> Ment√©s (Local)
                </button>
                <button id="export-game" class="btn btn-primary">
                    <i class="fa-solid fa-file-export"></i> Export√°l√°s (Let√∂lt√©s)
                </button>
                <button id="preview-game" class="btn btn-primary">
                    <i class="fa-solid fa-eye"></i> J√°t√©k Pr√≥ba (Preview)
                </button>
            </div>
        </div>

        <div id="general-settings" class="collapsed">
            <div class="section-header">√Åltal√°nos J√°t√©k Be√°ll√≠t√°sok <i class="fa-solid fa-chevron-down"></i></div>
            <div class="section-content">
                <div class="input-group">
                    <label>App C√≠me:</label>
                    <input type="text" id="app-title-input">
                </div>
                <div class="input-group">
                    <label>Alap√©rtelmezett H√°tt√©r URL (Glob√°lis):</label>
                    <input type="text" id="background-url-input">
                </div>
                <div class="input-group">
                    <label>F≈ë T√©rk√©p Link (men√ºb≈ël ny√≠l√≥):</label>
                    <input type="text" id="map-link-url-input" placeholder="Pl: Google Maps link">
                </div>
                <div class="input-group">
                    <label>Sikeres Jelsz√≥ √úzenet:</label>
                    <input type="text" id="password-success-input" placeholder="Pl: Helyes k√≥d! Tov√°bb!">
                </div>
                <div class="input-group">
                    <label>Hib√°s Jelsz√≥ √úzenet:</label>
                    <input type="text" id="password-error-input" placeholder="Pl: Hib√°s k√≥d! Pr√≥b√°ld √∫jra.">
                </div>
            </div>
        </div>

        <div id="gps-settings" class="collapsed">
            <div class="section-header">GPS/Ir√°nyt≈± C√©lpont Be√°ll√≠t√°sok <i class="fa-solid fa-chevron-down"></i></div>
            <div class="section-content">
                <div class="input-group">
                    <label>C√©lpont Sz√©less√©g (Latitude):</label>
                    <input type="text" id="target-lat-input" placeholder="Pl: 47.497913">
                </div>
                <div class="input-group">
                    <label>C√©lpont Hossz√∫s√°g (Longitude):</label>
                    <input type="text" id="target-lon-input" placeholder="Pl: 19.040236">
                </div>
                <div class="input-group">
                    <label>Sikeres Sug√°r (m√©ter, pl. 25):</label>
                    <input type="number" id="success-radius-input" placeholder="Pl: 25">
                </div>
                <div class="input-group">
                    <label>Sikeres √°tir√°ny√≠t√°si URL (Ha el√©ri a c√©lpontot):</label>
                    <input type="text" id="success-redirect-url-input" placeholder="Pl: busz.html">
                </div>
            </div>
        </div>
        
        <div id="avatar-settings" class="collapsed">
            <div class="section-header">Avat√°r Be√°ll√≠t√°sok <i class="fa-solid fa-chevron-down"></i></div>
            <div class="section-content">
                <div class="input-group">
                    <label>Alap√©rtelmezett Avat√°r URL (Ha nincs prefix):</label>
                    <input type="text" id="default-avatar-url-input">
                </div>
                <div id="avatar-map-container" class="mt-4">
                    <h4 class="font-bold mb-2">Egyedi Avat√°rok (pl. ¬ßM, ¬ßA, ¬ßR):</h4>
                </div>
                <button id="add-avatar-map" class="btn btn-primary text-sm mt-2"><i class="fa-solid fa-plus"></i> √öj Avat√°r Hozz√°ad√°sa</button>
            </div>
        </div>

        <h2 class="text-2xl font-bold mt-8 mb-4 text-white">üìñ T√∂rt√©net Oldalak Sorrendje</h2>
        <div id="story-pages-container">
            </div>
        <button id="add-page" class="btn btn-secondary mt-4"><i class="fa-solid fa-plus"></i> √öj T√∂rt√©netoldal Hozz√°ad√°sa</button>
        
    </div>

<script>
    const STORAGE_KEY = 'DYNAMIC_CONFIG';
    const GAME_TEMPLATE_URL = 'download.html'; // Az export√°l√≥ oldal neve

    // --- ALAP√âRTELMEZETT KONFIGUR√ÅCI√ì ---
    function getDefaultConfig() {
        return {
            APP_TITLE: "Kalandt√∫ra",
            BACKGROUND_URL: "https://placehold.co/1080x1920/1a1a1a/e0e0e0?text=HATTER", 
            BODY_BG_COLOR: "#1a1a1a", BODY_TEXT_COLOR: "#e0e0e0", 
            AVATARS: {
                DEFAULT_AVATAR_URL: "https://placehold.co/70x70/1A1A1A/FFFFFF?text=?",
                AVATAR_MAP: { '¬ßM': "https://placehold.co/70x70/1A1A1A/00FF00?text=M", '¬ßA': "https://placehold.co/70x70/1A1A1A/FF00FF?text=A" },
                HIDDEN_PREFIXES: ['¬ßN', '¬ßKOD', '¬ßH', '¬ßRESET'] 
            },
            MENU_LINKS: { MAP_LINK_URL: 'http://maps.google.com' },
            PASSWORD_PAGE: { PROMPT_TEXT: "Add meg a k√≥dot:", CHECK_BUTTON_TEXT: "Ellen≈ërz√©s", BACK_BUTTON_TEXT: "Vissza", SUCCESS_MESSAGE: "Helyes!", ERROR_MESSAGE: "Hib√°s k√≥d!" },
            GPS_COMPASS: { TARGET_LATITUDE: 47.47407, TARGET_LONGITUDE: 19.04001, SUCCESS_RADIUS_M: 25, SUCCESS_REDIRECT_URL: "busz.html", MAP_BUTTON_URL: 'http://maps.google.com' },
            MEDIA: { AUDIO_1_URL: "", AUDIO_2_URL: "" },
            storyPages: [
                { id: Date.now(), type: 'text', content: '¬ßN Szia! √údv√∂z√∂llek a j√°t√©kban. Kattints a Tov√°bb gombra!', nextIndex: 1 }, 
                { id: Date.now() + 1, type: 'text', content: '¬ßKOD Add meg a jelsz√≥t.', nextIndex: 2 },
                { id: Date.now() + 2, type: 'password', content: '¬ßH S√∫g√≥ sz√∂veg ide. \nS√∫g√≥ m√°sodik sora.', correctPassword: 'JELSZO', nextIndexSuccess: 3, helpMessage: ['Ez az els≈ë s√∫g√≥t√≠pus.', 'Ez a m√°sodik s√∫g√≥t√≠pus.'] },
                { id: Date.now() + 3, type: 'choice', content: 'V√°lassz utat:', nextIndex: undefined, choices: [
                    { text: 'Menj jobbra', nextIndex: 4 },
                    { text: 'Menj balra', nextIndex: 5 }
                ] },
                { id: Date.now() + 4, type: 'text', content: 'Jobb √∫t. V√©ge.', nextIndex: undefined },
                { id: Date.now() + 5, type: 'text', content: 'Bal √∫t. V√©ge.', nextIndex: undefined },
            ]
        };
    }

    // Glob√°lis v√°ltoz√≥k a konfigur√°ci√≥ √©s az √°llapot t√°rol√°s√°ra
    let config = getDefaultConfig();
    let avatarMap = config.AVATARS.AVATAR_MAP;

    // --- DOM KEZEL√âS √âS BET√ñLT√âS/MENT√âS LOGIKA ---

    function saveConfig() {
        try {
            // 1. √Åltal√°nos adatok gy≈±jt√©se
            config.APP_TITLE = document.getElementById('app-title-input').value;
            config.BACKGROUND_URL = document.getElementById('background-url-input').value;
            config.MENU_LINKS.MAP_LINK_URL = document.getElementById('map-link-url-input').value;
            
            config.PASSWORD_PAGE.SUCCESS_MESSAGE = document.getElementById('password-success-input').value;
            config.PASSWORD_PAGE.ERROR_MESSAGE = document.getElementById('password-error-input').value;

            // 2. GPS adatok gy≈±jt√©se
            config.GPS_COMPASS.TARGET_LATITUDE = parseFloat(document.getElementById('target-lat-input').value) || config.GPS_COMPASS.TARGET_LATITUDE;
            config.GPS_COMPASS.TARGET_LONGITUDE = parseFloat(document.getElementById('target-lon-input').value) || config.GPS_COMPASS.TARGET_LONGITUDE;
            config.GPS_COMPASS.SUCCESS_RADIUS_M = parseInt(document.getElementById('success-radius-input').value) || config.GPS_COMPASS.SUCCESS_RADIUS_M;
            config.GPS_COMPASS.SUCCESS_REDIRECT_URL = document.getElementById('success-redirect-url-input').value;

            // 3. Avat√°rok gy≈±jt√©se
            config.AVATARS.DEFAULT_AVATAR_URL = document.getElementById('default-avatar-url-input').value;
            config.AVATARS.AVATAR_MAP = collectAvatarMap();

            // 4. T√∂rt√©net oldalak gy≈±jt√©se
            config.storyPages = collectStoryPages();

            // 5. Ment√©s
            localStorage.setItem(STORAGE_KEY, JSON.stringify(config));
            
            // 6. St√°tusz friss√≠t√©se
            updateSaveStatus("Mentve! (" + new Date().toLocaleTimeString() + ")", "text-green-500");

        } catch (e) {
            console.error("Hiba a ment√©s sor√°n:", e);
            updateSaveStatus("Ment√©si Hiba: " + e.message, "text-red-500");
        }
    }

    function loadConfig() {
        try {
            const savedConfig = localStorage.getItem(STORAGE_KEY);
            if (savedConfig) {
                config = { ...getDefaultConfig(), ...JSON.parse(savedConfig) };
                
                // M√©ly merge az alobjektumokra is
                if (JSON.parse(savedConfig).AVATARS) config.AVATARS = { ...getDefaultConfig().AVATARS, ...JSON.parse(savedConfig).AVATARS };
                if (JSON.parse(savedConfig).GPS_COMPASS) config.GPS_COMPASS = { ...getDefaultConfig().GPS_COMPASS, ...JSON.parse(savedConfig).GPS_COMPASS };
                if (JSON.parse(savedConfig).PASSWORD_PAGE) config.PASSWORD_PAGE = { ...getDefaultConfig().PASSWORD_PAGE, ...JSON.parse(savedConfig).PASSWORD_PAGE };
                if (JSON.parse(savedConfig).MENU_LINKS) config.MENU_LINKS = { ...getDefaultConfig().MENU_LINKS, ...JSON.parse(savedConfig).MENU_LINKS };

                avatarMap = config.AVATARS.AVATAR_MAP; // Friss√≠tj√ºk a szerkeszt≈ëben haszn√°lt t√©rk√©pet
                
                renderUI();
                updateSaveStatus("Bet√∂ltve LocalStorage-b√≥l.", "text-blue-500");
                return true;
            }
            // Ha nincs mentett adat, alap√©rtelmezett UI bet√∂lt√©se
            renderUI();
            updateSaveStatus("Alap√©rtelmezett konfigur√°ci√≥ bet√∂ltve.", "text-yellow-500");
            return false;

        } catch (e) {
            console.error("Hiba a bet√∂lt√©s sor√°n (Local Storage korrupt?):", e);
            updateSaveStatus("Bet√∂lt√©si Hiba: " + e.message + " (Alap√©rtelmezett bet√∂ltve.)", "text-red-500");
            config = getDefaultConfig();
            renderUI();
            return false;
        }
    }

    function updateSaveStatus(message, className) {
        const statusEl = document.getElementById('save-status');
        statusEl.textContent = message;
        statusEl.className = `font-bold text-lg ${className}`;
    }

    // --- UI RENDEREL√âS √âS M≈∞K√ñD√âS ---

    function renderUI() {
        // √Åltal√°nos adatok
        document.getElementById('app-title-input').value = config.APP_TITLE || '';
        document.getElementById('background-url-input').value = config.BACKGROUND_URL || '';
        document.getElementById('map-link-url-input').value = config.MENU_LINKS.MAP_LINK_URL || '';
        document.getElementById('password-success-input').value = config.PASSWORD_PAGE.SUCCESS_MESSAGE || '';
        document.getElementById('password-error-input').value = config.PASSWORD_PAGE.ERROR_MESSAGE || '';
        
        // GPS adatok
        document.getElementById('target-lat-input').value = config.GPS_COMPASS.TARGET_LATITUDE || '';
        document.getElementById('target-lon-input').value = config.GPS_COMPASS.TARGET_LONGITUDE || '';
        document.getElementById('success-radius-input').value = config.GPS_COMPASS.SUCCESS_RADIUS_M || '';
        document.getElementById('success-redirect-url-input').value = config.GPS_COMPASS.SUCCESS_REDIRECT_URL || '';

        // Avat√°rok
        document.getElementById('default-avatar-url-input').value = config.AVATARS.DEFAULT_AVATAR_URL || '';
        renderAvatarMap();
        
        // T√∂rt√©net
        renderStoryPages();
    }

    // --- AVATAR MAP RENDEREL√âS ---

    function renderAvatarMap() {
        const container = document.getElementById('avatar-map-container');
        container.innerHTML = '<h4 class="font-bold mb-2">Egyedi Avat√°rok (pl. ¬ßM, ¬ßA, ¬ßR):</h4>';
        
        const map = config.AVATARS.AVATAR_MAP || {};
        
        Object.keys(map).forEach(prefix => {
            if (!config.AVATARS.HIDDEN_PREFIXES.includes(prefix)) { // Ne mutassuk a rejtett prefixeket itt
                const item = createAvatarMapItem(prefix, map[prefix]);
                container.appendChild(item);
            }
        });
    }

    function createAvatarMapItem(prefix = '', url = '') {
        const div = document.createElement('div');
        div.className = 'flex space-x-2 mb-2 items-center';
        div.innerHTML = `
            <input type="text" class="w-16 avatar-prefix" value="${prefix}" placeholder="¬ßX" maxlength="4">
            <input type="text" class="flex-grow avatar-url" value="${url}" placeholder="K√©p URL (pl. https://...)">
            <button class="btn btn-danger btn-sm remove-avatar-map"><i class="fa-solid fa-trash"></i></button>
        `;
        div.querySelector('.remove-avatar-map').onclick = () => div.remove();
        return div;
    }

    function collectAvatarMap() {
        const newMap = {};
        const items = document.querySelectorAll('#avatar-map-container .flex');
        
        items.forEach(item => {
            const prefix = item.querySelector('.avatar-prefix').value.trim();
            const url = item.querySelector('.avatar-url').value.trim();
            if (prefix && url) {
                newMap[prefix] = url;
            }
        });
        
        // Visszaadjuk az alap√©rtelmezett rejtett prefixeket is (amik nem szerkeszthet≈ëk a UI-ban)
        const defaultMap = getDefaultConfig().AVATARS.AVATAR_MAP;
        const hiddenPrefixes = getDefaultConfig().AVATARS.HIDDEN_PREFIXES;
        
        hiddenPrefixes.forEach(prefix => {
            if (defaultMap[prefix]) {
                newMap[prefix] = defaultMap[prefix];
            }
        });
        
        return newMap;
    }

    // --- T√ñRT√âNET RENDEREL√âS ---

    function renderStoryPages() {
        const container = document.getElementById('story-pages-container');
        container.innerHTML = '';
        
        config.storyPages.forEach((page, index) => {
            const pageEl = createStoryPageElement(page, index);
            container.appendChild(pageEl);
        });
    }

    function createStoryPageElement(page, index) {
        const div = document.createElement('div');
        div.className = 'story-page';
        div.setAttribute('data-id', page.id);
        
        // Oldal c√≠me √©s gombok
        div.innerHTML = `
            <h3 class="text-xl font-bold mb-3 text-white">
                ${index}. Oldal (<span class="page-type">${page.type.toUpperCase()}</span>)
            </h3>
            <button class="btn btn-danger btn-sm absolute top-3 right-3 remove-page"><i class="fa-solid fa-trash"></i> T√∂rl√©s</button>
            <button class="btn btn-primary btn-sm absolute top-3 right-24 move-up" title="Fel"><i class="fa-solid fa-arrow-up"></i></button>
            <button class="btn btn-primary btn-sm absolute top-3 right-16 move-down" title="Le"><i class="fa-solid fa-arrow-down"></i></button>
            
            <div class="input-group">
                <label>Oldal T√≠pusa:</label>
                <select class="page-type-select input-group">
                    <option value="text">Sz√∂veg (text)</option>
                    <option value="password">Jelsz√≥ (password)</option>
                    <option value="choice">V√°laszt√°s (choice)</option>
                    <option value="audio">Audio (audio)</option>
                    <option value="gps">GPS C√©lpont (gps)</option>
                </select>
            </div>
            
            <div class="input-group page-content-group">
                <label>Tartalom (Besz√©l≈ë prefix: ¬ßM, ¬ßA, ¬ßN stb.):</label>
                <textarea rows="4" class="page-content">${page.content || ''}</textarea>
            </div>

            <div class="page-fields-container mt-4">
                </div>
        `;
        
        const pageTypeSelect = div.querySelector('.page-type-select');
        pageTypeSelect.value = page.type;
        pageTypeSelect.onchange = () => {
            // Friss√≠ti a t√≠pus megjelen√≠t√©s√©t
            div.querySelector('.page-type').textContent = pageTypeSelect.value.toUpperCase();
            // √öjrarajzolja a dinamikus mez≈ëket
            renderDynamicFields(div, page, pageTypeSelect.value);
        };
        
        // T√∂rl√©s
        div.querySelector('.remove-page').onclick = () => {
            if (confirm('Biztosan t√∂r√∂lni szeretn√©d ezt az oldalt?')) {
                config.storyPages = config.storyPages.filter(p => p.id !== page.id);
                renderStoryPages();
                updateSaveStatus("Oldal t√∂r√∂lve. K√©rem, mentse el!", "text-orange-400");
            }
        };
        
        // Mozgat√°s
        div.querySelector('.move-up').onclick = () => movePage(index, -1);
        div.querySelector('.move-down').onclick = () => movePage(index, 1);

        renderDynamicFields(div, page, page.type);
        return div;
    }

    function renderDynamicFields(pageEl, pageData, type) {
        const container = pageEl.querySelector('.page-fields-container');
        container.innerHTML = '';
        
        // --- √Åltal√°nos extra mez≈ëk (minden t√≠pushoz) ---
        const commonFields = [
             { label: 'Egyedi Avat√°r URL (fel√ºl√≠rja a prefixet):', id: 'custom-avatar-url', value: pageData.customAvatarUrl || '' },
             { label: 'Egyedi H√°tt√©r URL (fel√ºl√≠rja a glob√°list):', id: 'custom-background-url', value: pageData.customBackgroundUrl || '' },
             { label: 'K√©p URL a Gal√©ri√°hoz (T√∂bb URL soronk√©nt):', id: 'custom-gallery-url', value: pageData.customGalleryUrl || '', textarea: true },
             { label: 'Gal√©ria M√≥d:', id: 'gallery-mode', type: 'select', value: pageData.galleryMode || 'add_url', options: [
                 {val: 'add_url', text: 'Hozz√°ad (akkumul√°l)'},
                 {val: 'remove_url', text: 'Elt√°vol√≠t'},
                 {val: 'clear', text: 'Gal√©ria √ºr√≠t√©se'}
             ]},
        ];

        commonFields.forEach(field => {
            let inputHtml;
            if (field.textarea) {
                inputHtml = `<textarea rows="3" id="${field.id}" class="${field.id}">${field.value}</textarea>`;
            } else if (field.type === 'select') {
                const optionsHtml = field.options.map(opt => 
                    `<option value="${opt.val}" ${opt.val === field.value ? 'selected' : ''}>${opt.text}</option>`
                ).join('');
                inputHtml = `<select id="${field.id}" class="${field.id} input-group">${optionsHtml}</select>`;
            } else {
                 inputHtml = `<input type="text" id="${field.id}" class="${field.id}" value="${field.value}">`;
            }

            const group = document.createElement('div');
            group.className = 'input-group';
            group.innerHTML = `<label>${field.label}</label>${inputHtml}`;
            container.appendChild(group);
        });
        
        // --- T√≠pus-specifikus mez≈ëk ---
        
        // JELSZ√ì oldal
        if (type === 'password') {
            const passwordFields = [
                { label: 'Helyes Jelsz√≥:', id: 'correct-password', value: pageData.correctPassword || '' },
                { label: 'Sikeres √°tugr√°s Oldal Indexe (-1 GPS):', id: 'next-index-success', value: pageData.nextIndexSuccess !== undefined ? pageData.nextIndexSuccess : (pageData.nextIndex || '') },
                { label: 'S√∫g√≥ Sz√∂veg (S√∫g√≥ gombhoz, t√∂bb sor is lehet):', id: 'help-message', value: Array.isArray(pageData.helpMessage) ? pageData.helpMessage.join('\n') : pageData.helpMessage || '', textarea: true, note: 'T√∂bb sor eset√©n minden sort egy k√ºl√∂n gombbal l√©ptet a s√∫g√≥ban.' },
            ];
            passwordFields.forEach(field => {
                const group = document.createElement('div');
                group.className = 'input-group';
                group.innerHTML = `<label>${field.label}</label> ${field.textarea ? `<textarea rows="3" id="${field.id}" class="${field.id}">${field.value}</textarea>` : `<input type="text" id="${field.id}" class="${field.id}" value="${field.value}">`}`;
                if (field.note) {
                     group.innerHTML += `<p class="text-xs text-gray-400 mt-1">${field.note}</p>`;
                }
                container.appendChild(group);
            });
        }
        
        // V√ÅLASZT√ÅS oldal
        else if (type === 'choice') {
            const choicesContainer = document.createElement('div');
            choicesContainer.id = `choices-container-${pageData.id}`;
            choicesContainer.className = 'mt-4 border p-3 rounded';
            choicesContainer.innerHTML = '<h4 class="font-bold mb-2 text-primary">V√°laszt√°si Lehet≈ës√©gek:</h4>';
            
            (pageData.choices || []).forEach((choice, choiceIndex) => {
                choicesContainer.appendChild(createChoiceItem(choice, pageIndex));
            });
            
            const addChoiceBtn = document.createElement('button');
            addChoiceBtn.className = 'btn btn-secondary btn-sm mt-2';
            addChoiceBtn.innerHTML = '<i class="fa-solid fa-plus"></i> √öj V√°laszt√°s';
            addChoiceBtn.onclick = () => {
                choicesContainer.appendChild(createChoiceItem({ text: '', nextIndex: '' }, pageIndex));
            };
            
            container.appendChild(choicesContainer);
            container.appendChild(addChoiceBtn);
        }
        
        // AUDIO oldal
        else if (type === 'audio') {
             const audioFields = [
                { label: 'Audio F√°jl URL (1):', id: 'audio-url-1', value: pageData.audioUrl1 || config.MEDIA.AUDIO_1_URL || '' },
                { label: 'Audio F√°jl URL (2):', id: 'audio-url-2', value: pageData.audioUrl2 || config.MEDIA.AUDIO_2_URL || '' },
                { label: 'Haszn√°land√≥ Audio ID (1 vagy 2):', id: 'audio-id', value: pageData.audioId || 1 },
                { label: 'Tov√°bb Gomb Sz√∂veg:', id: 'next-button-text', value: pageData.nextButtonText || 'Tov√°bb' }
            ];
            audioFields.forEach(field => {
                const group = document.createElement('div');
                group.className = 'input-group';
                group.innerHTML = `<label>${field.label}</label><input type="text" id="${field.id}" class="${field.id}" value="${field.value}">`;
                container.appendChild(group);
            });
            // Mivel a f≈ë audi√≥ url-eket √©rdemesebb glob√°lisan be√°ll√≠tani, de az oldal szint≈± fel√ºl√≠r√°s is lehets√©ges
        }

        // GPS oldal
        else if (type === 'gps') {
             const gpsFields = [
                { label: 'GPS C√©lpont Sz√©less√©g (fel√ºl√≠rja a glob√°list):', id: 'gps-lat', value: pageData.targetLatitude || config.GPS_COMPASS.TARGET_LATITUDE || '' },
                { label: 'GPS C√©lpont Hossz√∫s√°g (fel√ºl√≠rja a glob√°list):', id: 'gps-lon', value: pageData.targetLongitude || config.GPS_COMPASS.TARGET_LONGITUDE || '' },
                { label: 'GPS Sug√°r (m√©ter):', id: 'gps-radius', value: pageData.successRadiusM || config.GPS_COMPASS.SUCCESS_RADIUS_M || '' },
                { label: 'Sikeres √°tir√°ny√≠t√°si URL (fel√ºl√≠rja a glob√°list):', id: 'gps-redirect-url', value: pageData.successRedirectUrl || config.GPS_COMPASS.SUCCESS_REDIRECT_URL || '' },
            ];
            gpsFields.forEach(field => {
                const group = document.createElement('div');
                group.className = 'input-group';
                group.innerHTML = `<label>${field.label}</label><input type="text" id="${field.id}" class="${field.id}" value="${field.value}">`;
                container.appendChild(group);
            });
        }
        
        // SZ√ñVEG oldal (√©s a t√∂bbi, ami csak tov√°bbl√©p)
        if (type === 'text' || type === 'audio' || type === 'gps') {
            const group = document.createElement('div');
            group.className = 'input-group';
            group.innerHTML = `
                <label>K√∂vetkez≈ë Oldal Indexe (√ºres: +1):</label>
                <input type="number" class="page-next-index" value="${pageData.nextIndex !== undefined ? pageData.nextIndex : ''}" placeholder="K√∂vetkez≈ë oldal sorsz√°ma">
            `;
            container.appendChild(group);
        }

        // Vissza Gomb Indexe
        const backGroup = document.createElement('div');
        backGroup.className = 'input-group';
        backGroup.innerHTML = `
            <label>Vissza Gomb Oldal Indexe (√ºres: -1):</label>
            <input type="number" class="page-back-index" value="${pageData.backIndex !== undefined ? pageData.backIndex : ''}" placeholder="Vissza gomb c√©l oldala">
        `;
        container.appendChild(backGroup);

    }
    
    function createChoiceItem(choiceData, pageIndex) {
        const div = document.createElement('div');
        div.className = 'choice-item flex space-x-2 items-center';
        div.innerHTML = `
            <input type="text" class="flex-grow choice-text" value="${choiceData.text}" placeholder="V√°laszt√°s sz√∂vege">
            <input type="number" class="w-24 choice-next-index" value="${choiceData.nextIndex !== undefined ? choiceData.nextIndex : ''}" placeholder="C√©l index">
            <button class="btn btn-danger btn-sm remove-choice"><i class="fa-solid fa-trash"></i></button>
        `;
        div.querySelector('.remove-choice').onclick = () => div.remove();
        return div;
    }
    
    function movePage(oldIndex, direction) {
        const newIndex = oldIndex + direction;
        if (newIndex >= 0 && newIndex < config.storyPages.length) {
            [config.storyPages[oldIndex], config.storyPages[newIndex]] = [config.storyPages[newIndex], config.storyPages[oldIndex]];
            renderStoryPages();
            updateSaveStatus("Oldal mozgatva. K√©rem, mentse el!", "text-orange-400");
        }
    }

    function collectStoryPages() {
        const newPages = [];
        const pageElements = document.querySelectorAll('#story-pages-container .story-page');
        
        pageElements.forEach(pageEl => {
            const id = pageEl.getAttribute('data-id');
            const type = pageEl.querySelector('.page-type-select').value;
            const content = pageEl.querySelector('.page-content').value;
            
            const newPage = {
                id: parseInt(id),
                type: type,
                content: content,
                
                // √Åltal√°nos extr√°k
                customAvatarUrl: pageEl.querySelector('.custom-avatar-url').value.trim() || undefined,
                customBackgroundUrl: pageEl.querySelector('.custom-background-url').value.trim() || undefined,
                customGalleryUrl: pageEl.querySelector('.custom-gallery-url').value.trim() || undefined,
                galleryMode: pageEl.querySelector('.gallery-mode').value,
                
                nextIndex: pageEl.querySelector('.page-next-index') ? (pageEl.querySelector('.page-next-index').value.trim() === '' ? undefined : parseInt(pageEl.querySelector('.page-next-index').value)) : undefined,
                backIndex: pageEl.querySelector('.page-back-index') ? (pageEl.querySelector('.page-back-index').value.trim() === '' ? undefined : parseInt(pageEl.querySelector('.page-back-index').value)) : undefined,
            };
            
            // T√≠pus-specifikus adatok
            if (type === 'password') {
                newPage.correctPassword = pageEl.querySelector('.correct-password').value.trim();
                const nextIndexSuccessEl = pageEl.querySelector('.next-index-success');
                const nextIndexSuccessVal = nextIndexSuccessEl.value.trim();
                newPage.nextIndexSuccess = nextIndexSuccessVal === '' ? undefined : parseInt(nextIndexSuccessVal);
                
                const helpMessageVal = pageEl.querySelector('.help-message').value.trim();
                if (helpMessageVal) {
                    newPage.helpMessage = helpMessageVal.split('\n').map(s => s.trim()).filter(s => s.length > 0);
                }
            } else if (type === 'choice') {
                newPage.choices = [];
                pageEl.querySelectorAll('.choice-item').forEach(choiceEl => {
                    const text = choiceEl.querySelector('.choice-text').value.trim();
                    const nextIndexVal = choiceEl.querySelector('.choice-next-index').value.trim();
                    if (text) {
                        newPage.choices.push({
                            text: text,
                            nextIndex: nextIndexVal === '' ? undefined : parseInt(nextIndexVal)
                        });
                    }
                });
                delete newPage.nextIndex; // Choice oldalakon a nextIndex nem √©rtelmezett
            } else if (type === 'audio') {
                 newPage.audioId = parseInt(pageEl.querySelector('.audio-id').value) || 1;
                 newPage.nextButtonText = pageEl.querySelector('.next-button-text').value.trim() || undefined;
                 // Itt gy≈±jthet≈ë be az audi√≥ URL fel√ºl√≠r√°s is, de a glob√°lis mez≈ëk m√°r fedezik ezt a lehet≈ës√©get
            } else if (type === 'gps') {
                 newPage.targetLatitude = parseFloat(pageEl.querySelector('.gps-lat').value) || undefined;
                 newPage.targetLongitude = parseFloat(pageEl.querySelector('.gps-lon').value) || undefined;
                 newPage.successRadiusM = parseInt(pageEl.querySelector('.gps-radius').value) || undefined;
                 newPage.successRedirectUrl = pageEl.querySelector('.gps-redirect-url').value.trim() || undefined;
            }
            
            newPages.push(newPage);
        });
        
        return newPages;
    }

    // --- ESEM√âNYKEZEL≈êK INIT ---

    document.addEventListener('DOMContentLoaded', () => {
        // Figyelmeztet√©s
        if (window.location.protocol === 'file:') {
            document.getElementById('protocol-warning').style.display = 'block';
        }
        
        loadConfig();
        
        // √ñsszecsuk√°s/Kinyit√°s
        document.querySelectorAll('.section-header').forEach(header => {
            header.onclick = () => header.parentNode.classList.toggle('collapsed');
        });

        // Ment√©s
        document.getElementById('save-config').onclick = saveConfig;
        
        // Export√°l√°s
        document.getElementById('export-game').onclick = () => {
            saveConfig(); // Ment√©s futtat√°sa export el≈ëtt
            window.open(GAME_TEMPLATE_URL, '_blank'); // Megnyitja a let√∂lt≈ë oldalt
        };
        
        // Preview
        document.getElementById('preview-game').onclick = () => {
            saveConfig(); // Ment√©s futtat√°sa preview el≈ëtt
            window.open('game.html', '_blank'); // Megnyitja a j√°t√©k oldalt
        };
        
        // √öj oldal √©s Avat√°r
        document.getElementById('add-page').onclick = () => {
            config.storyPages.push({ id: Date.now(), type: 'text', content: '¬ßN √öj oldal...', nextIndex: undefined });
            renderStoryPages();
        };
        document.getElementById('add-avatar-map').onclick = () => {
            const container = document.getElementById('avatar-map-container');
            container.appendChild(createAvatarMapItem());
        };
    });

</script>
</body>
</html>
